name: iOS Tests - Full Parallel Suite

# ============================================================
# FULL PARALLEL TEST SUITE - v3.2 (CI OPTIMIZED - Feb 2026)
# ============================================================
# Based on WORKING ios-tests.yml configuration:
#   - appium@next (NOT 2.5.0)
#   - Pre-build WebDriverAgent
#   - Warm-up WDA Session
#   - Boot loop with (Booted) check
#   - 45s post-boot stabilization
#
# OPTIMIZATIONS APPLIED (v3.2):
#   - Reduced scroll retries: 5 -> 2
#   - Reduced sleep durations: 30-40% faster
#   - Reduced retry loops: 5 -> 3
#   - mediumWait -> shortWait: 532 conversions
#   - Scroll duration: 0.5s -> 0.3s
#
# Expected Time Distribution (AFTER optimization):
#   Job 1: Auth (38 tests) - ~30 min (was 45 min)
#   Job 2: Site (52 tests) - ~1 hr (was 1.5 hr)
#   Job 3: Phase1 (139 tests) - ~2 hr (was 3 hr)
#   Job 4: Phase2 (159 tests) - ~2.5 hr (was 3.5 hr)
#   Job 5: Phase3 (169 tests) - ~2.5 hr (was 4 hr)
#   Job 6: Phase4 (141 tests) - ~2 hr (was 3 hr)
#   Job 7: Phase5 (45 tests) - ~40 min (was 1 hr)
#   Job 8: Location (84 tests) - ~1.5 hr (was 2 hr)
#   Job 9: Connections (94 tests) - ~2 hr
#   Total: ~921 tests, ~2.5 hr wall clock (parallel)
# ============================================================

on:
  push:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      job_selection:
        description: 'Which jobs to run'
        required: false
        default: 'all'
        type: choice
        options:
          - 'all'
          - 'smoke-only'
          - 'auth-only'
          - 'site-only'
          - 'phase1-only'
          - 'phase2-only'
          - 'phase3-only'
          - 'phase4-only'
          - 'phase5-only'
          - 'location-only'
          - 'connections-only'

jobs:
  # ========================================
  # SMOKE TEST JOB (17 tests, ~15-20 min)
  # Quick validation of critical paths
  # ========================================
  smoke-tests:
    if: github.event.inputs.job_selection == 'smoke-only'
    runs-on: macos-15
    timeout-minutes: 420
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Appium
        run: |
          npm install -g appium@next
          appium driver install xcuitest
          echo "âœ… Appium $(appium --version) installed"

      - name: Unzip App
        run: |
          unzip -o apps/Z-Platform-QA.zip -d apps/
          ls -la apps/

      - name: Boot Simulator and Wait Until Ready
        run: |
          echo "=== Available Simulators ==="
          xcrun simctl list devices available
          
          UDID=$(xcrun simctl list devices available | grep -A 100 "iOS 18" | grep "iPhone 16 Pro" | head -1 | awk -F '[()]' '{print $2}')
          [ -z "$UDID" ] && UDID=$(xcrun simctl list devices available | grep -E "iPhone 16 Pro" | head -1 | awk -F '[()]' '{print $2}')
          [ -z "$UDID" ] && UDID=$(xcrun simctl list devices available | grep -E "iPhone 1[5-6]" | head -1 | awk -F '[()]' '{print $2}')
          
          if [ -z "$UDID" ]; then
            echo "âŒ No iPhone simulator found!"
            exit 1
          fi
          
          DEVICE_NAME=$(xcrun simctl list devices available | grep "$UDID" | sed 's/(.*//' | xargs)
          PLATFORM_VERSION=$(xcrun simctl list devices available | grep -B 20 "$UDID" | grep "iOS" | tail -1 | sed 's/-- iOS //' | sed 's/ --.*//')
          
          echo "ðŸ“± Selected Device: $DEVICE_NAME"
          echo "ðŸ“± UDID: $UDID"
          echo "ðŸ“± iOS Version: $PLATFORM_VERSION"
          
          echo "DEVICE_NAME=$DEVICE_NAME" >> $GITHUB_ENV
          echo "SIMULATOR_UDID=$UDID" >> $GITHUB_ENV
          echo "PLATFORM_VERSION=$PLATFORM_VERSION" >> $GITHUB_ENV
          
          echo "=== Booting Simulator ==="
          xcrun simctl boot "$UDID" 2>/dev/null || true
          
          echo "=== Waiting for Simulator to be fully booted ==="
          for i in {1..60}; do
            STATE=$(xcrun simctl list devices | grep "$UDID" | grep -o "(Booted)" || true)
            if [ "$STATE" = "(Booted)" ]; then
              echo "âœ… Simulator booted after $i seconds"
              break
            fi
            echo "   Waiting... ($i/60)"
            sleep 1
          done
          
          echo "=== Post-boot stabilization (45s) ==="
          sleep 45
          echo "âœ… Simulator ready"

      - name: Pre-build WebDriverAgent
        run: |
          echo "Pre-building WebDriverAgent to avoid timeout on first test..."
          WDA_PATH=$(find ~/.appium -name "WebDriverAgent.xcodeproj" -type f 2>/dev/null | head -1 | xargs dirname)
          if [ -n "$WDA_PATH" ]; then
            cd "$WDA_PATH"
            xcodebuild build-for-testing               -project WebDriverAgent.xcodeproj               -scheme WebDriverAgentRunner               -destination "platform=iOS Simulator,id=${{ env.SIMULATOR_UDID }}"               -quiet || echo "WDA pre-build completed (may have warnings)"
          fi

      - name: Start Appium Server
        run: |
          echo "Starting Appium server..."
          appium --address 127.0.0.1 --port 4723 --base-path /             --relaxed-security --log-level info             --session-override --log appium.log &
          sleep 10
          echo "âœ… Appium server started"

      - name: Warm-up WDA Session
        continue-on-error: true
        run: |
          echo "Creating warm-up session..."
          curl -s -X POST http://127.0.0.1:4723/session             -H "Content-Type: application/json"             -d '{
              "capabilities": {
                "alwaysMatch": {
                  "platformName": "iOS",
                  "appium:automationName": "XCUITest",
                  "appium:deviceName": "${{ env.DEVICE_NAME }}",
                  "appium:udid": "${{ env.SIMULATOR_UDID }}",
                  "appium:platformVersion": "${{ env.PLATFORM_VERSION }}",
                  "appium:app": "${{ github.workspace }}/apps/Z Platform-QA.app",
                  "appium:newCommandTimeout": 300,
                  "appium:wdaStartupRetries": 4,
                  "appium:wdaStartupRetryInterval": 20000
                }
              }
            }' > session.json
          
          SESSION_ID=$(cat session.json | grep -o '"sessionId":"[^"]*"' | cut -d'"' -f4)
          if [ -n "$SESSION_ID" ]; then
            echo "âœ… Warm-up session created: $SESSION_ID"
            sleep 5
            curl -s -X DELETE "http://127.0.0.1:4723/session/$SESSION_ID" || true
            echo "âœ… Warm-up session closed"
          fi
          sleep 5

      - name: Run Smoke Tests
        continue-on-error: true
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘             SMOKE TEST SUITE (17 tests)                    â•‘"
          echo "â•‘    Quick validation of critical paths (~15-20 min)         â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          mvn test -DsuiteXmlFile=src/test/resources/parallel/testng-smoke.xml \
            -DDEVICE_NAME="${{ env.DEVICE_NAME }}" \
            -DPLATFORM_VERSION="${{ env.PLATFORM_VERSION }}" \
            -DSIMULATOR_UDID="${{ env.SIMULATOR_UDID }}" \
            -DAPP_PATH="${{ github.workspace }}/apps/Z Platform-QA.app"

      - name: Upload Smoke Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-report
          path: |
            target/surefire-reports/
            reports/
            screenshots/
          retention-days: 7
          
      - name: Smoke Test Summary
        if: always()
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘             SMOKE TEST SUITE COMPLETE                      â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ðŸ“Š Smoke Tests cover:"
          echo "   - Authentication: Welcome screen, company code, login UI"
          echo "   - Site Selection: UI elements, site list, search, dashboard"
          echo "   - Asset Management: New asset screen, UI fields, asset class"
          echo "   - Location: Building screen UI, save button, name input"
          echo "   - Connections: Tab navigation, header, list display"
          echo ""
          echo "ðŸ”— Full Details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

  # ========================================
  # JOB 1: Auth Tests (38 tests, ~45 min)
  # ========================================
  auth-tests:
    if: github.event_name == 'push' || github.event.inputs.job_selection == 'all' || github.event.inputs.job_selection == 'auth-only'
    runs-on: macos-15
    timeout-minutes: 420
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Appium
        run: |
          npm install -g appium@next
          appium driver install xcuitest
          echo "âœ… Appium $(appium --version) installed"

      - name: Unzip App
        run: |
          unzip -o apps/Z-Platform-QA.zip -d apps/
          ls -la apps/

      - name: Boot Simulator and Wait Until Ready
        run: |
          echo "=== Available Simulators ==="
          xcrun simctl list devices available
          
          UDID=$(xcrun simctl list devices available | grep -A 100 "iOS 18" | grep "iPhone 16 Pro" | head -1 | awk -F '[()]' '{print $2}')
          [ -z "$UDID" ] && UDID=$(xcrun simctl list devices available | grep -E "iPhone 16 Pro" | head -1 | awk -F '[()]' '{print $2}')
          [ -z "$UDID" ] && UDID=$(xcrun simctl list devices available | grep -E "iPhone 1[5-6]" | head -1 | awk -F '[()]' '{print $2}')
          
          if [ -z "$UDID" ]; then
            echo "âŒ No iPhone simulator found!"
            exit 1
          fi
          echo "Selected UDID: $UDID"
          
          xcrun simctl shutdown "$UDID" 2>/dev/null || true
          sleep 3
          xcrun simctl boot "$UDID" 2>/dev/null || true
          
          BOOT_TIMEOUT=240
          ELAPSED=0
          while [ $ELAPSED -lt $BOOT_TIMEOUT ]; do
            if xcrun simctl list devices | grep "$UDID" | grep -q "(Booted)"; then
              echo "âœ… Simulator is in Booted state after ${ELAPSED}s"
              echo "Waiting 45s for system services to stabilize..."
              sleep 45
              echo "âœ… Simulator ready!"
              break
            fi
            echo "Waiting for boot... (${ELAPSED}s/${BOOT_TIMEOUT}s)"
            sleep 5
            ELAPSED=$((ELAPSED + 5))
          done
          
          if [ $ELAPSED -ge $BOOT_TIMEOUT ]; then
            echo "âŒ Simulator failed to boot within ${BOOT_TIMEOUT}s"
            exit 1
          fi
          
          DEVICE=$(xcrun simctl list devices available | grep "$UDID" | awk -F '(' '{print $1}' | xargs)
          VERSION=$(xcrun simctl list devices available | grep -B 50 "$UDID" | grep "-- iOS" | tail -1 | sed 's/.*iOS \([0-9.]*\).*/\1/')
          [ -z "$VERSION" ] && VERSION="18.5"
          
          echo "SIMULATOR_UDID=$UDID" >> $GITHUB_ENV
          echo "DEVICE_NAME=$DEVICE" >> $GITHUB_ENV
          echo "PLATFORM_VERSION=$VERSION" >> $GITHUB_ENV
          
          echo "ðŸ“± Device: $DEVICE"
          echo "ðŸ“± UDID: $UDID"
          echo "ðŸ“± iOS: $VERSION"

      - name: Pre-install App on Simulator
        run: |
          echo "Installing app on simulator..."
          xcrun simctl install "${{ env.SIMULATOR_UDID }}" "apps/Z Platform-QA.app"
          echo "âœ… App pre-installed"

      - name: Pre-build WebDriverAgent
        run: |
          echo "Pre-building WebDriverAgent to avoid timeout on first test..."
          WDA_PATH=$(find ~/.appium -name "WebDriverAgent.xcodeproj" -type f 2>/dev/null | head -1 | xargs dirname)
          
          if [ -n "$WDA_PATH" ]; then
            echo "Found WDA at: $WDA_PATH"
            cd "$WDA_PATH"
            
            xcodebuild build-for-testing \
              -project WebDriverAgent.xcodeproj \
              -scheme WebDriverAgentRunner \
              -destination "platform=iOS Simulator,id=${{ env.SIMULATOR_UDID }}" \
              -derivedDataPath /tmp/wda-build \
              -quiet || echo "WDA pre-build completed (may have warnings)"
            
            echo "âœ… WDA pre-built"
          else
            echo "âš ï¸ WDA not found, will be built on first test run"
          fi

      - name: Start Appium Server
        run: |
          echo "Starting Appium..."
          appium --relaxed-security --log-level info > appium.log 2>&1 &
          APPIUM_PID=$!
          echo "Appium PID: $APPIUM_PID"
          
          APPIUM_READY=false
          for i in {1..60}; do
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:4723/status 2>/dev/null || echo "000")
            if [ "$HTTP_STATUS" = "200" ]; then
              echo "âœ… Appium server is ready! (HTTP $HTTP_STATUS)"
              APPIUM_READY=true
              break
            fi
            echo "Waiting for Appium... ($i/60) - HTTP: $HTTP_STATUS"
            sleep 2
          done
          
          if [ "$APPIUM_READY" = false ]; then
            echo "âŒ Appium failed to start"
            cat appium.log | tail -30
            exit 1
          fi
          
          echo "Waiting 10s for Appium to fully initialize..."
          sleep 10
          echo "âœ… Appium server verified and ready"

      - name: Warm-up WDA Session
        env:
          SIMULATOR_UDID: ${{ env.SIMULATOR_UDID }}
          APP_PATH: ${{ github.workspace }}/apps/Z Platform-QA.app
        run: |
          echo "=== Warming up WDA with a test session ==="
          
          for attempt in 1 2 3; do
            echo "Warm-up attempt $attempt/3..."
            
            SESSION_RESPONSE=$(curl -s -X POST http://127.0.0.1:4723/session \
              -H "Content-Type: application/json" \
              -d '{
                "capabilities": {
                  "alwaysMatch": {
                    "platformName": "iOS",
                    "appium:automationName": "XCUITest",
                    "appium:deviceName": "'"${{ env.DEVICE_NAME }}"'",
                    "appium:udid": "'"$SIMULATOR_UDID"'",
                    "appium:platformVersion": "'"${{ env.PLATFORM_VERSION }}"'",
                    "appium:app": "'"$APP_PATH"'",
                    "appium:wdaLaunchTimeout": 600000,
                    "appium:wdaConnectionTimeout": 300000,
                    "appium:useNewWDA": false,
                    "appium:noReset": false
                  }
                }
              }' --max-time 600 2>&1) || true
            
            SESSION_ID=$(echo "$SESSION_RESPONSE" | grep -o '"sessionId":"[^"]*"' | cut -d'"' -f4 || true)
            
            if [ -n "$SESSION_ID" ]; then
              echo "âœ… WDA warm-up session created: $SESSION_ID"
              sleep 10
              curl -s -X DELETE "http://127.0.0.1:4723/session/$SESSION_ID" || true
              echo "âœ… Warm-up session closed"
              sleep 5
              echo "âœ… WDA warm-up complete"
              break
            else
              echo "âš ï¸ Attempt $attempt failed"
              [ $attempt -lt 3 ] && sleep 30
            fi
          done

      - name: Run Auth Tests
        continue-on-error: true
        env:
          SIMULATOR_UDID: ${{ env.SIMULATOR_UDID }}
          PLATFORM_VERSION: ${{ env.PLATFORM_VERSION }}
          DEVICE_NAME: ${{ env.DEVICE_NAME }}
          APP_PATH: ${{ github.workspace }}/apps/Z Platform-QA.app
        run: |
          mvn test -DsuiteXmlFile=src/test/resources/parallel/testng-auth.xml \
            -DDEVICE_NAME="$DEVICE_NAME" \
            -DPLATFORM_VERSION="$PLATFORM_VERSION" \
            -DSIMULATOR_UDID="$SIMULATOR_UDID" \
            -DAPP_PATH="$APP_PATH"

      - name: Upload Auth Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: auth-report
          path: |
            target/surefire-reports/
            reports/
            screenshots/
          retention-days: 7

  # ========================================
  # JOB 2: Site Tests (52 tests, ~1.5 hr)
  # ========================================
  site-tests:
    if: github.event_name == 'push' || github.event.inputs.job_selection == 'all' || github.event.inputs.job_selection == 'site-only'
    runs-on: macos-15
    timeout-minutes: 420
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Install Appium
        run: |
          npm install -g appium@next
          appium driver install xcuitest
      - name: Unzip App
        run: unzip -o apps/Z-Platform-QA.zip -d apps/
      - name: Boot Simulator and Wait Until Ready
        run: |
          UDID=$(xcrun simctl list devices available | grep -A 100 "iOS 18" | grep "iPhone 16 Pro" | head -1 | awk -F '[()]' '{print $2}')
          [ -z "$UDID" ] && UDID=$(xcrun simctl list devices available | grep -E "iPhone 16 Pro" | head -1 | awk -F '[()]' '{print $2}')
          [ -z "$UDID" ] && UDID=$(xcrun simctl list devices available | grep -E "iPhone 1[5-6]" | head -1 | awk -F '[()]' '{print $2}')
          [ -z "$UDID" ] && exit 1
          xcrun simctl shutdown "$UDID" 2>/dev/null || true
          sleep 3
          xcrun simctl boot "$UDID" 2>/dev/null || true
          ELAPSED=0
          while [ $ELAPSED -lt 240 ]; do
            if xcrun simctl list devices | grep "$UDID" | grep -q "(Booted)"; then
              echo "âœ… Simulator booted after ${ELAPSED}s"
              sleep 45
              break
            fi
            sleep 5
            ELAPSED=$((ELAPSED + 5))
          done
          [ $ELAPSED -ge 240 ] && exit 1
          DEVICE=$(xcrun simctl list devices available | grep "$UDID" | awk -F '(' '{print $1}' | xargs)
          VERSION=$(xcrun simctl list devices available | grep -B 50 "$UDID" | grep "-- iOS" | tail -1 | sed 's/.*iOS \([0-9.]*\).*/\1/')
          [ -z "$VERSION" ] && VERSION="18.5"
          echo "SIMULATOR_UDID=$UDID" >> $GITHUB_ENV
          echo "DEVICE_NAME=$DEVICE" >> $GITHUB_ENV
          echo "PLATFORM_VERSION=$VERSION" >> $GITHUB_ENV
      - name: Pre-install App
        run: xcrun simctl install "${{ env.SIMULATOR_UDID }}" "apps/Z Platform-QA.app"
      - name: Pre-build WebDriverAgent
        run: |
          WDA_PATH=$(find ~/.appium -name "WebDriverAgent.xcodeproj" -type f 2>/dev/null | head -1 | xargs dirname)
          if [ -n "$WDA_PATH" ]; then
            cd "$WDA_PATH"
            xcodebuild build-for-testing -project WebDriverAgent.xcodeproj -scheme WebDriverAgentRunner -destination "platform=iOS Simulator,id=${{ env.SIMULATOR_UDID }}" -derivedDataPath /tmp/wda-build -quiet || true
          fi
      - name: Start Appium Server
        run: |
          appium --relaxed-security --log-level info > appium.log 2>&1 &
          for i in {1..60}; do
            [ "$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:4723/status 2>/dev/null)" = "200" ] && break
            sleep 2
          done
          sleep 10
      - name: Warm-up WDA Session
        env:
          SIMULATOR_UDID: ${{ env.SIMULATOR_UDID }}
          APP_PATH: ${{ github.workspace }}/apps/Z Platform-QA.app
        run: |
          for attempt in 1 2 3; do
            SESSION_RESPONSE=$(curl -s -X POST http://127.0.0.1:4723/session -H "Content-Type: application/json" -d '{"capabilities":{"alwaysMatch":{"platformName":"iOS","appium:automationName":"XCUITest","appium:deviceName":"'"${{ env.DEVICE_NAME }}"'","appium:udid":"'"$SIMULATOR_UDID"'","appium:platformVersion":"'"${{ env.PLATFORM_VERSION }}"'","appium:app":"'"$APP_PATH"'","appium:wdaLaunchTimeout":600000,"appium:wdaConnectionTimeout":300000,"appium:useNewWDA":false,"appium:noReset":false}}}' --max-time 600 2>&1) || true
            SESSION_ID=$(echo "$SESSION_RESPONSE" | grep -o '"sessionId":"[^"]*"' | cut -d'"' -f4 || true)
            if [ -n "$SESSION_ID" ]; then
              sleep 10
              curl -s -X DELETE "http://127.0.0.1:4723/session/$SESSION_ID" || true
              sleep 5
              break
            fi
            [ $attempt -lt 3 ] && sleep 30
          done
      - name: Run Site Tests
        continue-on-error: true
        run: |
          mvn test -DsuiteXmlFile=src/test/resources/parallel/testng-site.xml \
            -DDEVICE_NAME="${{ env.DEVICE_NAME }}" \
            -DPLATFORM_VERSION="${{ env.PLATFORM_VERSION }}" \
            -DSIMULATOR_UDID="${{ env.SIMULATOR_UDID }}" \
            -DAPP_PATH="${{ github.workspace }}/apps/Z Platform-QA.app"
      - name: Upload Site Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: site-report
          path: |
            target/surefire-reports/
            reports/
            screenshots/
          retention-days: 7

  # ========================================
  # JOB 3: Phase 1 Tests (139 tests, ~3 hr)
  # ========================================
  phase1-tests:
    if: github.event_name == 'push' || github.event.inputs.job_selection == 'all' || github.event.inputs.job_selection == 'phase1-only'
    runs-on: macos-15
    timeout-minutes: 420
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Install Appium
        run: |
          npm install -g appium@next
          appium driver install xcuitest
      - name: Unzip App
        run: unzip -o apps/Z-Platform-QA.zip -d apps/
      - name: Boot Simulator and Wait Until Ready
        run: |
          UDID=$(xcrun simctl list devices available | grep -A 100 "iOS 18" | grep "iPhone 16 Pro" | head -1 | awk -F '[()]' '{print $2}')
          [ -z "$UDID" ] && UDID=$(xcrun simctl list devices available | grep -E "iPhone 16 Pro" | head -1 | awk -F '[()]' '{print $2}')
          [ -z "$UDID" ] && UDID=$(xcrun simctl list devices available | grep -E "iPhone 1[5-6]" | head -1 | awk -F '[()]' '{print $2}')
          [ -z "$UDID" ] && exit 1
          xcrun simctl shutdown "$UDID" 2>/dev/null || true
          sleep 3
          xcrun simctl boot "$UDID" 2>/dev/null || true
          ELAPSED=0
          while [ $ELAPSED -lt 240 ]; do
            if xcrun simctl list devices | grep "$UDID" | grep -q "(Booted)"; then
              echo "âœ… Simulator booted after ${ELAPSED}s"
              sleep 45
              break
            fi
            sleep 5
            ELAPSED=$((ELAPSED + 5))
          done
          [ $ELAPSED -ge 240 ] && exit 1
          DEVICE=$(xcrun simctl list devices available | grep "$UDID" | awk -F '(' '{print $1}' | xargs)
          VERSION=$(xcrun simctl list devices available | grep -B 50 "$UDID" | grep "-- iOS" | tail -1 | sed 's/.*iOS \([0-9.]*\).*/\1/')
          [ -z "$VERSION" ] && VERSION="18.5"
          echo "SIMULATOR_UDID=$UDID" >> $GITHUB_ENV
          echo "DEVICE_NAME=$DEVICE" >> $GITHUB_ENV
          echo "PLATFORM_VERSION=$VERSION" >> $GITHUB_ENV
      - name: Pre-install App
        run: xcrun simctl install "${{ env.SIMULATOR_UDID }}" "apps/Z Platform-QA.app"
      - name: Pre-build WebDriverAgent
        run: |
          WDA_PATH=$(find ~/.appium -name "WebDriverAgent.xcodeproj" -type f 2>/dev/null | head -1 | xargs dirname)
          if [ -n "$WDA_PATH" ]; then
            cd "$WDA_PATH"
            xcodebuild build-for-testing -project WebDriverAgent.xcodeproj -scheme WebDriverAgentRunner -destination "platform=iOS Simulator,id=${{ env.SIMULATOR_UDID }}" -derivedDataPath /tmp/wda-build -quiet || true
          fi
      - name: Start Appium Server
        run: |
          appium --relaxed-security --log-level info > appium.log 2>&1 &
          for i in {1..60}; do
            [ "$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:4723/status 2>/dev/null)" = "200" ] && break
            sleep 2
          done
          sleep 10
      - name: Warm-up WDA Session
        env:
          SIMULATOR_UDID: ${{ env.SIMULATOR_UDID }}
          APP_PATH: ${{ github.workspace }}/apps/Z Platform-QA.app
        run: |
          for attempt in 1 2 3; do
            SESSION_RESPONSE=$(curl -s -X POST http://127.0.0.1:4723/session -H "Content-Type: application/json" -d '{"capabilities":{"alwaysMatch":{"platformName":"iOS","appium:automationName":"XCUITest","appium:deviceName":"'"${{ env.DEVICE_NAME }}"'","appium:udid":"'"$SIMULATOR_UDID"'","appium:platformVersion":"'"${{ env.PLATFORM_VERSION }}"'","appium:app":"'"$APP_PATH"'","appium:wdaLaunchTimeout":600000,"appium:wdaConnectionTimeout":300000,"appium:useNewWDA":false,"appium:noReset":false}}}' --max-time 600 2>&1) || true
            SESSION_ID=$(echo "$SESSION_RESPONSE" | grep -o '"sessionId":"[^"]*"' | cut -d'"' -f4 || true)
            if [ -n "$SESSION_ID" ]; then
              sleep 10
              curl -s -X DELETE "http://127.0.0.1:4723/session/$SESSION_ID" || true
              sleep 5
              break
            fi
            [ $attempt -lt 3 ] && sleep 30
          done
      - name: Run Phase 1 Tests
        continue-on-error: true
        run: |
          mvn test -DsuiteXmlFile=src/test/resources/parallel/testng-phase1.xml \
            -DDEVICE_NAME="${{ env.DEVICE_NAME }}" \
            -DPLATFORM_VERSION="${{ env.PLATFORM_VERSION }}" \
            -DSIMULATOR_UDID="${{ env.SIMULATOR_UDID }}" \
            -DAPP_PATH="${{ github.workspace }}/apps/Z Platform-QA.app"
      - name: Upload Phase 1 Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: phase1-report
          path: |
            target/surefire-reports/
            reports/
            screenshots/
          retention-days: 7

  # ========================================
  # JOB 4: Phase 2 Tests (159 tests, ~3.5 hr)
  # ========================================
  phase2-tests:
    if: github.event_name == 'push' || github.event.inputs.job_selection == 'all' || github.event.inputs.job_selection == 'phase2-only'
    runs-on: macos-15
    timeout-minutes: 420
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Install Appium
        run: |
          npm install -g appium@next
          appium driver install xcuitest
      - name: Unzip App
        run: unzip -o apps/Z-Platform-QA.zip -d apps/
      - name: Boot Simulator and Wait Until Ready
        run: |
          UDID=$(xcrun simctl list devices available | grep -A 100 "iOS 18" | grep "iPhone 16 Pro" | head -1 | awk -F '[()]' '{print $2}')
          [ -z "$UDID" ] && UDID=$(xcrun simctl list devices available | grep -E "iPhone 16 Pro" | head -1 | awk -F '[()]' '{print $2}')
          [ -z "$UDID" ] && UDID=$(xcrun simctl list devices available | grep -E "iPhone 1[5-6]" | head -1 | awk -F '[()]' '{print $2}')
          [ -z "$UDID" ] && exit 1
          xcrun simctl shutdown "$UDID" 2>/dev/null || true
          sleep 3
          xcrun simctl boot "$UDID" 2>/dev/null || true
          ELAPSED=0
          while [ $ELAPSED -lt 240 ]; do
            if xcrun simctl list devices | grep "$UDID" | grep -q "(Booted)"; then
              echo "âœ… Simulator booted after ${ELAPSED}s"
              sleep 45
              break
            fi
            sleep 5
            ELAPSED=$((ELAPSED + 5))
          done
          [ $ELAPSED -ge 240 ] && exit 1
          DEVICE=$(xcrun simctl list devices available | grep "$UDID" | awk -F '(' '{print $1}' | xargs)
          VERSION=$(xcrun simctl list devices available | grep -B 50 "$UDID" | grep "-- iOS" | tail -1 | sed 's/.*iOS \([0-9.]*\).*/\1/')
          [ -z "$VERSION" ] && VERSION="18.5"
          echo "SIMULATOR_UDID=$UDID" >> $GITHUB_ENV
          echo "DEVICE_NAME=$DEVICE" >> $GITHUB_ENV
          echo "PLATFORM_VERSION=$VERSION" >> $GITHUB_ENV
      - name: Pre-install App
        run: xcrun simctl install "${{ env.SIMULATOR_UDID }}" "apps/Z Platform-QA.app"
      - name: Pre-build WebDriverAgent
        run: |
          WDA_PATH=$(find ~/.appium -name "WebDriverAgent.xcodeproj" -type f 2>/dev/null | head -1 | xargs dirname)
          if [ -n "$WDA_PATH" ]; then
            cd "$WDA_PATH"
            xcodebuild build-for-testing -project WebDriverAgent.xcodeproj -scheme WebDriverAgentRunner -destination "platform=iOS Simulator,id=${{ env.SIMULATOR_UDID }}" -derivedDataPath /tmp/wda-build -quiet || true
          fi
      - name: Start Appium Server
        run: |
          appium --relaxed-security --log-level info > appium.log 2>&1 &
          for i in {1..60}; do
            [ "$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:4723/status 2>/dev/null)" = "200" ] && break
            sleep 2
          done
          sleep 10
      - name: Warm-up WDA Session
        env:
          SIMULATOR_UDID: ${{ env.SIMULATOR_UDID }}
          APP_PATH: ${{ github.workspace }}/apps/Z Platform-QA.app
        run: |
          for attempt in 1 2 3; do
            SESSION_RESPONSE=$(curl -s -X POST http://127.0.0.1:4723/session -H "Content-Type: application/json" -d '{"capabilities":{"alwaysMatch":{"platformName":"iOS","appium:automationName":"XCUITest","appium:deviceName":"'"${{ env.DEVICE_NAME }}"'","appium:udid":"'"$SIMULATOR_UDID"'","appium:platformVersion":"'"${{ env.PLATFORM_VERSION }}"'","appium:app":"'"$APP_PATH"'","appium:wdaLaunchTimeout":600000,"appium:wdaConnectionTimeout":300000,"appium:useNewWDA":false,"appium:noReset":false}}}' --max-time 600 2>&1) || true
            SESSION_ID=$(echo "$SESSION_RESPONSE" | grep -o '"sessionId":"[^"]*"' | cut -d'"' -f4 || true)
            if [ -n "$SESSION_ID" ]; then
              sleep 10
              curl -s -X DELETE "http://127.0.0.1:4723/session/$SESSION_ID" || true
              sleep 5
              break
            fi
            [ $attempt -lt 3 ] && sleep 30
          done
      - name: Run Phase 2 Tests
        continue-on-error: true
        run: |
          mvn test -DsuiteXmlFile=src/test/resources/parallel/testng-phase2.xml \
            -DDEVICE_NAME="${{ env.DEVICE_NAME }}" \
            -DPLATFORM_VERSION="${{ env.PLATFORM_VERSION }}" \
            -DSIMULATOR_UDID="${{ env.SIMULATOR_UDID }}" \
            -DAPP_PATH="${{ github.workspace }}/apps/Z Platform-QA.app"
      - name: Upload Phase 2 Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: phase2-report
          path: |
            target/surefire-reports/
            reports/
            screenshots/
          retention-days: 7

  # ========================================
  # JOB 5: Phase 3 Tests (169 tests, ~4 hr)
  # ========================================
  phase3-tests:
    if: github.event_name == 'push' || github.event.inputs.job_selection == 'all' || github.event.inputs.job_selection == 'phase3-only'
    runs-on: macos-15
    timeout-minutes: 420
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Install Appium
        run: |
          npm install -g appium@next
          appium driver install xcuitest
      - name: Unzip App
        run: unzip -o apps/Z-Platform-QA.zip -d apps/
      - name: Boot Simulator and Wait Until Ready
        run: |
          UDID=$(xcrun simctl list devices available | grep -A 100 "iOS 18" | grep "iPhone 16 Pro" | head -1 | awk -F '[()]' '{print $2}')
          [ -z "$UDID" ] && UDID=$(xcrun simctl list devices available | grep -E "iPhone 16 Pro" | head -1 | awk -F '[()]' '{print $2}')
          [ -z "$UDID" ] && UDID=$(xcrun simctl list devices available | grep -E "iPhone 1[5-6]" | head -1 | awk -F '[()]' '{print $2}')
          [ -z "$UDID" ] && exit 1
          xcrun simctl shutdown "$UDID" 2>/dev/null || true
          sleep 3
          xcrun simctl boot "$UDID" 2>/dev/null || true
          ELAPSED=0
          while [ $ELAPSED -lt 240 ]; do
            if xcrun simctl list devices | grep "$UDID" | grep -q "(Booted)"; then
              echo "âœ… Simulator booted after ${ELAPSED}s"
              sleep 45
              break
            fi
            sleep 5
            ELAPSED=$((ELAPSED + 5))
          done
          [ $ELAPSED -ge 240 ] && exit 1
          DEVICE=$(xcrun simctl list devices available | grep "$UDID" | awk -F '(' '{print $1}' | xargs)
          VERSION=$(xcrun simctl list devices available | grep -B 50 "$UDID" | grep "-- iOS" | tail -1 | sed 's/.*iOS \([0-9.]*\).*/\1/')
          [ -z "$VERSION" ] && VERSION="18.5"
          echo "SIMULATOR_UDID=$UDID" >> $GITHUB_ENV
          echo "DEVICE_NAME=$DEVICE" >> $GITHUB_ENV
          echo "PLATFORM_VERSION=$VERSION" >> $GITHUB_ENV
      - name: Pre-install App
        run: xcrun simctl install "${{ env.SIMULATOR_UDID }}" "apps/Z Platform-QA.app"
      - name: Pre-build WebDriverAgent
        run: |
          WDA_PATH=$(find ~/.appium -name "WebDriverAgent.xcodeproj" -type f 2>/dev/null | head -1 | xargs dirname)
          if [ -n "$WDA_PATH" ]; then
            cd "$WDA_PATH"
            xcodebuild build-for-testing -project WebDriverAgent.xcodeproj -scheme WebDriverAgentRunner -destination "platform=iOS Simulator,id=${{ env.SIMULATOR_UDID }}" -derivedDataPath /tmp/wda-build -quiet || true
          fi
      - name: Start Appium Server
        run: |
          appium --relaxed-security --log-level info > appium.log 2>&1 &
          for i in {1..60}; do
            [ "$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:4723/status 2>/dev/null)" = "200" ] && break
            sleep 2
          done
          sleep 10
      - name: Warm-up WDA Session
        env:
          SIMULATOR_UDID: ${{ env.SIMULATOR_UDID }}
          APP_PATH: ${{ github.workspace }}/apps/Z Platform-QA.app
        run: |
          for attempt in 1 2 3; do
            SESSION_RESPONSE=$(curl -s -X POST http://127.0.0.1:4723/session -H "Content-Type: application/json" -d '{"capabilities":{"alwaysMatch":{"platformName":"iOS","appium:automationName":"XCUITest","appium:deviceName":"'"${{ env.DEVICE_NAME }}"'","appium:udid":"'"$SIMULATOR_UDID"'","appium:platformVersion":"'"${{ env.PLATFORM_VERSION }}"'","appium:app":"'"$APP_PATH"'","appium:wdaLaunchTimeout":600000,"appium:wdaConnectionTimeout":300000,"appium:useNewWDA":false,"appium:noReset":false}}}' --max-time 600 2>&1) || true
            SESSION_ID=$(echo "$SESSION_RESPONSE" | grep -o '"sessionId":"[^"]*"' | cut -d'"' -f4 || true)
            if [ -n "$SESSION_ID" ]; then
              sleep 10
              curl -s -X DELETE "http://127.0.0.1:4723/session/$SESSION_ID" || true
              sleep 5
              break
            fi
            [ $attempt -lt 3 ] && sleep 30
          done
      - name: Run Phase 3 Tests
        continue-on-error: true
        run: |
          mvn test -DsuiteXmlFile=src/test/resources/parallel/testng-phase3.xml \
            -DDEVICE_NAME="${{ env.DEVICE_NAME }}" \
            -DPLATFORM_VERSION="${{ env.PLATFORM_VERSION }}" \
            -DSIMULATOR_UDID="${{ env.SIMULATOR_UDID }}" \
            -DAPP_PATH="${{ github.workspace }}/apps/Z Platform-QA.app"
      - name: Upload Phase 3 Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: phase3-report
          path: |
            target/surefire-reports/
            reports/
            screenshots/
          retention-days: 7

  # ========================================
  # JOB 6: Phase 4 Tests (141 tests, ~3 hr)
  # ========================================
  phase4-tests:
    if: github.event_name == 'push' || github.event.inputs.job_selection == 'all' || github.event.inputs.job_selection == 'phase4-only'
    runs-on: macos-15
    timeout-minutes: 420
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Install Appium
        run: |
          npm install -g appium@next
          appium driver install xcuitest
      - name: Unzip App
        run: unzip -o apps/Z-Platform-QA.zip -d apps/
      - name: Boot Simulator and Wait Until Ready
        run: |
          UDID=$(xcrun simctl list devices available | grep -A 100 "iOS 18" | grep "iPhone 16 Pro" | head -1 | awk -F '[()]' '{print $2}')
          [ -z "$UDID" ] && UDID=$(xcrun simctl list devices available | grep -E "iPhone 16 Pro" | head -1 | awk -F '[()]' '{print $2}')
          [ -z "$UDID" ] && UDID=$(xcrun simctl list devices available | grep -E "iPhone 1[5-6]" | head -1 | awk -F '[()]' '{print $2}')
          [ -z "$UDID" ] && exit 1
          xcrun simctl shutdown "$UDID" 2>/dev/null || true
          sleep 3
          xcrun simctl boot "$UDID" 2>/dev/null || true
          ELAPSED=0
          while [ $ELAPSED -lt 240 ]; do
            if xcrun simctl list devices | grep "$UDID" | grep -q "(Booted)"; then
              echo "âœ… Simulator booted after ${ELAPSED}s"
              sleep 45
              break
            fi
            sleep 5
            ELAPSED=$((ELAPSED + 5))
          done
          [ $ELAPSED -ge 240 ] && exit 1
          DEVICE=$(xcrun simctl list devices available | grep "$UDID" | awk -F '(' '{print $1}' | xargs)
          VERSION=$(xcrun simctl list devices available | grep -B 50 "$UDID" | grep "-- iOS" | tail -1 | sed 's/.*iOS \([0-9.]*\).*/\1/')
          [ -z "$VERSION" ] && VERSION="18.5"
          echo "SIMULATOR_UDID=$UDID" >> $GITHUB_ENV
          echo "DEVICE_NAME=$DEVICE" >> $GITHUB_ENV
          echo "PLATFORM_VERSION=$VERSION" >> $GITHUB_ENV
      - name: Pre-install App
        run: xcrun simctl install "${{ env.SIMULATOR_UDID }}" "apps/Z Platform-QA.app"
      - name: Pre-build WebDriverAgent
        run: |
          WDA_PATH=$(find ~/.appium -name "WebDriverAgent.xcodeproj" -type f 2>/dev/null | head -1 | xargs dirname)
          if [ -n "$WDA_PATH" ]; then
            cd "$WDA_PATH"
            xcodebuild build-for-testing -project WebDriverAgent.xcodeproj -scheme WebDriverAgentRunner -destination "platform=iOS Simulator,id=${{ env.SIMULATOR_UDID }}" -derivedDataPath /tmp/wda-build -quiet || true
          fi
      - name: Start Appium Server
        run: |
          appium --relaxed-security --log-level info > appium.log 2>&1 &
          for i in {1..60}; do
            [ "$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:4723/status 2>/dev/null)" = "200" ] && break
            sleep 2
          done
          sleep 10
      - name: Warm-up WDA Session
        env:
          SIMULATOR_UDID: ${{ env.SIMULATOR_UDID }}
          APP_PATH: ${{ github.workspace }}/apps/Z Platform-QA.app
        run: |
          for attempt in 1 2 3; do
            SESSION_RESPONSE=$(curl -s -X POST http://127.0.0.1:4723/session -H "Content-Type: application/json" -d '{"capabilities":{"alwaysMatch":{"platformName":"iOS","appium:automationName":"XCUITest","appium:deviceName":"'"${{ env.DEVICE_NAME }}"'","appium:udid":"'"$SIMULATOR_UDID"'","appium:platformVersion":"'"${{ env.PLATFORM_VERSION }}"'","appium:app":"'"$APP_PATH"'","appium:wdaLaunchTimeout":600000,"appium:wdaConnectionTimeout":300000,"appium:useNewWDA":false,"appium:noReset":false}}}' --max-time 600 2>&1) || true
            SESSION_ID=$(echo "$SESSION_RESPONSE" | grep -o '"sessionId":"[^"]*"' | cut -d'"' -f4 || true)
            if [ -n "$SESSION_ID" ]; then
              sleep 10
              curl -s -X DELETE "http://127.0.0.1:4723/session/$SESSION_ID" || true
              sleep 5
              break
            fi
            [ $attempt -lt 3 ] && sleep 30
          done
      - name: Run Phase 4 Tests
        continue-on-error: true
        run: |
          mvn test -DsuiteXmlFile=src/test/resources/parallel/testng-phase4.xml \
            -DDEVICE_NAME="${{ env.DEVICE_NAME }}" \
            -DPLATFORM_VERSION="${{ env.PLATFORM_VERSION }}" \
            -DSIMULATOR_UDID="${{ env.SIMULATOR_UDID }}" \
            -DAPP_PATH="${{ github.workspace }}/apps/Z Platform-QA.app"
      - name: Upload Phase 4 Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: phase4-report
          path: |
            target/surefire-reports/
            reports/
            screenshots/
          retention-days: 7

  # ========================================
  # JOB 7: Phase 5 Tests (45 tests, ~1 hr)
  # ========================================
  phase5-tests:
    if: github.event_name == 'push' || github.event.inputs.job_selection == 'all' || github.event.inputs.job_selection == 'phase5-only'
    runs-on: macos-15
    timeout-minutes: 420
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Install Appium
        run: |
          npm install -g appium@next
          appium driver install xcuitest
      - name: Unzip App
        run: unzip -o apps/Z-Platform-QA.zip -d apps/
      - name: Boot Simulator and Wait Until Ready
        run: |
          UDID=$(xcrun simctl list devices available | grep -A 100 "iOS 18" | grep "iPhone 16 Pro" | head -1 | awk -F '[()]' '{print $2}')
          [ -z "$UDID" ] && UDID=$(xcrun simctl list devices available | grep -E "iPhone 16 Pro" | head -1 | awk -F '[()]' '{print $2}')
          [ -z "$UDID" ] && UDID=$(xcrun simctl list devices available | grep -E "iPhone 1[5-6]" | head -1 | awk -F '[()]' '{print $2}')
          [ -z "$UDID" ] && exit 1
          xcrun simctl shutdown "$UDID" 2>/dev/null || true
          sleep 3
          xcrun simctl boot "$UDID" 2>/dev/null || true
          ELAPSED=0
          while [ $ELAPSED -lt 240 ]; do
            if xcrun simctl list devices | grep "$UDID" | grep -q "(Booted)"; then
              echo "âœ… Simulator booted after ${ELAPSED}s"
              sleep 45
              break
            fi
            sleep 5
            ELAPSED=$((ELAPSED + 5))
          done
          [ $ELAPSED -ge 240 ] && exit 1
          DEVICE=$(xcrun simctl list devices available | grep "$UDID" | awk -F '(' '{print $1}' | xargs)
          VERSION=$(xcrun simctl list devices available | grep -B 50 "$UDID" | grep "-- iOS" | tail -1 | sed 's/.*iOS \([0-9.]*\).*/\1/')
          [ -z "$VERSION" ] && VERSION="18.5"
          echo "SIMULATOR_UDID=$UDID" >> $GITHUB_ENV
          echo "DEVICE_NAME=$DEVICE" >> $GITHUB_ENV
          echo "PLATFORM_VERSION=$VERSION" >> $GITHUB_ENV
      - name: Pre-install App
        run: xcrun simctl install "${{ env.SIMULATOR_UDID }}" "apps/Z Platform-QA.app"
      - name: Pre-build WebDriverAgent
        run: |
          WDA_PATH=$(find ~/.appium -name "WebDriverAgent.xcodeproj" -type f 2>/dev/null | head -1 | xargs dirname)
          if [ -n "$WDA_PATH" ]; then
            cd "$WDA_PATH"
            xcodebuild build-for-testing -project WebDriverAgent.xcodeproj -scheme WebDriverAgentRunner -destination "platform=iOS Simulator,id=${{ env.SIMULATOR_UDID }}" -derivedDataPath /tmp/wda-build -quiet || true
          fi
      - name: Start Appium Server
        run: |
          appium --relaxed-security --log-level info > appium.log 2>&1 &
          for i in {1..60}; do
            [ "$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:4723/status 2>/dev/null)" = "200" ] && break
            sleep 2
          done
          sleep 10
      - name: Warm-up WDA Session
        env:
          SIMULATOR_UDID: ${{ env.SIMULATOR_UDID }}
          APP_PATH: ${{ github.workspace }}/apps/Z Platform-QA.app
        run: |
          for attempt in 1 2 3; do
            SESSION_RESPONSE=$(curl -s -X POST http://127.0.0.1:4723/session -H "Content-Type: application/json" -d '{"capabilities":{"alwaysMatch":{"platformName":"iOS","appium:automationName":"XCUITest","appium:deviceName":"'"${{ env.DEVICE_NAME }}"'","appium:udid":"'"$SIMULATOR_UDID"'","appium:platformVersion":"'"${{ env.PLATFORM_VERSION }}"'","appium:app":"'"$APP_PATH"'","appium:wdaLaunchTimeout":600000,"appium:wdaConnectionTimeout":300000,"appium:useNewWDA":false,"appium:noReset":false}}}' --max-time 600 2>&1) || true
            SESSION_ID=$(echo "$SESSION_RESPONSE" | grep -o '"sessionId":"[^"]*"' | cut -d'"' -f4 || true)
            if [ -n "$SESSION_ID" ]; then
              sleep 10
              curl -s -X DELETE "http://127.0.0.1:4723/session/$SESSION_ID" || true
              sleep 5
              break
            fi
            [ $attempt -lt 3 ] && sleep 30
          done
      - name: Run Phase 5 Tests
        continue-on-error: true
        run: |
          mvn test -DsuiteXmlFile=src/test/resources/parallel/testng-phase5.xml \
            -DDEVICE_NAME="${{ env.DEVICE_NAME }}" \
            -DPLATFORM_VERSION="${{ env.PLATFORM_VERSION }}" \
            -DSIMULATOR_UDID="${{ env.SIMULATOR_UDID }}" \
            -DAPP_PATH="${{ github.workspace }}/apps/Z Platform-QA.app"
      - name: Upload Phase 5 Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: phase5-report
          path: |
            target/surefire-reports/
            reports/
            screenshots/
          retention-days: 7

  # ========================================
  # JOB 8: Location Tests (84 tests, ~2 hr)
  # ========================================
  location-tests:
    if: github.event_name == 'push' || github.event.inputs.job_selection == 'all' || github.event.inputs.job_selection == 'location-only'
    runs-on: macos-15
    timeout-minutes: 420
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Install Appium
        run: |
          npm install -g appium@next
          appium driver install xcuitest
      - name: Unzip App
        run: unzip -o apps/Z-Platform-QA.zip -d apps/
      - name: Boot Simulator and Wait Until Ready
        run: |
          UDID=$(xcrun simctl list devices available | grep -A 100 "iOS 18" | grep "iPhone 16 Pro" | head -1 | awk -F '[()]' '{print $2}')
          [ -z "$UDID" ] && UDID=$(xcrun simctl list devices available | grep -E "iPhone 16 Pro" | head -1 | awk -F '[()]' '{print $2}')
          [ -z "$UDID" ] && UDID=$(xcrun simctl list devices available | grep -E "iPhone 1[5-6]" | head -1 | awk -F '[()]' '{print $2}')
          [ -z "$UDID" ] && exit 1
          xcrun simctl shutdown "$UDID" 2>/dev/null || true
          sleep 3
          xcrun simctl boot "$UDID" 2>/dev/null || true
          ELAPSED=0
          while [ $ELAPSED -lt 240 ]; do
            if xcrun simctl list devices | grep "$UDID" | grep -q "(Booted)"; then
              echo "âœ… Simulator booted after ${ELAPSED}s"
              sleep 45
              break
            fi
            sleep 5
            ELAPSED=$((ELAPSED + 5))
          done
          [ $ELAPSED -ge 240 ] && exit 1
          DEVICE=$(xcrun simctl list devices available | grep "$UDID" | awk -F '(' '{print $1}' | xargs)
          VERSION=$(xcrun simctl list devices available | grep -B 50 "$UDID" | grep "-- iOS" | tail -1 | sed 's/.*iOS \([0-9.]*\).*/\1/')
          [ -z "$VERSION" ] && VERSION="18.5"
          echo "SIMULATOR_UDID=$UDID" >> $GITHUB_ENV
          echo "DEVICE_NAME=$DEVICE" >> $GITHUB_ENV
          echo "PLATFORM_VERSION=$VERSION" >> $GITHUB_ENV
      - name: Pre-install App
        run: xcrun simctl install "${{ env.SIMULATOR_UDID }}" "apps/Z Platform-QA.app"
      - name: Pre-build WebDriverAgent
        run: |
          WDA_PATH=$(find ~/.appium -name "WebDriverAgent.xcodeproj" -type f 2>/dev/null | head -1 | xargs dirname)
          if [ -n "$WDA_PATH" ]; then
            cd "$WDA_PATH"
            xcodebuild build-for-testing -project WebDriverAgent.xcodeproj -scheme WebDriverAgentRunner -destination "platform=iOS Simulator,id=${{ env.SIMULATOR_UDID }}" -derivedDataPath /tmp/wda-build -quiet || true
          fi
      - name: Start Appium Server
        run: |
          appium --relaxed-security --log-level info > appium.log 2>&1 &
          for i in {1..60}; do
            [ "$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:4723/status 2>/dev/null)" = "200" ] && break
            sleep 2
          done
          sleep 10
      - name: Warm-up WDA Session
        env:
          SIMULATOR_UDID: ${{ env.SIMULATOR_UDID }}
          APP_PATH: ${{ github.workspace }}/apps/Z Platform-QA.app
        run: |
          for attempt in 1 2 3; do
            SESSION_RESPONSE=$(curl -s -X POST http://127.0.0.1:4723/session -H "Content-Type: application/json" -d '{"capabilities":{"alwaysMatch":{"platformName":"iOS","appium:automationName":"XCUITest","appium:deviceName":"'"${{ env.DEVICE_NAME }}"'","appium:udid":"'"$SIMULATOR_UDID"'","appium:platformVersion":"'"${{ env.PLATFORM_VERSION }}"'","appium:app":"'"$APP_PATH"'","appium:wdaLaunchTimeout":600000,"appium:wdaConnectionTimeout":300000,"appium:useNewWDA":false,"appium:noReset":false}}}' --max-time 600 2>&1) || true
            SESSION_ID=$(echo "$SESSION_RESPONSE" | grep -o '"sessionId":"[^"]*"' | cut -d'"' -f4 || true)
            if [ -n "$SESSION_ID" ]; then
              sleep 10
              curl -s -X DELETE "http://127.0.0.1:4723/session/$SESSION_ID" || true
              sleep 5
              break
            fi
            [ $attempt -lt 3 ] && sleep 30
          done
      - name: Run Location Tests
        continue-on-error: true
        run: |
          mvn test -DsuiteXmlFile=src/test/resources/parallel/testng-location.xml \
            -DDEVICE_NAME="${{ env.DEVICE_NAME }}" \
            -DPLATFORM_VERSION="${{ env.PLATFORM_VERSION }}" \
            -DSIMULATOR_UDID="${{ env.SIMULATOR_UDID }}" \
            -DAPP_PATH="${{ github.workspace }}/apps/Z Platform-QA.app"
      - name: Upload Location Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: location-report
          path: |
            target/surefire-reports/
            reports/
            screenshots/
          retention-days: 7


  # ========================================
  # JOB 9: Connections Tests (94 tests, ~2 hr)
  # ========================================
  connections-tests:
    if: github.event_name == 'push' || github.event.inputs.job_selection == 'all' || github.event.inputs.job_selection == 'connections-only'
    runs-on: macos-15
    timeout-minutes: 420
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Install Appium
        run: |
          npm install -g appium@next
          appium driver install xcuitest
      - name: Unzip App
        run: unzip -o apps/Z-Platform-QA.zip -d apps/
      - name: Boot Simulator and Wait Until Ready
        run: |
          UDID=$(xcrun simctl list devices available | grep -A 100 "iOS 18" | grep "iPhone 16 Pro" | head -1 | awk -F '[()]' '{print $2}')
          [ -z "$UDID" ] && UDID=$(xcrun simctl list devices available | grep -E "iPhone 16 Pro" | head -1 | awk -F '[()]' '{print $2}')
          [ -z "$UDID" ] && UDID=$(xcrun simctl list devices available | grep -E "iPhone 1[5-6]" | head -1 | awk -F '[()]' '{print $2}')
          [ -z "$UDID" ] && exit 1
          xcrun simctl shutdown "$UDID" 2>/dev/null || true
          sleep 3
          xcrun simctl boot "$UDID" 2>/dev/null || true
          ELAPSED=0
          while [ $ELAPSED -lt 240 ]; do
            if xcrun simctl list devices | grep "$UDID" | grep -q "(Booted)"; then
              echo "âœ… Simulator booted after ${ELAPSED}s"
              sleep 45
              break
            fi
            sleep 5
            ELAPSED=$((ELAPSED + 5))
          done
          [ $ELAPSED -ge 240 ] && exit 1
          DEVICE=$(xcrun simctl list devices available | grep "$UDID" | awk -F '(' '{print $1}' | xargs)
          VERSION=$(xcrun simctl list devices available | grep -B 50 "$UDID" | grep "-- iOS" | tail -1 | sed 's/.*iOS \([0-9.]*\).*/\1/')
          [ -z "$VERSION" ] && VERSION="18.5"
          echo "SIMULATOR_UDID=$UDID" >> $GITHUB_ENV
          echo "DEVICE_NAME=$DEVICE" >> $GITHUB_ENV
          echo "PLATFORM_VERSION=$VERSION" >> $GITHUB_ENV
      - name: Pre-install App
        run: xcrun simctl install "${{ env.SIMULATOR_UDID }}" "apps/Z Platform-QA.app"
      - name: Pre-build WebDriverAgent
        run: |
          WDA_PATH=$(find ~/.appium -name "WebDriverAgent.xcodeproj" -type f 2>/dev/null | head -1 | xargs dirname)
          if [ -n "$WDA_PATH" ]; then
            cd "$WDA_PATH"
            xcodebuild build-for-testing -project WebDriverAgent.xcodeproj -scheme WebDriverAgentRunner -destination "platform=iOS Simulator,id=${{ env.SIMULATOR_UDID }}" -derivedDataPath /tmp/wda-build -quiet || true
          fi
      - name: Start Appium Server
        run: |
          appium --relaxed-security --log-level info > appium.log 2>&1 &
          for i in {1..60}; do
            [ "$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:4723/status 2>/dev/null)" = "200" ] && break
            sleep 2
          done
          sleep 10
      - name: Warm-up WDA Session
        env:
          SIMULATOR_UDID: ${{ env.SIMULATOR_UDID }}
          APP_PATH: ${{ github.workspace }}/apps/Z Platform-QA.app
        run: |
          for attempt in 1 2 3; do
            SESSION_RESPONSE=$(curl -s -X POST http://127.0.0.1:4723/session -H "Content-Type: application/json" -d '{"capabilities":{"alwaysMatch":{"platformName":"iOS","appium:automationName":"XCUITest","appium:deviceName":"'"${{ env.DEVICE_NAME }}"'","appium:udid":"'"$SIMULATOR_UDID"'","appium:platformVersion":"'"${{ env.PLATFORM_VERSION }}"'","appium:app":"'"$APP_PATH"'","appium:wdaLaunchTimeout":600000,"appium:wdaConnectionTimeout":300000,"appium:useNewWDA":false,"appium:noReset":false}}}' --max-time 600 2>&1) || true
            SESSION_ID=$(echo "$SESSION_RESPONSE" | grep -o '"sessionId":"[^"]*"' | cut -d'"' -f4 || true)
            if [ -n "$SESSION_ID" ]; then
              sleep 10
              curl -s -X DELETE "http://127.0.0.1:4723/session/$SESSION_ID" || true
              sleep 5
              break
            fi
            [ $attempt -lt 3 ] && sleep 30
          done
      - name: Run Connections Tests
        continue-on-error: true
        run: |
          mvn test -DsuiteXmlFile=src/test/resources/parallel/testng-connections.xml \
            -DDEVICE_NAME="${{ env.DEVICE_NAME }}" \
            -DPLATFORM_VERSION="${{ env.PLATFORM_VERSION }}" \
            -DSIMULATOR_UDID="${{ env.SIMULATOR_UDID }}" \
            -DAPP_PATH="${{ github.workspace }}/apps/Z Platform-QA.app"
      - name: Upload Connections Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: connections-report
          path: |
            target/surefire-reports/
            reports/
            screenshots/
          retention-days: 7

  # ========================================
  # FINAL JOB: Merge Reports & Send Email
  # ========================================
  send-email:
    needs: [auth-tests, site-tests, phase1-tests, phase2-tests, phase3-tests, phase4-tests, phase5-tests, location-tests, connections-tests]
    if: always()
    runs-on: ubuntu-latest
    timeout-minutes: 420
    
    steps:
      - name: Download All Reports
        uses: actions/download-artifact@v4
        with:
          path: all-reports
        continue-on-error: true

      - name: Prepare Email Summary
        id: email
        run: |
          AUTH="${{ needs.auth-tests.result }}"
          SITE="${{ needs.site-tests.result }}"
          P1="${{ needs.phase1-tests.result }}"
          P2="${{ needs.phase2-tests.result }}"
          P3="${{ needs.phase3-tests.result }}"
          P4="${{ needs.phase4-tests.result }}"
          P5="${{ needs.phase5-tests.result }}"
          LOC="${{ needs.location-tests.result }}"
          CONN="${{ needs.connections-tests.result }}"
          
          SUCCESS=0
          [ "$AUTH" = "success" ] && SUCCESS=$((SUCCESS+1))
          [ "$SITE" = "success" ] && SUCCESS=$((SUCCESS+1))
          [ "$P1" = "success" ] && SUCCESS=$((SUCCESS+1))
          [ "$P2" = "success" ] && SUCCESS=$((SUCCESS+1))
          [ "$P3" = "success" ] && SUCCESS=$((SUCCESS+1))
          [ "$P4" = "success" ] && SUCCESS=$((SUCCESS+1))
          [ "$P5" = "success" ] && SUCCESS=$((SUCCESS+1))
          [ "$LOC" = "success" ] && SUCCESS=$((SUCCESS+1))
          [ "$CONN" = "success" ] && SUCCESS=$((SUCCESS+1))
          
          FAILED=$((9-SUCCESS))
          echo "SUCCESS=$SUCCESS" >> $GITHUB_OUTPUT
          echo "FAILED=$FAILED" >> $GITHUB_OUTPUT
          
          if [ $SUCCESS -eq 9 ]; then
            STATUS="âœ… ALL PASSED"
          elif [ $SUCCESS -ge 7 ]; then
            STATUS="âš ï¸ MOSTLY PASSED"
          else
            STATUS="âŒ FAILED"
          fi
          echo "STATUS=$STATUS" >> $GITHUB_OUTPUT
          
          cat > email_body.html << EOF
          <!DOCTYPE html>
          <html>
          <body style="font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto;">
            <h1 style="color: #333;">ðŸ§ª iOS Full Test Suite Results</h1>
            <p><b>Branch:</b> ${{ github.ref_name }}</p>
            <p><b>Commit:</b> ${{ github.sha }}</p>
            <p><b>Triggered by:</b> ${{ github.actor }}</p>
            <p><b>Run:</b> <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">View Full Details</a></p>
            <hr>
            
            <h2>Results: ${SUCCESS}/8 Jobs Passed - ${STATUS}</h2>
            
            <table border="1" cellpadding="10" style="border-collapse: collapse; width: 100%;">
              <tr style="background-color: #4a90d9; color: white;">
                <th>Job</th>
                <th>Tests</th>
                <th>Est. Time</th>
                <th>Status</th>
              </tr>
              <tr><td>Auth Tests</td><td>38</td><td>~45 min</td><td>${AUTH}</td></tr>
              <tr><td>Site Tests</td><td>52</td><td>~1.5 hr</td><td>${SITE}</td></tr>
              <tr><td>Phase 1 Tests</td><td>139</td><td>~3 hr</td><td>${P1}</td></tr>
              <tr><td>Phase 2 Tests</td><td>159</td><td>~3.5 hr</td><td>${P2}</td></tr>
              <tr><td>Phase 3 Tests</td><td>169</td><td>~4 hr</td><td>${P3}</td></tr>
              <tr><td>Phase 4 Tests</td><td>141</td><td>~3 hr</td><td>${P4}</td></tr>
              <tr><td>Phase 5 Tests</td><td>45</td><td>~1 hr</td><td>${P5}</td></tr>
              <tr><td>Location Tests</td><td>84</td><td>~2 hr</td><td>${LOC}</td></tr>
            </table>
            
            <hr>
            <h3>Summary</h3>
            <p><b>Total Tests:</b> ~827</p>
            <p><b>Jobs Passed:</b> ${SUCCESS}</p>
            <p><b>Jobs Failed:</b> ${FAILED}</p>
            <p><b>Wall Clock Time:</b> ~4 hours (parallel execution)</p>
            
            <p style="margin-top: 20px; color: #666; font-size: 12px;">
              This is an automated report from eGalvanic iOS Automation Suite.<br>
              Individual job reports are available as artifacts in the GitHub Actions run.
            </p>
          </body>
          </html>
          EOF

      - name: Send Email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "[${{ steps.email.outputs.STATUS }}] iOS Full Suite - ${{ steps.email.outputs.SUCCESS }}/8 Jobs Passed"
          html_body: file://email_body.html
          to: ${{ secrets.EMAIL_TO }}
          from: "iOS Automation <${{ secrets.EMAIL_USERNAME }}>"
        continue-on-error: true

      - name: Summary
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘          FULL TEST SUITE COMPLETE                               â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ðŸ“Š Results: ${{ steps.email.outputs.SUCCESS }}/8 Jobs Passed"
          echo ""
          echo "   Auth Tests (38):    ${{ needs.auth-tests.result }}"
          echo "   Site Tests (52):    ${{ needs.site-tests.result }}"
          echo "   Phase 1 (139):      ${{ needs.phase1-tests.result }}"
          echo "   Phase 2 (159):      ${{ needs.phase2-tests.result }}"
          echo "   Phase 3 (169):      ${{ needs.phase3-tests.result }}"
          echo "   Phase 4 (141):      ${{ needs.phase4-tests.result }}"
          echo "   Phase 5 (45):       ${{ needs.phase5-tests.result }}"
          echo "   Location (84):      ${{ needs.location-tests.result }}"
          echo ""
          echo "ðŸ“§ Email sent to configured recipients"
          echo ""
          echo "ðŸ”— Full Details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
