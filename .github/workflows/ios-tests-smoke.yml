name: iOS Tests - Smoke Suite

# ============================================================
# SMOKE TEST SUITE - Quick Critical Path Validation
# ============================================================
# Purpose: Fast validation of core functionality before full suite
# Tests: 17 tests across 5 modules (~15-20 min execution)
# 
# Smoke Test Selection Criteria:
#   1. Critical user flows (app launch, login, site selection)
#   2. Core feature access (asset, location, connections)
#   3. High reliability tests (UI element visibility)
#   4. Fast execution (no heavy data operations)
#
# Modules Covered:
#   - Authentication: 4 tests (Welcome, Company Code, Login)
#   - Site Selection: 4 tests (UI, Site List, Search, Dashboard)
#   - Asset Management: 3 tests (New Asset, Fields, Class)
#   - Location: 3 tests (Building UI, Save, Name)
#   - Connections: 3 tests (Tab, Header, List)
#
# Configuration (matching ios-tests-parallel.yml):
#   - Pre-build WebDriverAgent
#   - Warm-up WDA Session with 3 retry attempts
#   - Boot loop with (Booted) check
#   - 45s post-boot stabilization
# ============================================================

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      run_full_suite_after:
        description: 'Run full test suite after smoke tests pass'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  # ========================================
  # SMOKE TESTS (17 tests, ~15-20 min)
  # Runs FIRST to validate critical paths
  # ========================================
  smoke-tests:
    runs-on: macos-15
    timeout-minutes: 420
    outputs:
      smoke_result: ${{ steps.smoke_status.outputs.result }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Appium
        run: |
          npm install -g appium@next
          appium driver install xcuitest
          echo "âœ… Appium $(appium --version) installed"

      - name: Unzip App
        run: |
          unzip -o apps/Z-Platform-QA.zip -d apps/
          ls -la apps/

      - name: Boot Simulator and Wait Until Ready
        run: |
          echo "=== Available Simulators ==="
          xcrun simctl list devices available
          
          UDID=$(xcrun simctl list devices available | grep -A 100 "iOS 18" | grep "iPhone 16 Pro" | head -1 | awk -F '[()]' '{print $2}')
          [ -z "$UDID" ] && UDID=$(xcrun simctl list devices available | grep -E "iPhone 16 Pro" | head -1 | awk -F '[()]' '{print $2}')
          [ -z "$UDID" ] && UDID=$(xcrun simctl list devices available | grep -E "iPhone 1[5-6]" | head -1 | awk -F '[()]' '{print $2}')
          
          if [ -z "$UDID" ]; then
            echo "âŒ No iPhone simulator found!"
            exit 1
          fi
          
          DEVICE_NAME=$(xcrun simctl list devices available | grep "$UDID" | sed 's/(.*//' | xargs)
          PLATFORM_VERSION=$(xcrun simctl list devices available | grep -B 20 "$UDID" | grep "iOS" | tail -1 | sed 's/-- iOS //' | sed 's/ --.*//')
          
          echo "ğŸ“± Selected Device: $DEVICE_NAME"
          echo "ğŸ“± UDID: $UDID"
          echo "ğŸ“± iOS Version: $PLATFORM_VERSION"
          
          echo "DEVICE_NAME=$DEVICE_NAME" >> $GITHUB_ENV
          echo "SIMULATOR_UDID=$UDID" >> $GITHUB_ENV
          echo "PLATFORM_VERSION=$PLATFORM_VERSION" >> $GITHUB_ENV
          
          echo "=== Booting Simulator ==="
          xcrun simctl boot "$UDID" 2>/dev/null || true
          
          echo "=== Waiting for Simulator to be fully booted ==="
          for i in {1..60}; do
            STATE=$(xcrun simctl list devices | grep "$UDID" | grep -o "(Booted)" || true)
            if [ "$STATE" = "(Booted)" ]; then
              echo "âœ… Simulator booted after $i seconds"
              break
            fi
            echo "   Waiting... ($i/60)"
            sleep 1
          done
          
          echo "=== Post-boot stabilization (45s) ==="
          sleep 45
          echo "âœ… Simulator ready"

      - name: Pre-build WebDriverAgent
        run: |
          echo "Pre-building WebDriverAgent to avoid timeout on first test..."
          WDA_PATH=$(find ~/.appium -name "WebDriverAgent.xcodeproj" -type f 2>/dev/null | head -1 | xargs dirname)
          
          if [ -n "$WDA_PATH" ]; then
            echo "Found WDA at: $WDA_PATH"
            cd "$WDA_PATH"
            
            xcodebuild build-for-testing \
              -project WebDriverAgent.xcodeproj \
              -scheme WebDriverAgentRunner \
              -destination "platform=iOS Simulator,id=${{ env.SIMULATOR_UDID }}" \
              -derivedDataPath /tmp/wda-build \
              -quiet || echo "WDA pre-build completed (may have warnings)"
            
            echo "âœ… WDA pre-built"
          else
            echo "âš ï¸ WDA not found, will be built on first test run"
          fi

      - name: Start Appium Server
        run: |
          echo "Starting Appium..."
          appium --relaxed-security --log-level info > appium.log 2>&1 &
          APPIUM_PID=$!
          echo "Appium PID: $APPIUM_PID"
          
          APPIUM_READY=false
          for i in {1..60}; do
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:4723/status 2>/dev/null || echo "000")
            if [ "$HTTP_STATUS" = "200" ]; then
              echo "âœ… Appium server is ready! (HTTP $HTTP_STATUS)"
              APPIUM_READY=true
              break
            fi
            echo "Waiting for Appium... ($i/60) - HTTP: $HTTP_STATUS"
            sleep 2
          done
          
          if [ "$APPIUM_READY" = false ]; then
            echo "âŒ Appium failed to start"
            cat appium.log | tail -30
            exit 1
          fi
          
          echo "Waiting 10s for Appium to fully initialize..."
          sleep 10
          echo "âœ… Appium server verified and ready"

      - name: Warm-up WDA Session
        env:
          SIMULATOR_UDID: ${{ env.SIMULATOR_UDID }}
          APP_PATH: ${{ github.workspace }}/apps/Z Platform-QA.app
        run: |
          echo "=== Warming up WDA with a test session ==="
          
          for attempt in 1 2 3; do
            echo "Warm-up attempt $attempt/3..."
            
            SESSION_RESPONSE=$(curl -s -X POST http://127.0.0.1:4723/session \
              -H "Content-Type: application/json" \
              -d '{
                "capabilities": {
                  "alwaysMatch": {
                    "platformName": "iOS",
                    "appium:automationName": "XCUITest",
                    "appium:deviceName": "'"${{ env.DEVICE_NAME }}"'",
                    "appium:udid": "'"$SIMULATOR_UDID"'",
                    "appium:platformVersion": "'"${{ env.PLATFORM_VERSION }}"'",
                    "appium:app": "'"$APP_PATH"'",
                    "appium:wdaLaunchTimeout": 600000,
                    "appium:wdaConnectionTimeout": 300000,
                    "appium:useNewWDA": false,
                    "appium:noReset": false
                  }
                }
              }' --max-time 600 2>&1) || true
            
            SESSION_ID=$(echo "$SESSION_RESPONSE" | grep -o '"sessionId":"[^"]*"' | cut -d'"' -f4 || true)
            
            if [ -n "$SESSION_ID" ]; then
              echo "âœ… WDA warm-up session created: $SESSION_ID"
              sleep 10
              curl -s -X DELETE "http://127.0.0.1:4723/session/$SESSION_ID" || true
              echo "âœ… Warm-up session closed"
              sleep 5
              echo "âœ… WDA warm-up complete"
              break
            else
              echo "âš ï¸ Attempt $attempt failed"
              [ $attempt -lt 3 ] && sleep 30
            fi
          done

      - name: Run Smoke Tests
        id: smoke_tests
        continue-on-error: true
        env:
          SIMULATOR_UDID: ${{ env.SIMULATOR_UDID }}
          PLATFORM_VERSION: ${{ env.PLATFORM_VERSION }}
          DEVICE_NAME: ${{ env.DEVICE_NAME }}
          APP_PATH: ${{ github.workspace }}/apps/Z Platform-QA.app
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘         ğŸ”¥ SMOKE TEST SUITE (17 tests)                     â•‘"
          echo "â•‘    Quick validation of critical paths (~15-20 min)         â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“‹ Tests included:"
          echo "   Authentication: TC01, TC04, TC07, TC16"
          echo "   Site Selection: TC_SS_001, TC_SS_003, TC_SS_007, TC_SS_014"
          echo "   Asset: ATS_ECR_01, ATS_ECR_02, ATS_ECR_14"
          echo "   Location: TC_NB_001, TC_NB_003, TC_NB_004"
          echo "   Connections: TC_CONN_001, TC_CONN_002, TC_CONN_004"
          echo ""
          mvn test -DsuiteXmlFile=src/test/resources/parallel/testng-smoke.xml \
            -DDEVICE_NAME="$DEVICE_NAME" \
            -DPLATFORM_VERSION="$PLATFORM_VERSION" \
            -DSIMULATOR_UDID="$SIMULATOR_UDID" \
            -DAPP_PATH="$APP_PATH"

      - name: Capture Smoke Test Status
        id: smoke_status
        if: always()
        run: |
          if [ "${{ steps.smoke_tests.outcome }}" == "success" ]; then
            echo "result=passed" >> $GITHUB_OUTPUT
            echo "âœ… SMOKE TESTS PASSED"
          else
            echo "result=failed" >> $GITHUB_OUTPUT
            echo "âŒ SMOKE TESTS FAILED"
          fi

      - name: Upload Smoke Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-report
          path: |
            target/surefire-reports/
            reports/
            screenshots/
          retention-days: 7

      - name: Smoke Test Summary
        if: always()
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘         ğŸ”¥ SMOKE TEST SUITE COMPLETE                       â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“Š Result: ${{ steps.smoke_status.outputs.result }}"
          echo ""
          echo "ğŸ“‹ Smoke Tests Coverage:"
          echo "   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
          echo "   â”‚ Module          â”‚ Tests â”‚ Purpose                        â”‚"
          echo "   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
          echo "   â”‚ Authentication  â”‚   4   â”‚ Welcome, Company Code, Login   â”‚"
          echo "   â”‚ Site Selection  â”‚   4   â”‚ UI, Site List, Search, Dashboardâ”‚"
          echo "   â”‚ Asset Managementâ”‚   3   â”‚ New Asset, Fields, Class       â”‚"
          echo "   â”‚ Location        â”‚   3   â”‚ Building UI, Save, Name        â”‚"
          echo "   â”‚ Connections     â”‚   3   â”‚ Tab, Header, List              â”‚"
          echo "   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
          echo ""
          echo "ğŸ”— Full Details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

  # ========================================
  # TRIGGER FULL SUITE (Optional)
  # Only runs if smoke tests pass AND user requested it
  # ========================================
  trigger-full-suite:
    needs: smoke-tests
    if: |
      always() && 
      needs.smoke-tests.outputs.smoke_result == 'passed' && 
      github.event.inputs.run_full_suite_after == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 420
    
    steps:
      - name: Trigger Full Test Suite
        uses: actions/github-script@v7
        with:
          script: |
            console.log('ğŸš€ Smoke tests passed! Triggering full test suite...');
            
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'ios-tests-parallel.yml',
              ref: context.ref,
              inputs: {
                job_selection: 'all'
              }
            });
            
            console.log('âœ… Full test suite triggered successfully');

      - name: Summary
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘    ğŸš€ FULL TEST SUITE TRIGGERED                            â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "âœ… Smoke tests passed - Full suite workflow dispatched"
          echo ""
          echo "ğŸ”— Check Actions tab for full suite progress"
