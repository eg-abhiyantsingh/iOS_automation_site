name: iOS Tests - Assets (Phase 1-5)

# ============================================================
# ASSET TESTS WORKFLOW
# ============================================================
# Tests: Phase 1 (139) + Phase 2 (159) + Phase 3 (169) + 
#        Phase 4 (141) + Phase 5 (45) = 653 tests
# Wall Clock: ~5 hours (all run in parallel)
# Email: Sent when complete (~5 hours)
# ============================================================

on:
  push:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  # ========================================
  # JOB 1: Phase 1 Tests (139 tests, ~4 hr)
  # ========================================
  phase1-tests:
    runs-on: macos-15
    timeout-minutes: 359
    
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Install Appium
        run: |
          npm install -g appium@next
          appium driver install xcuitest
      - name: Unzip App
        run: unzip -o apps/Z-Platform-QA.zip -d apps/
      - name: Boot Simulator
        run: |
          UDID=$(xcrun simctl list devices available | grep -A 100 "iOS 18" | grep "iPhone 16 Pro" | head -1 | awk -F '[()]' '{print $2}')
          [ -z "$UDID" ] && UDID=$(xcrun simctl list devices available | grep -E "iPhone 16 Pro" | head -1 | awk -F '[()]' '{print $2}')
          [ -z "$UDID" ] && UDID=$(xcrun simctl list devices available | grep -E "iPhone 1[5-6]" | head -1 | awk -F '[()]' '{print $2}')
          [ -z "$UDID" ] && exit 1
          xcrun simctl shutdown "$UDID" 2>/dev/null || true
          sleep 3
          xcrun simctl boot "$UDID" 2>/dev/null || true
          ELAPSED=0
          while [ $ELAPSED -lt 240 ]; do
            xcrun simctl list devices | grep "$UDID" | grep -q "(Booted)" && sleep 45 && break
            sleep 5
            ELAPSED=$((ELAPSED + 5))
          done
          [ $ELAPSED -ge 240 ] && exit 1
          DEVICE=$(xcrun simctl list devices available | grep "$UDID" | awk -F '(' '{print $1}' | xargs)
          VERSION=$(xcrun simctl list devices available | grep -B 50 "$UDID" | grep "-- iOS" | tail -1 | sed 's/.*iOS \([0-9.]*\).*/\1/')
          [ -z "$VERSION" ] && VERSION="18.5"
          echo "SIMULATOR_UDID=$UDID" >> $GITHUB_ENV
          echo "DEVICE_NAME=$DEVICE" >> $GITHUB_ENV
          echo "PLATFORM_VERSION=$VERSION" >> $GITHUB_ENV
      - name: Pre-install App
        run: xcrun simctl install "${{ env.SIMULATOR_UDID }}" "apps/Z Platform-QA.app"
      - name: Pre-build WDA
        run: |
          WDA_PATH=$(find ~/.appium -name "WebDriverAgent.xcodeproj" -type f 2>/dev/null | head -1 | xargs dirname)
          [ -n "$WDA_PATH" ] && cd "$WDA_PATH" && xcodebuild build-for-testing -project WebDriverAgent.xcodeproj -scheme WebDriverAgentRunner -destination "platform=iOS Simulator,id=${{ env.SIMULATOR_UDID }}" -derivedDataPath /tmp/wda-build -quiet || true
      - name: Start Appium
        run: |
          appium --relaxed-security --log-level info > appium.log 2>&1 &
          for i in {1..60}; do [ "$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:4723/status 2>/dev/null)" = "200" ] && break; sleep 2; done
          sleep 10
      - name: Warm-up WDA
        run: |
          for attempt in 1 2 3; do
            RESP=$(curl -s -X POST http://127.0.0.1:4723/session -H "Content-Type: application/json" -d '{"capabilities":{"alwaysMatch":{"platformName":"iOS","appium:automationName":"XCUITest","appium:deviceName":"'"${{ env.DEVICE_NAME }}"'","appium:udid":"'"${{ env.SIMULATOR_UDID }}"'","appium:platformVersion":"'"${{ env.PLATFORM_VERSION }}"'","appium:app":"'"${{ github.workspace }}/apps/Z Platform-QA.app"'","appium:wdaLaunchTimeout":600000,"appium:wdaConnectionTimeout":300000,"appium:useNewWDA":false,"appium:noReset":false}}}' --max-time 600 2>&1) || true
            SID=$(echo "$RESP" | grep -o '"sessionId":"[^"]*"' | cut -d'"' -f4 || true)
            [ -n "$SID" ] && sleep 10 && curl -s -X DELETE "http://127.0.0.1:4723/session/$SID" || true && break
            [ $attempt -lt 3 ] && sleep 30
          done
      - name: Run Phase 1 Tests
        continue-on-error: true
        run: |
          mvn test -DsuiteXmlFile=src/test/resources/parallel/testng-phase1.xml \
            -DDEVICE_NAME="${{ env.DEVICE_NAME }}" \
            -DPLATFORM_VERSION="${{ env.PLATFORM_VERSION }}" \
            -DSIMULATOR_UDID="${{ env.SIMULATOR_UDID }}" \
            -DAPP_PATH="${{ github.workspace }}/apps/Z Platform-QA.app"
      - name: Upload Phase 1 Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: asset-phase1-report
          path: |
            target/surefire-reports/
            reports/
            screenshots/
          retention-days: 7

  # ========================================
  # JOB 2: Phase 2 Tests (159 tests, ~4.5 hr)
  # ========================================
  phase2-tests:
    runs-on: macos-15
    timeout-minutes: 359
    
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Install Appium
        run: |
          npm install -g appium@next
          appium driver install xcuitest
      - name: Unzip App
        run: unzip -o apps/Z-Platform-QA.zip -d apps/
      - name: Boot Simulator
        run: |
          UDID=$(xcrun simctl list devices available | grep -A 100 "iOS 18" | grep "iPhone 16 Pro" | head -1 | awk -F '[()]' '{print $2}')
          [ -z "$UDID" ] && UDID=$(xcrun simctl list devices available | grep -E "iPhone 16 Pro" | head -1 | awk -F '[()]' '{print $2}')
          [ -z "$UDID" ] && UDID=$(xcrun simctl list devices available | grep -E "iPhone 1[5-6]" | head -1 | awk -F '[()]' '{print $2}')
          [ -z "$UDID" ] && exit 1
          xcrun simctl shutdown "$UDID" 2>/dev/null || true
          sleep 3
          xcrun simctl boot "$UDID" 2>/dev/null || true
          ELAPSED=0
          while [ $ELAPSED -lt 240 ]; do
            xcrun simctl list devices | grep "$UDID" | grep -q "(Booted)" && sleep 45 && break
            sleep 5
            ELAPSED=$((ELAPSED + 5))
          done
          [ $ELAPSED -ge 240 ] && exit 1
          DEVICE=$(xcrun simctl list devices available | grep "$UDID" | awk -F '(' '{print $1}' | xargs)
          VERSION=$(xcrun simctl list devices available | grep -B 50 "$UDID" | grep "-- iOS" | tail -1 | sed 's/.*iOS \([0-9.]*\).*/\1/')
          [ -z "$VERSION" ] && VERSION="18.5"
          echo "SIMULATOR_UDID=$UDID" >> $GITHUB_ENV
          echo "DEVICE_NAME=$DEVICE" >> $GITHUB_ENV
          echo "PLATFORM_VERSION=$VERSION" >> $GITHUB_ENV
      - name: Pre-install App
        run: xcrun simctl install "${{ env.SIMULATOR_UDID }}" "apps/Z Platform-QA.app"
      - name: Pre-build WDA
        run: |
          WDA_PATH=$(find ~/.appium -name "WebDriverAgent.xcodeproj" -type f 2>/dev/null | head -1 | xargs dirname)
          [ -n "$WDA_PATH" ] && cd "$WDA_PATH" && xcodebuild build-for-testing -project WebDriverAgent.xcodeproj -scheme WebDriverAgentRunner -destination "platform=iOS Simulator,id=${{ env.SIMULATOR_UDID }}" -derivedDataPath /tmp/wda-build -quiet || true
      - name: Start Appium
        run: |
          appium --relaxed-security --log-level info > appium.log 2>&1 &
          for i in {1..60}; do [ "$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:4723/status 2>/dev/null)" = "200" ] && break; sleep 2; done
          sleep 10
      - name: Warm-up WDA
        run: |
          for attempt in 1 2 3; do
            RESP=$(curl -s -X POST http://127.0.0.1:4723/session -H "Content-Type: application/json" -d '{"capabilities":{"alwaysMatch":{"platformName":"iOS","appium:automationName":"XCUITest","appium:deviceName":"'"${{ env.DEVICE_NAME }}"'","appium:udid":"'"${{ env.SIMULATOR_UDID }}"'","appium:platformVersion":"'"${{ env.PLATFORM_VERSION }}"'","appium:app":"'"${{ github.workspace }}/apps/Z Platform-QA.app"'","appium:wdaLaunchTimeout":600000,"appium:wdaConnectionTimeout":300000,"appium:useNewWDA":false,"appium:noReset":false}}}' --max-time 600 2>&1) || true
            SID=$(echo "$RESP" | grep -o '"sessionId":"[^"]*"' | cut -d'"' -f4 || true)
            [ -n "$SID" ] && sleep 10 && curl -s -X DELETE "http://127.0.0.1:4723/session/$SID" || true && break
            [ $attempt -lt 3 ] && sleep 30
          done
      - name: Run Phase 2 Tests
        continue-on-error: true
        run: |
          mvn test -DsuiteXmlFile=src/test/resources/parallel/testng-phase2.xml \
            -DDEVICE_NAME="${{ env.DEVICE_NAME }}" \
            -DPLATFORM_VERSION="${{ env.PLATFORM_VERSION }}" \
            -DSIMULATOR_UDID="${{ env.SIMULATOR_UDID }}" \
            -DAPP_PATH="${{ github.workspace }}/apps/Z Platform-QA.app"
      - name: Upload Phase 2 Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: asset-phase2-report
          path: |
            target/surefire-reports/
            reports/
            screenshots/
          retention-days: 7

  # ========================================
  # JOB 3: Phase 3 Tests (169 tests, ~5 hr)
  # ========================================
  phase3-tests:
    runs-on: macos-15
    timeout-minutes: 359
    
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Install Appium
        run: |
          npm install -g appium@next
          appium driver install xcuitest
      - name: Unzip App
        run: unzip -o apps/Z-Platform-QA.zip -d apps/
      - name: Boot Simulator
        run: |
          UDID=$(xcrun simctl list devices available | grep -A 100 "iOS 18" | grep "iPhone 16 Pro" | head -1 | awk -F '[()]' '{print $2}')
          [ -z "$UDID" ] && UDID=$(xcrun simctl list devices available | grep -E "iPhone 16 Pro" | head -1 | awk -F '[()]' '{print $2}')
          [ -z "$UDID" ] && UDID=$(xcrun simctl list devices available | grep -E "iPhone 1[5-6]" | head -1 | awk -F '[()]' '{print $2}')
          [ -z "$UDID" ] && exit 1
          xcrun simctl shutdown "$UDID" 2>/dev/null || true
          sleep 3
          xcrun simctl boot "$UDID" 2>/dev/null || true
          ELAPSED=0
          while [ $ELAPSED -lt 240 ]; do
            xcrun simctl list devices | grep "$UDID" | grep -q "(Booted)" && sleep 45 && break
            sleep 5
            ELAPSED=$((ELAPSED + 5))
          done
          [ $ELAPSED -ge 240 ] && exit 1
          DEVICE=$(xcrun simctl list devices available | grep "$UDID" | awk -F '(' '{print $1}' | xargs)
          VERSION=$(xcrun simctl list devices available | grep -B 50 "$UDID" | grep "-- iOS" | tail -1 | sed 's/.*iOS \([0-9.]*\).*/\1/')
          [ -z "$VERSION" ] && VERSION="18.5"
          echo "SIMULATOR_UDID=$UDID" >> $GITHUB_ENV
          echo "DEVICE_NAME=$DEVICE" >> $GITHUB_ENV
          echo "PLATFORM_VERSION=$VERSION" >> $GITHUB_ENV
      - name: Pre-install App
        run: xcrun simctl install "${{ env.SIMULATOR_UDID }}" "apps/Z Platform-QA.app"
      - name: Pre-build WDA
        run: |
          WDA_PATH=$(find ~/.appium -name "WebDriverAgent.xcodeproj" -type f 2>/dev/null | head -1 | xargs dirname)
          [ -n "$WDA_PATH" ] && cd "$WDA_PATH" && xcodebuild build-for-testing -project WebDriverAgent.xcodeproj -scheme WebDriverAgentRunner -destination "platform=iOS Simulator,id=${{ env.SIMULATOR_UDID }}" -derivedDataPath /tmp/wda-build -quiet || true
      - name: Start Appium
        run: |
          appium --relaxed-security --log-level info > appium.log 2>&1 &
          for i in {1..60}; do [ "$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:4723/status 2>/dev/null)" = "200" ] && break; sleep 2; done
          sleep 10
      - name: Warm-up WDA
        run: |
          for attempt in 1 2 3; do
            RESP=$(curl -s -X POST http://127.0.0.1:4723/session -H "Content-Type: application/json" -d '{"capabilities":{"alwaysMatch":{"platformName":"iOS","appium:automationName":"XCUITest","appium:deviceName":"'"${{ env.DEVICE_NAME }}"'","appium:udid":"'"${{ env.SIMULATOR_UDID }}"'","appium:platformVersion":"'"${{ env.PLATFORM_VERSION }}"'","appium:app":"'"${{ github.workspace }}/apps/Z Platform-QA.app"'","appium:wdaLaunchTimeout":600000,"appium:wdaConnectionTimeout":300000,"appium:useNewWDA":false,"appium:noReset":false}}}' --max-time 600 2>&1) || true
            SID=$(echo "$RESP" | grep -o '"sessionId":"[^"]*"' | cut -d'"' -f4 || true)
            [ -n "$SID" ] && sleep 10 && curl -s -X DELETE "http://127.0.0.1:4723/session/$SID" || true && break
            [ $attempt -lt 3 ] && sleep 30
          done
      - name: Run Phase 3 Tests
        continue-on-error: true
        run: |
          mvn test -DsuiteXmlFile=src/test/resources/parallel/testng-phase3.xml \
            -DDEVICE_NAME="${{ env.DEVICE_NAME }}" \
            -DPLATFORM_VERSION="${{ env.PLATFORM_VERSION }}" \
            -DSIMULATOR_UDID="${{ env.SIMULATOR_UDID }}" \
            -DAPP_PATH="${{ github.workspace }}/apps/Z Platform-QA.app"
      - name: Upload Phase 3 Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: asset-phase3-report
          path: |
            target/surefire-reports/
            reports/
            screenshots/
          retention-days: 7

  # ========================================
  # JOB 4: Phase 4 Tests (141 tests, ~4 hr)
  # ========================================
  phase4-tests:
    runs-on: macos-15
    timeout-minutes: 359
    
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Install Appium
        run: |
          npm install -g appium@next
          appium driver install xcuitest
      - name: Unzip App
        run: unzip -o apps/Z-Platform-QA.zip -d apps/
      - name: Boot Simulator
        run: |
          UDID=$(xcrun simctl list devices available | grep -A 100 "iOS 18" | grep "iPhone 16 Pro" | head -1 | awk -F '[()]' '{print $2}')
          [ -z "$UDID" ] && UDID=$(xcrun simctl list devices available | grep -E "iPhone 16 Pro" | head -1 | awk -F '[()]' '{print $2}')
          [ -z "$UDID" ] && UDID=$(xcrun simctl list devices available | grep -E "iPhone 1[5-6]" | head -1 | awk -F '[()]' '{print $2}')
          [ -z "$UDID" ] && exit 1
          xcrun simctl shutdown "$UDID" 2>/dev/null || true
          sleep 3
          xcrun simctl boot "$UDID" 2>/dev/null || true
          ELAPSED=0
          while [ $ELAPSED -lt 240 ]; do
            xcrun simctl list devices | grep "$UDID" | grep -q "(Booted)" && sleep 45 && break
            sleep 5
            ELAPSED=$((ELAPSED + 5))
          done
          [ $ELAPSED -ge 240 ] && exit 1
          DEVICE=$(xcrun simctl list devices available | grep "$UDID" | awk -F '(' '{print $1}' | xargs)
          VERSION=$(xcrun simctl list devices available | grep -B 50 "$UDID" | grep "-- iOS" | tail -1 | sed 's/.*iOS \([0-9.]*\).*/\1/')
          [ -z "$VERSION" ] && VERSION="18.5"
          echo "SIMULATOR_UDID=$UDID" >> $GITHUB_ENV
          echo "DEVICE_NAME=$DEVICE" >> $GITHUB_ENV
          echo "PLATFORM_VERSION=$VERSION" >> $GITHUB_ENV
      - name: Pre-install App
        run: xcrun simctl install "${{ env.SIMULATOR_UDID }}" "apps/Z Platform-QA.app"
      - name: Pre-build WDA
        run: |
          WDA_PATH=$(find ~/.appium -name "WebDriverAgent.xcodeproj" -type f 2>/dev/null | head -1 | xargs dirname)
          [ -n "$WDA_PATH" ] && cd "$WDA_PATH" && xcodebuild build-for-testing -project WebDriverAgent.xcodeproj -scheme WebDriverAgentRunner -destination "platform=iOS Simulator,id=${{ env.SIMULATOR_UDID }}" -derivedDataPath /tmp/wda-build -quiet || true
      - name: Start Appium
        run: |
          appium --relaxed-security --log-level info > appium.log 2>&1 &
          for i in {1..60}; do [ "$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:4723/status 2>/dev/null)" = "200" ] && break; sleep 2; done
          sleep 10
      - name: Warm-up WDA
        run: |
          for attempt in 1 2 3; do
            RESP=$(curl -s -X POST http://127.0.0.1:4723/session -H "Content-Type: application/json" -d '{"capabilities":{"alwaysMatch":{"platformName":"iOS","appium:automationName":"XCUITest","appium:deviceName":"'"${{ env.DEVICE_NAME }}"'","appium:udid":"'"${{ env.SIMULATOR_UDID }}"'","appium:platformVersion":"'"${{ env.PLATFORM_VERSION }}"'","appium:app":"'"${{ github.workspace }}/apps/Z Platform-QA.app"'","appium:wdaLaunchTimeout":600000,"appium:wdaConnectionTimeout":300000,"appium:useNewWDA":false,"appium:noReset":false}}}' --max-time 600 2>&1) || true
            SID=$(echo "$RESP" | grep -o '"sessionId":"[^"]*"' | cut -d'"' -f4 || true)
            [ -n "$SID" ] && sleep 10 && curl -s -X DELETE "http://127.0.0.1:4723/session/$SID" || true && break
            [ $attempt -lt 3 ] && sleep 30
          done
      - name: Run Phase 4 Tests
        continue-on-error: true
        run: |
          mvn test -DsuiteXmlFile=src/test/resources/parallel/testng-phase4.xml \
            -DDEVICE_NAME="${{ env.DEVICE_NAME }}" \
            -DPLATFORM_VERSION="${{ env.PLATFORM_VERSION }}" \
            -DSIMULATOR_UDID="${{ env.SIMULATOR_UDID }}" \
            -DAPP_PATH="${{ github.workspace }}/apps/Z Platform-QA.app"
      - name: Upload Phase 4 Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: asset-phase4-report
          path: |
            target/surefire-reports/
            reports/
            screenshots/
          retention-days: 7

  # ========================================
  # JOB 5: Phase 5 Tests (45 tests, ~1.5 hr)
  # ========================================
  phase5-tests:
    runs-on: macos-15
    timeout-minutes: 359
    
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Install Appium
        run: |
          npm install -g appium@next
          appium driver install xcuitest
      - name: Unzip App
        run: unzip -o apps/Z-Platform-QA.zip -d apps/
      - name: Boot Simulator
        run: |
          UDID=$(xcrun simctl list devices available | grep -A 100 "iOS 18" | grep "iPhone 16 Pro" | head -1 | awk -F '[()]' '{print $2}')
          [ -z "$UDID" ] && UDID=$(xcrun simctl list devices available | grep -E "iPhone 16 Pro" | head -1 | awk -F '[()]' '{print $2}')
          [ -z "$UDID" ] && UDID=$(xcrun simctl list devices available | grep -E "iPhone 1[5-6]" | head -1 | awk -F '[()]' '{print $2}')
          [ -z "$UDID" ] && exit 1
          xcrun simctl shutdown "$UDID" 2>/dev/null || true
          sleep 3
          xcrun simctl boot "$UDID" 2>/dev/null || true
          ELAPSED=0
          while [ $ELAPSED -lt 240 ]; do
            xcrun simctl list devices | grep "$UDID" | grep -q "(Booted)" && sleep 45 && break
            sleep 5
            ELAPSED=$((ELAPSED + 5))
          done
          [ $ELAPSED -ge 240 ] && exit 1
          DEVICE=$(xcrun simctl list devices available | grep "$UDID" | awk -F '(' '{print $1}' | xargs)
          VERSION=$(xcrun simctl list devices available | grep -B 50 "$UDID" | grep "-- iOS" | tail -1 | sed 's/.*iOS \([0-9.]*\).*/\1/')
          [ -z "$VERSION" ] && VERSION="18.5"
          echo "SIMULATOR_UDID=$UDID" >> $GITHUB_ENV
          echo "DEVICE_NAME=$DEVICE" >> $GITHUB_ENV
          echo "PLATFORM_VERSION=$VERSION" >> $GITHUB_ENV
      - name: Pre-install App
        run: xcrun simctl install "${{ env.SIMULATOR_UDID }}" "apps/Z Platform-QA.app"
      - name: Pre-build WDA
        run: |
          WDA_PATH=$(find ~/.appium -name "WebDriverAgent.xcodeproj" -type f 2>/dev/null | head -1 | xargs dirname)
          [ -n "$WDA_PATH" ] && cd "$WDA_PATH" && xcodebuild build-for-testing -project WebDriverAgent.xcodeproj -scheme WebDriverAgentRunner -destination "platform=iOS Simulator,id=${{ env.SIMULATOR_UDID }}" -derivedDataPath /tmp/wda-build -quiet || true
      - name: Start Appium
        run: |
          appium --relaxed-security --log-level info > appium.log 2>&1 &
          for i in {1..60}; do [ "$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:4723/status 2>/dev/null)" = "200" ] && break; sleep 2; done
          sleep 10
      - name: Warm-up WDA
        run: |
          for attempt in 1 2 3; do
            RESP=$(curl -s -X POST http://127.0.0.1:4723/session -H "Content-Type: application/json" -d '{"capabilities":{"alwaysMatch":{"platformName":"iOS","appium:automationName":"XCUITest","appium:deviceName":"'"${{ env.DEVICE_NAME }}"'","appium:udid":"'"${{ env.SIMULATOR_UDID }}"'","appium:platformVersion":"'"${{ env.PLATFORM_VERSION }}"'","appium:app":"'"${{ github.workspace }}/apps/Z Platform-QA.app"'","appium:wdaLaunchTimeout":600000,"appium:wdaConnectionTimeout":300000,"appium:useNewWDA":false,"appium:noReset":false}}}' --max-time 600 2>&1) || true
            SID=$(echo "$RESP" | grep -o '"sessionId":"[^"]*"' | cut -d'"' -f4 || true)
            [ -n "$SID" ] && sleep 10 && curl -s -X DELETE "http://127.0.0.1:4723/session/$SID" || true && break
            [ $attempt -lt 3 ] && sleep 30
          done
      - name: Run Phase 5 Tests
        continue-on-error: true
        run: |
          mvn test -DsuiteXmlFile=src/test/resources/parallel/testng-phase5.xml \
            -DDEVICE_NAME="${{ env.DEVICE_NAME }}" \
            -DPLATFORM_VERSION="${{ env.PLATFORM_VERSION }}" \
            -DSIMULATOR_UDID="${{ env.SIMULATOR_UDID }}" \
            -DAPP_PATH="${{ github.workspace }}/apps/Z Platform-QA.app"
      - name: Upload Phase 5 Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: asset-phase5-report
          path: |
            target/surefire-reports/
            reports/
            screenshots/
          retention-days: 7

  # ========================================
  # FINAL JOB: Send Email (Asset Tests)
  # ========================================
  send-email:
    needs: [phase1-tests, phase2-tests, phase3-tests, phase4-tests, phase5-tests]
    if: always()
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Download All Reports
        uses: actions/download-artifact@v4
        with:
          path: all-reports
        continue-on-error: true

      - name: Prepare Email Summary
        id: email
        run: |
          P1="${{ needs.phase1-tests.result }}"
          P2="${{ needs.phase2-tests.result }}"
          P3="${{ needs.phase3-tests.result }}"
          P4="${{ needs.phase4-tests.result }}"
          P5="${{ needs.phase5-tests.result }}"
          
          SUCCESS=0
          [ "$P1" = "success" ] && SUCCESS=$((SUCCESS+1))
          [ "$P2" = "success" ] && SUCCESS=$((SUCCESS+1))
          [ "$P3" = "success" ] && SUCCESS=$((SUCCESS+1))
          [ "$P4" = "success" ] && SUCCESS=$((SUCCESS+1))
          [ "$P5" = "success" ] && SUCCESS=$((SUCCESS+1))
          
          FAILED=$((5-SUCCESS))
          echo "SUCCESS=$SUCCESS" >> $GITHUB_OUTPUT
          echo "FAILED=$FAILED" >> $GITHUB_OUTPUT
          
          if [ $SUCCESS -eq 5 ]; then
            STATUS="âœ… ALL PASSED"
          else
            STATUS="âŒ FAILED"
          fi
          echo "STATUS=$STATUS" >> $GITHUB_OUTPUT
          
          cat > email_body.html << EMAILEOF
          <!DOCTYPE html>
          <html>
          <body style="font-family: Arial, sans-serif; padding: 20px; max-width: 700px; margin: 0 auto;">
            <h1 style="color: #333;">ğŸ“¦ Asset Tests Results (Phase 1-5)</h1>
            <p><b>Branch:</b> ${{ github.ref_name }}</p>
            <p><b>Commit:</b> ${{ github.sha }}</p>
            <p><b>Run:</b> <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">View Details</a></p>
            <hr>
            
            <h2>${STATUS} - ${SUCCESS}/5 Jobs Passed</h2>
            
            <table border="1" cellpadding="10" style="border-collapse: collapse; width: 100%;">
              <tr style="background-color: #4a90d9; color: white;">
                <th>Job</th>
                <th>Tests</th>
                <th>Status</th>
              </tr>
              <tr><td>Phase 1 Tests</td><td>139</td><td>${P1}</td></tr>
              <tr><td>Phase 2 Tests</td><td>159</td><td>${P2}</td></tr>
              <tr><td>Phase 3 Tests</td><td>169</td><td>${P3}</td></tr>
              <tr><td>Phase 4 Tests</td><td>141</td><td>${P4}</td></tr>
              <tr><td>Phase 5 Tests</td><td>45</td><td>${P5}</td></tr>
            </table>
            
            <p style="margin-top: 20px; color: #666; font-size: 12px;">
              Asset Tests - All 5 Phases (653 total tests)<br>
              Core Tests (Auth + Site) run in a separate workflow.
            </p>
          </body>
          </html>
          EMAILEOF

      - name: Send Email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "[${{ steps.email.outputs.STATUS }}] Asset Tests - ${{ steps.email.outputs.SUCCESS }}/5 Passed"
          html_body: file://email_body.html
          to: ${{ secrets.EMAIL_TO }}
          from: "iOS Automation <${{ secrets.EMAIL_USERNAME }}>"
        continue-on-error: true

      - name: Summary
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘          ASSET TESTS COMPLETE                                   â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“Š Results: ${{ steps.email.outputs.SUCCESS }}/5 Jobs Passed"
          echo "   Phase 1 Tests (139):  ${{ needs.phase1-tests.result }}"
          echo "   Phase 2 Tests (159):  ${{ needs.phase2-tests.result }}"
          echo "   Phase 3 Tests (169):  ${{ needs.phase3-tests.result }}"
          echo "   Phase 4 Tests (141):  ${{ needs.phase4-tests.result }}"
          echo "   Phase 5 Tests (45):   ${{ needs.phase5-tests.result }}"
