name: iOS Automation Tests

on:
  push:
    branches:
      - main
      - develop
  workflow_dispatch:

jobs:
  ios-test:
    runs-on: macos-15
    timeout-minutes: 1800

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Appium
        run: |
          npm install -g appium@next
          appium driver install xcuitest

      - name: Unzip App
        run: |
          unzip -o apps/Z-Platform-QA.zip -d apps/
          ls -la apps/

      - name: Boot Simulator and Wait Until Ready
        run: |
          echo "=== Available Simulators ==="
          xcrun simctl list devices available

          # Get iPhone 16 Pro with iOS 18.5 specifically
          # The app requires iOS 18.5, so we must use that version
          UDID=$(xcrun simctl list devices available | grep -A 100 "iOS 18.5" | grep "iPhone 16 Pro" | head -1 | awk -F '[()]' '{print $2}')
          echo "Selected UDID: $UDID"

          if [ -z "$UDID" ]; then
            echo "❌ No iPhone 16 Pro with iOS 18.5 found!"
            exit 1
          fi

          # Shutdown any existing state
          echo "Cleaning up simulator state..."
          xcrun simctl shutdown "$UDID" 2>/dev/null || true
          sleep 3

          # Boot the simulator
          echo "Booting simulator..."
          xcrun simctl boot "$UDID" 2>/dev/null || true

          # Wait for simulator to boot
          echo "Waiting for simulator to boot..."
          BOOT_TIMEOUT=240
          ELAPSED=0
          while [ $ELAPSED -lt $BOOT_TIMEOUT ]; do
            if xcrun simctl list devices | grep "$UDID" | grep -q "(Booted)"; then
              echo "✅ Simulator is in Booted state after ${ELAPSED}s"
              echo "Waiting 45s for system services to stabilize..."
              sleep 45
              echo "✅ Simulator ready!"
              break
            fi
            echo "Waiting for boot... (${ELAPSED}s/${BOOT_TIMEOUT}s)"
            sleep 5
            ELAPSED=$((ELAPSED + 5))
          done

          if [ $ELAPSED -ge $BOOT_TIMEOUT ]; then
            echo "❌ Simulator failed to boot within ${BOOT_TIMEOUT}s"
            xcrun simctl list devices | grep "$UDID"
            exit 1
          fi

          # Get device name
          DEVICE=$(xcrun simctl list devices available | grep "$UDID" | awk -F '(' '{print $1}' | xargs)

          # Set iOS version directly since we know we selected iOS 18.5
          VERSION="18.5"

          echo "SIMULATOR_UDID=$UDID" >> $GITHUB_ENV
          echo "DEVICE_NAME=$DEVICE" >> $GITHUB_ENV
          echo "PLATFORM_VERSION=$VERSION" >> $GITHUB_ENV

          echo ""
          echo "=== Final Configuration ==="
          echo "Device: $DEVICE"
          echo "UDID: $UDID"
          echo "iOS: $VERSION"

      - name: Pre-install App on Simulator
        run: |
          echo "Installing app on simulator..."
          xcrun simctl install "${{ env.SIMULATOR_UDID }}" "apps/Z Platform-QA.app"
          echo "✅ App pre-installed"

      - name: Start Appium Server
        run: |
          echo "Starting Appium..."
          appium --relaxed-security --log-level info &
          for i in {1..30}; do
            if curl -s http://127.0.0.1:4723/status > /dev/null; then
              echo "✅ Appium ready"
              break
            fi
            echo "Waiting for Appium... ($i/30)"
            sleep 2
          done

      - name: Run Tests
        id: run_tests
        continue-on-error: true
        env:
          SIMULATOR_UDID: ${{ env.SIMULATOR_UDID }}
          PLATFORM_VERSION: ${{ env.PLATFORM_VERSION }}
          DEVICE_NAME: ${{ env.DEVICE_NAME }}
          APP_PATH: ${{ github.workspace }}/apps/Z Platform-QA.app
        run: |
          echo "=== Test Configuration ==="
          echo "Device: $DEVICE_NAME"
          echo "iOS: $PLATFORM_VERSION"
          echo "UDID: $SIMULATOR_UDID"
          echo "App: $APP_PATH"

          mvn clean test \
            -Ddevice.name="$DEVICE_NAME" \
            -Dplatform.version="$PLATFORM_VERSION" \
            -Ddevice.udid="$SIMULATOR_UDID" \
            -Dapp.path="$APP_PATH"

      - name: Capture Test Results
        if: always()
        id: test_results
        run: |
          # Check if surefire reports exist
          if [ -d "target/surefire-reports" ]; then
            # Extract test results from surefire
            TOTAL=$(grep -r "tests=" target/surefire-reports/*.xml 2>/dev/null | head -1 | sed 's/.*tests="\([0-9]*\)".*/\1/' || echo "0")
            FAILURES=$(grep -r "failures=" target/surefire-reports/*.xml 2>/dev/null | head -1 | sed 's/.*failures="\([0-9]*\)".*/\1/' || echo "0")
            ERRORS=$(grep -r "errors=" target/surefire-reports/*.xml 2>/dev/null | head -1 | sed 's/.*errors="\([0-9]*\)".*/\1/' || echo "0")
            SKIPPED=$(grep -r "skipped=" target/surefire-reports/*.xml 2>/dev/null | head -1 | sed 's/.*skipped="\([0-9]*\)".*/\1/' || echo "0")
            
            echo "TOTAL_TESTS=$TOTAL" >> $GITHUB_ENV
            echo "FAILED_TESTS=$FAILURES" >> $GITHUB_ENV
            echo "ERROR_TESTS=$ERRORS" >> $GITHUB_ENV
            echo "SKIPPED_TESTS=$SKIPPED" >> $GITHUB_ENV
            
            if [ "$FAILURES" -gt 0 ] || [ "$ERRORS" -gt 0 ]; then
              echo "TEST_STATUS=FAILED" >> $GITHUB_ENV
            else
              echo "TEST_STATUS=PASSED" >> $GITHUB_ENV
            fi
          else
            echo "TEST_STATUS=NO_RESULTS" >> $GITHUB_ENV
            echo "TOTAL_TESTS=0" >> $GITHUB_ENV
            echo "FAILED_TESTS=0" >> $GITHUB_ENV
            echo "ERROR_TESTS=0" >> $GITHUB_ENV
            echo "SKIPPED_TESTS=0" >> $GITHUB_ENV
          fi

      - name: Upload Test Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: |
            target/surefire-reports/
            reports/

      - name: Send Email Notification
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          secure: true
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "[${{ env.TEST_STATUS }}] iOS Automation Test Results - ${{ github.repository }}"
          to: ${{ secrets.EMAIL_TO }}
          from: "iOS Automation <${{ secrets.EMAIL_USERNAME }}>"
          body: |
            iOS Automation Test Results
            ============================
            
            Repository: ${{ github.repository }}
            Branch: ${{ github.ref_name }}
            Commit: ${{ github.sha }}
            Triggered by: ${{ github.actor }}
            
            Test Status: ${{ env.TEST_STATUS }}
            
            Test Summary:
            - Total Tests: ${{ env.TOTAL_TESTS }}
            - Failed: ${{ env.FAILED_TESTS }}
            - Errors: ${{ env.ERROR_TESTS }}
            - Skipped: ${{ env.SKIPPED_TESTS }}
            
            Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            Download test reports from the workflow artifacts.

      - name: Fail job if tests failed
        if: steps.run_tests.outcome == 'failure'
        run: |
          echo "Tests failed - marking job as failed"
          exit 1
