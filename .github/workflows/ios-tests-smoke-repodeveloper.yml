name: Automation Test

# ============================================================
# DEVELOPER REPO - SINGLE RUNNER TEST SUITE
# ============================================================
# Builds iOS app from selected branch, then runs the chosen
# test module on a single macOS runner.
#
# Architecture:
#
#   â”€â”€ Run All â”€â”€
#   all                       â†’ Run ALL test suites sequentially (~1158 tests, single runner)
#
#   â”€â”€ Smoke (CRUD modules) â”€â”€
#   smoke                     â†’ Full Smoke Dashboard â€” all 7 modules with live progress (~1 hr)
#   smoke-login               â†’ Login flow (1 test)
#   smoke-site-selection      â†’ Site selection flow (1 test)
#   smoke-asset-crud          â†’ Asset Create + Read + Edit + Delete (4 tests)
#   smoke-location-crud       â†’ Location Create + Read + Edit + Delete (4 tests)
#   smoke-connection-crud     â†’ Connection Create + Read + Delete (3 tests)
#   smoke-issue-crud          â†’ Issue Create + Read + Details + Delete (4 tests)
#
#   â”€â”€ Full Test Suites (individual) â”€â”€
#   authentication-only       â†’ Authentication (38 tests)
#   site-selection-only       â†’ Site Selection (52 tests)
#   assets-p1-*               â†’ P1: Creation + Edit + Busway + Capacitor + Bug Tests (112 tests)
#   assets-p2-*               â†’ P1: CB + DS + Fuse + P2: Generator + Junction Box (108 tests)
#   assets-p3-*               â†’ P2: Load Center + MCC + MCC Bucket + Motor + Other (109 tests)
#   assets-p4-*               â†’ P2: OCP + P3: Panelboard + PDU + Relay + SWB + Transformer (97 tests)
#   assets-p5-*               â†’ P3: UPS + Utility + VFD + Subtypes + P4: DS/Fuse Subtypes (112 tests)
#   assets-p6-*               â†’ P4: Subtypes + Tasks + Issues + Connections + Asset Screen (114 tests)
#   issues-p1-*               â†’ Issues Phase 1: List + Filter + Search + Creation + Class Change (119 tests)
#   issues-p2-*               â†’ Issues Phase 2: OSHA + Thermal + Severity + Temperature + Ultrasonic (118 tests)
#   location-only             â†’ Locations (82 tests)
#   connections-only          â†’ Connections (94 tests)
#
# S3 Drift Detection (branch-based):
#   release/dev       â†’ dev S3 only         (10 tests)  â†’ Total 27
#   release/qa        â†’ qa S3 only          (10 tests)  â†’ Total 27
#   release/stage     â†’ staging S3 only     (10 tests)  â†’ Total 27
#   release/prod      â†’ prod + bces-iq      (18 tests)  â†’ Total 35
#   main              â†’ prod + bces-iq      (18 tests)  â†’ Total 35
#
# Requirements:
#   Secrets: QA_REPO_TOKEN, AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY
# ============================================================

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to build and test'
        required: true
        default: 'release/qa'
        type: choice
        options:
          - main
          - release/dev
          - release/qa
          - release/stage
          - release/prod
      test_suite:
        description: 'Which tests to run?'
        required: true
        default: 'smoke'
        type: choice
        options:
          - 'all'
          - 'smoke'
          - 'smoke-login'
          - 'smoke-site-selection'
          - 'smoke-asset-crud'
          - 'smoke-location-crud'
          - 'smoke-connection-crud'
          - 'smoke-issue-crud'
          - 'authentication-only'
          - 'site-selection-only'
          - 'assets-p1-creation-edit-busway-capacitor-bug'
          - 'assets-p2-cb-ds-fuse-generator-junctionbox'
          - 'assets-p3-loadcenter-mcc-mccbucket-motor-other'
          - 'assets-p4-ocp-panelboard-pdu-relay-swb-transformer'
          - 'assets-p5-ups-utility-vfd-subtypes'
          - 'assets-p6-subtypes-tasks-issues-connections-search'
          - 'issues-p1-list-filter-search-creation-classchange'
          - 'issues-p2-osha-thermal-severity-temperature-ultrasonic'
          - 'location-only'
          - 'connections-only'
      capture_api:
        description: 'Capture API traffic for debugging'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  build-and-test:
    runs-on: macos-15
    timeout-minutes: 480

    steps:
      # ============================================================
      # STEP 1: Checkout iOS App Code (Selected Branch)
      # ============================================================
      - name: Checkout iOS App Repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch }}
          path: ios-app

      # ============================================================
      # STEP 2: Checkout QA Automation Code
      # ============================================================
      - name: Checkout QA Automation Repository
        uses: actions/checkout@v4
        with:
          repository: eg-abhiyantsingh/iOS_automation_site
          token: ${{ secrets.QA_REPO_TOKEN }}
          path: qa-automation

      # ============================================================
      # STEP 3: Set Build Configuration
      # ============================================================
      - name: Set Build Configuration
        run: |
          BRANCH="${{ github.event.inputs.branch }}"

          case "$BRANCH" in
            release/dev)     SCHEME="Egalvanic PZ-Dev" ;;
            release/qa)      SCHEME="Egalvanic PZ-QA" ;;
            release/stage*)  SCHEME="Egalvanic PZ-Staging" ;;
            release/prod|main) SCHEME="Egalvanic PZ" ;;
            *)               SCHEME="Egalvanic PZ-QA" ;;
          esac

          XCODEPROJ=$(find ios-app -name "*.xcodeproj" -type d | head -1)
          SAFE_BRANCH=$(echo "$BRANCH" | tr '/' '-')

          echo "BUILD_SCHEME=$SCHEME" >> $GITHUB_ENV
          echo "XCODEPROJ_PATH=$XCODEPROJ" >> $GITHUB_ENV
          echo "SAFE_BRANCH=$SAFE_BRANCH" >> $GITHUB_ENV

          echo "ðŸ“± Branch: $BRANCH | Scheme: $SCHEME"

      # ============================================================
      # STEP 3.5: Detect S3 Drift Environment (branch-based)
      # ============================================================
      - name: Detect S3 Drift Environment
        run: |
          BRANCH="${{ github.event.inputs.branch }}"
          
          echo "Branch: $BRANCH"
          
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # Developer Branch â†’ S3 Environment Mapping
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # release/dev       â†’ dev only         (10 S3 tests)
          # release/qa        â†’ qa only          (10 S3 tests)
          # release/stage     â†’ staging only     (10 S3 tests)
          # release/prod      â†’ prod + bces-iq   (18 S3 tests)
          # main              â†’ prod + bces-iq   (18 S3 tests)
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          
          case "$BRANCH" in
            release/dev)
              S3_ENV="dev"
              S3_XML="src/test/resources/smoke/testng-smoke-s3drift-dev.xml"
              S3_TESTS=10
              S3_LABEL="DEV only" ;;
            release/qa)
              S3_ENV="qa"
              S3_XML="src/test/resources/smoke/testng-smoke-s3drift-qa.xml"
              S3_TESTS=10
              S3_LABEL="QA only" ;;
            release/stage*)
              S3_ENV="staging"
              S3_XML="src/test/resources/smoke/testng-smoke-s3drift-staging.xml"
              S3_TESTS=10
              S3_LABEL="STAGING only" ;;
            release/prod)
              S3_ENV="production"
              S3_XML="src/test/resources/smoke/testng-smoke-s3drift-production.xml"
              S3_TESTS=18
              S3_LABEL="PRODUCTION (prod + bces-iq)" ;;
            main)
              S3_ENV="production"
              S3_XML="src/test/resources/smoke/testng-smoke-s3drift-production.xml"
              S3_TESTS=18
              S3_LABEL="PRODUCTION (prod + bces-iq)" ;;
            *)
              S3_ENV="all"
              S3_XML="src/test/resources/smoke/testng-smoke-s3drift.xml"
              S3_TESTS=42
              S3_LABEL="ALL (5 environments)" ;;
          esac
          
          # S3 (dynamic) + 17 mobile tests:
          # 1 Login + 1 Site + 4 Asset + 4 Location + 3 Connection + 4 Issue CRUD = 17
          TOTAL_SMOKE_TESTS=$((S3_TESTS + 17))
          
          echo "S3_ENV=$S3_ENV" >> $GITHUB_ENV
          echo "S3_XML=$S3_XML" >> $GITHUB_ENV
          echo "S3_TESTS=$S3_TESTS" >> $GITHUB_ENV
          echo "S3_LABEL=$S3_LABEL" >> $GITHUB_ENV
          echo "TOTAL_SMOKE_TESTS=$TOTAL_SMOKE_TESTS" >> $GITHUB_ENV
          
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ðŸŒ¿ Branch:           $BRANCH"
          echo "â•‘  ðŸª£ S3 Environment:   $S3_LABEL"
          echo "â•‘  ðŸ§ª S3 Tests:         $S3_TESTS"
          echo "â•‘  ðŸ“Š Total Smoke:      $TOTAL_SMOKE_TESTS tests"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      # ============================================================
      # STEP 4: Setup Build Environment
      # ============================================================
      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install Appium
        run: |
          npm install -g appium@latest 2>&1 | tail -1
          appium driver install xcuitest 2>&1 | tail -1
          echo "âœ… Appium $(appium --version)"

      - name: Setup API Capture
        if: github.event.inputs.capture_api != 'false'
        run: |
          brew install mitmproxy 2>&1 | tail -3
          mkdir -p qa-automation/reports/api_logs qa-automation/scripts

          cat > qa-automation/scripts/parse_api.py << 'PYSCRIPT'
          import json, sys, os
          def main(flow_file):
              failed, total = [], 0
              try:
                  from mitmproxy import io as mitmio
                  with open(flow_file, "rb") as f:
                      for flow in mitmio.FlowReader(f).stream():
                          if hasattr(flow, 'response') and flow.response:
                              total += 1
                              if flow.response.status_code >= 400:
                                  failed.append({
                                      "status": flow.response.status_code,
                                      "method": flow.request.method,
                                      "url": flow.request.pretty_url,
                                      "response": (flow.response.get_text() or "")[:500]
                                  })
              except Exception as e:
                  print(f"Error: {e}")
                  return
              print(f"\n{'='*60}\nAPI REPORT: {total} calls, {len(failed)} failed\n{'='*60}")
              if failed:
                  print("âŒ FAILED APIs:")
                  for api in failed:
                      print(f"  [{api['status']}] {api['method']} {api['url']}")
              else:
                  print("âœ… All APIs successful!")
              os.makedirs("qa-automation/reports/api_logs", exist_ok=True)
              with open("qa-automation/reports/api_logs/failed_apis.json", "w") as f:
                  json.dump({"total": total, "failed": len(failed), "details": failed}, f, indent=2)
          if __name__ == "__main__":
              main(sys.argv[1] if len(sys.argv) > 1 else "api_traffic.flow")
          PYSCRIPT
          echo "âœ… API capture ready"

      # ============================================================
      # STEP 5: Boot Simulator
      # ============================================================
      - name: Boot Simulator
        run: |
          # Find best available iPhone simulator
          UDID=""
          for VERSION in 18.5 18.4 18.3 18.2 18.1 18.0; do
            for MODEL in "iPhone 16 Pro" "iPhone 15 Pro" "iPhone"; do
              UDID=$(xcrun simctl list devices available | grep -A 100 "iOS $VERSION" | grep "$MODEL" | head -1 | awk -F '[()]' '{print $2}')
              [ -n "$UDID" ] && break 2
            done
          done

          if [ -z "$UDID" ]; then
            echo "âŒ No iPhone simulator found!"
            xcrun simctl list devices available
            exit 1
          fi

          DEVICE_NAME=$(xcrun simctl list devices available | grep "$UDID" | sed 's/(.*//' | xargs)
          PLATFORM_VERSION=$(xcrun simctl list devices available | grep -B 20 "$UDID" | grep "iOS" | tail -1 | sed 's/-- iOS //' | sed 's/ --.*//')
          [ -z "$PLATFORM_VERSION" ] && PLATFORM_VERSION="18.5"

          echo "DEVICE_NAME=$DEVICE_NAME" >> $GITHUB_ENV
          echo "SIMULATOR_UDID=$UDID" >> $GITHUB_ENV
          echo "PLATFORM_VERSION=$PLATFORM_VERSION" >> $GITHUB_ENV
          echo "ðŸ“± $DEVICE_NAME | iOS $PLATFORM_VERSION | $UDID"

          # Boot with proper (Booted) check
          xcrun simctl shutdown "$UDID" 2>/dev/null || true
          sleep 3
          xcrun simctl boot "$UDID" 2>/dev/null || true

          TIMEOUT=120
          ELAPSED=0
          while [ $ELAPSED -lt $TIMEOUT ]; do
            if xcrun simctl list devices | grep "$UDID" | grep -q "(Booted)"; then
              echo "âœ… Booted after ${ELAPSED}s"
              break
            fi
            sleep 5
            ELAPSED=$((ELAPSED + 5))
          done

          [ $ELAPSED -ge $TIMEOUT ] && echo "âŒ Boot timeout" && exit 1

          # Post-boot stabilization (matches ios-tests.yml)
          sleep 45
          echo "âœ… Simulator ready"

      # ============================================================
      # STEP 6: Build iOS App from Source
      # ============================================================
      - name: Resolve Swift Package Dependencies
        run: |
          cd ios-app
          PROJECT_FILE=$(basename "$XCODEPROJ_PATH")
          xcodebuild -resolvePackageDependencies \
            -project "$PROJECT_FILE" \
            -scheme "${{ env.BUILD_SCHEME }}" \
            -clonedSourcePackagesDirPath ../spm-cache \
            -quiet 2>&1 | tail -3
          echo "âœ… Dependencies resolved"

      - name: Build iOS App for Simulator
        run: |
          cd ios-app
          PROJECT_FILE=$(basename "$XCODEPROJ_PATH")

          echo "ðŸ”¨ Building: ${{ env.BUILD_SCHEME }} from ${{ github.event.inputs.branch }}"

          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # FIX: Removed CODE_SIGNING_ALLOWED=NO
          #
          # CODE_SIGNING_ALLOWED=NO prevents ALL code signing, which
          # causes iOS Keychain to silently reject token saves.
          # Result: Login API succeeds â†’ token save fails â†’ app shows
          # "Not authenticated" on next API call.
          #
          # CODE_SIGN_IDENTITY="-" gives ad-hoc signing â€” enough for
          # simulator Keychain operations to work correctly.
          #
          # Also removed "-configuration Debug" flag â€” the scheme
          # "Egalvanic PZ-QA" has buildConfiguration = "Debug-QA".
          # Passing "-configuration Debug" overrides the scheme and
          # uses the wrong config (which builds PROD app).
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

          xcodebuild build \
            -project "$PROJECT_FILE" \
            -scheme "${{ env.BUILD_SCHEME }}" \
            -destination "platform=iOS Simulator,id=${{ env.SIMULATOR_UDID }}" \
            -derivedDataPath build \
            -clonedSourcePackagesDirPath ../spm-cache \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=NO \
            -quiet 2>&1 | tail -5

          APP_PATH=$(find build -name "*.app" -type d | head -1)

          if [ -z "$APP_PATH" ]; then
            echo "âŒ Build failed! No .app found"
            find build -type d | head -20
            exit 1
          fi

          echo "APP_PATH=$APP_PATH" >> $GITHUB_ENV
          echo "âœ… Built: $(basename "$APP_PATH")"

          mkdir -p ../qa-automation/apps
          cp -R "$APP_PATH" "../qa-automation/apps/"

      # ============================================================
      # STEP 6.5: Verify Built App Configuration
      # ============================================================
      - name: Verify App Configuration
        run: |
          APP_FILE=$(ls qa-automation/apps/ | grep ".app" | head -1)
          APP="qa-automation/apps/$APP_FILE"

          if [ -f "$APP/Info.plist" ]; then
            echo "â”€â”€â”€ Built App Config â”€â”€â”€"
            echo "  Bundle ID:    $(/usr/libexec/PlistBuddy -c 'Print :CFBundleIdentifier' "$APP/Info.plist" 2>/dev/null)"
            echo "  API URL:      $(/usr/libexec/PlistBuddy -c 'Print :API_BASE_URL' "$APP/Info.plist" 2>/dev/null)"
            echo "  Environment:  $(/usr/libexec/PlistBuddy -c 'Print :ENVIRONMENT_NAME' "$APP/Info.plist" 2>/dev/null)"
            echo "  Version:      $(/usr/libexec/PlistBuddy -c 'Print :CFBundleShortVersionString' "$APP/Info.plist" 2>/dev/null)"
          fi

      # ============================================================
      # STEP 7: Setup Appium & WDA
      # ============================================================
      - name: Pre-build WebDriverAgent
        run: |
          WDA_PATH=$(find ~/.appium -name "WebDriverAgent.xcodeproj" -type f 2>/dev/null | head -1 | xargs dirname)

          if [ -n "$WDA_PATH" ]; then
            cd "$WDA_PATH"
            xcodebuild build-for-testing \
              -project WebDriverAgent.xcodeproj \
              -scheme WebDriverAgentRunner \
              -destination "platform=iOS Simulator,id=${{ env.SIMULATOR_UDID }}" \
              -derivedDataPath /tmp/wda-build \
              -quiet 2>&1 | tail -3
            echo "âœ… WDA pre-built"
          fi

      - name: Start Appium Server
        run: |
          appium --relaxed-security --log-level error > appium.log 2>&1 &

          for i in {1..60}; do
            if curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:4723/status 2>/dev/null | grep -q "200"; then
              echo "âœ… Appium ready"
              break
            fi
            sleep 2
          done
          sleep 10

      - name: Warm-up WDA Session
        run: |
          APP_FILE=$(ls qa-automation/apps/ | grep ".app" | head -1)
          FULL_APP_PATH="${{ github.workspace }}/qa-automation/apps/$APP_FILE"
          echo "FULL_APP_PATH=$FULL_APP_PATH" >> $GITHUB_ENV

          for attempt in 1 2 3; do
            echo "WDA warm-up attempt $attempt/3..."

            SESSION_RESPONSE=$(curl -s -X POST http://127.0.0.1:4723/session \
              -H "Content-Type: application/json" \
              -d '{
                "capabilities": {
                  "alwaysMatch": {
                    "platformName": "iOS",
                    "appium:automationName": "XCUITest",
                    "appium:deviceName": "'"${{ env.DEVICE_NAME }}"'",
                    "appium:udid": "'"${{ env.SIMULATOR_UDID }}"'",
                    "appium:platformVersion": "'"${{ env.PLATFORM_VERSION }}"'",
                    "appium:app": "'"$FULL_APP_PATH"'",
                    "appium:wdaLaunchTimeout": 600000,
                    "appium:wdaConnectionTimeout": 300000,
                    "appium:useNewWDA": false,
                    "appium:noReset": false
                  }
                }
              }' --max-time 600 2>&1) || true

            SESSION_ID=$(echo "$SESSION_RESPONSE" | grep -o '"sessionId":"[^"]*"' | cut -d'"' -f4 || true)

            if [ -n "$SESSION_ID" ]; then
              echo "âœ… WDA session OK"
              sleep 10
              curl -s -X DELETE "http://127.0.0.1:4723/session/$SESSION_ID" || true
              sleep 5
              echo "âœ… WDA warm-up complete"
              break
            else
              [ $attempt -lt 3 ] && sleep 30
            fi
          done

      # ============================================================
      # STEP 8: Start API Capture & Run Tests
      # ============================================================
      # ============================================================
      # STEP 7.5: AWS Credentials for S3 Drift Detection
      # ============================================================
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-2

      - name: Verify AWS Access
        run: |
          echo "Verifying AWS CLI access for S3 drift detection..."
          aws sts get-caller-identity || echo "âš ï¸ AWS credentials not configured â€” S3 drift tests will be skipped"
          echo "âœ… AWS access verified"

      - name: Start API Traffic Capture
        if: github.event.inputs.capture_api != 'false'
        run: |
          timeout 5 mitmdump --set confdir=~/.mitmproxy 2>/dev/null || true
          xcrun simctl keychain "${{ env.SIMULATOR_UDID }}" add-root-cert ~/.mitmproxy/mitmproxy-ca-cert.pem 2>/dev/null || true
          mitmdump -w api_traffic.flow -p 8888 --set flow_detail=2 --quiet > mitmproxy.log 2>&1 &
          echo "MITM_PID=$!" >> $GITHUB_ENV
          sleep 3
          networksetup -setwebproxy "Wi-Fi" 127.0.0.1 8888 2>/dev/null || true
          networksetup -setsecurewebproxy "Wi-Fi" 127.0.0.1 8888 2>/dev/null || true
          echo "âœ… API capture started"

      - name: Run Tests
        id: run_tests
        continue-on-error: true
        run: |
          cd qa-automation

          APP_FILE=$(ls apps/ | grep ".app" | head -1)
          APP_PATH="${{ github.workspace }}/qa-automation/apps/$APP_FILE"

          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ðŸ§ª ${{ github.event.inputs.test_suite }} tests"
          echo "â•‘  ðŸ“± ${{ env.DEVICE_NAME }} | iOS ${{ env.PLATFORM_VERSION }}"
          echo "â•‘  ðŸŒ¿ ${{ github.event.inputs.branch }} â†’ ${{ env.BUILD_SCHEME }}"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""

          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # Maven flags:
          #   -B  = Batch mode (no download progress, no color codes)
          #   -q  = Quiet (suppress INFO logs, only WARN/ERROR)
          #
          # Combined with ConsoleProgressListener in testng XMLs,
          # CI output shows ONLY test progress + results
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # Shell function to run Maven with proper quoting.
          # DEVICE_NAME contains spaces (e.g. "iPhone 16 Pro") which
          # causes word-splitting if passed via a variable.
          # Using a function with quoted args avoids this entirely.
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          run_mvn() {
            local SUITE_XML="$1"
            mvn test -B -q \
              -DsuiteXmlFile="$SUITE_XML" \
              -DDEVICE_NAME="${{ env.DEVICE_NAME }}" \
              -DPLATFORM_VERSION="${{ env.PLATFORM_VERSION }}" \
              -DSIMULATOR_UDID="${{ env.SIMULATOR_UDID }}" \
              -DAPP_PATH="$APP_PATH"
          }

          case "${{ github.event.inputs.test_suite }}" in
            all)
              # â”€â”€ Run ALL test suites sequentially on single runner â”€â”€
              # Auth â†’ Site â†’ Assets P1-P6 â†’ Issues P1-P2 â†’ Location â†’ Connections
              # ~1158 tests total â€” expect long runtime on single runner
              run_mvn src/test/resources/parallel/testng-auth.xml
              run_mvn src/test/resources/parallel/testng-site.xml
              run_mvn src/test/resources/parallel/testng-assets-part1.xml
              run_mvn src/test/resources/parallel/testng-assets-part2.xml
              run_mvn src/test/resources/parallel/testng-assets-part3.xml
              run_mvn src/test/resources/parallel/testng-assets-part4.xml
              run_mvn src/test/resources/parallel/testng-assets-part5.xml
              run_mvn src/test/resources/parallel/testng-assets-part6.xml
              run_mvn src/test/resources/parallel/testng-issues-phase1.xml
              run_mvn src/test/resources/parallel/testng-issues-phase2.xml
              run_mvn src/test/resources/parallel/testng-location.xml
              run_mvn src/test/resources/parallel/testng-connections.xml
              ;;
            smoke)
              # â”€â”€ Smoke Dashboard â€” all 7 CRUD modules with live progress â”€â”€
              # S3 drift env is auto-detected from branch (set in "Detect S3 Drift Environment" step).
              export APP_PATH
              export S3_ENV="${{ env.S3_ENV }}"
              export S3_XML="${{ env.S3_XML }}"
              export S3_TESTS="${{ env.S3_TESTS }}"
              export S3_LABEL="${{ env.S3_LABEL }}"
              export TOTAL_SMOKE_TESTS="${{ env.TOTAL_SMOKE_TESTS }}"
              bash .github/scripts/smoke-dashboard.sh
              ;;
            # â”€â”€ Individual Smoke CRUD Modules â”€â”€
            smoke-login)
              run_mvn src/test/resources/smoke/testng-smoke-login.xml
              ;;
            smoke-site-selection)
              run_mvn src/test/resources/smoke/testng-smoke-site-selection.xml
              ;;
            smoke-asset-crud)
              run_mvn src/test/resources/smoke/testng-smoke-asset-crud.xml
              ;;
            smoke-location-crud)
              run_mvn src/test/resources/smoke/testng-smoke-location-crud.xml
              ;;
            smoke-connection-crud)
              run_mvn src/test/resources/smoke/testng-smoke-connection-crud.xml
              ;;
            smoke-issue-crud)
              run_mvn src/test/resources/smoke/testng-smoke-issue-crud.xml
              ;;
            # â”€â”€ Full Test Suites â”€â”€
            authentication-only)
              run_mvn src/test/resources/parallel/testng-auth.xml
              ;;
            site-selection-only)
              run_mvn src/test/resources/parallel/testng-site.xml
              ;;
            assets-p1-*)
              run_mvn src/test/resources/parallel/testng-assets-part1.xml
              ;;
            assets-p2-*)
              run_mvn src/test/resources/parallel/testng-assets-part2.xml
              ;;
            assets-p3-*)
              run_mvn src/test/resources/parallel/testng-assets-part3.xml
              ;;
            assets-p4-*)
              run_mvn src/test/resources/parallel/testng-assets-part4.xml
              ;;
            assets-p5-*)
              run_mvn src/test/resources/parallel/testng-assets-part5.xml
              ;;
            assets-p6-*)
              run_mvn src/test/resources/parallel/testng-assets-part6.xml
              ;;
            issues-p1-*)
              run_mvn src/test/resources/parallel/testng-issues-phase1.xml
              ;;
            issues-p2-*)
              run_mvn src/test/resources/parallel/testng-issues-phase2.xml
              ;;
            location-only)
              run_mvn src/test/resources/parallel/testng-location.xml
              ;;
            connections-only)
              run_mvn src/test/resources/parallel/testng-connections.xml
              ;;
          esac

      # ============================================================
      # STEP 9: Reports & Summary
      # ============================================================
      - name: Stop API Capture
        if: always() && github.event.inputs.capture_api != 'false'
        run: |
          kill ${{ env.MITM_PID }} 2>/dev/null || true
          sleep 2
          networksetup -setwebproxystate "Wi-Fi" off 2>/dev/null || true
          networksetup -setsecurewebproxystate "Wi-Fi" off 2>/dev/null || true

          if [ -f "api_traffic.flow" ]; then
            pip install mitmproxy --quiet 2>/dev/null || true
            python qa-automation/scripts/parse_api.py api_traffic.flow || true
          fi

      - name: Test Results Summary
        if: always()
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ðŸ“Š TEST RESULTS                                             â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘  Branch:  ${{ github.event.inputs.branch }}"
          echo "â•‘  Scheme:  ${{ env.BUILD_SCHEME }}"
          echo "â•‘  Suite:   ${{ github.event.inputs.test_suite }}"
          echo "â•‘  S3 Env:  ${{ env.S3_LABEL }} (${{ env.S3_TESTS }} tests)"
          echo "â•‘  Device:  ${{ env.DEVICE_NAME }} | iOS ${{ env.PLATFORM_VERSION }}"
          echo "â•‘  Result:  ${{ steps.run_tests.outcome }}"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          # For smoke suite, dashboard script sets SMOKE_* env vars with
          # aggregated counts across all 5 modules. For other suites,
          # parse the single TestNG results XML.
          if [ -n "${{ env.SMOKE_PASSED }}" ]; then
            echo ""
            echo "  âœ… Passed:  ${{ env.SMOKE_PASSED }}"
            echo "  âŒ Failed:  ${{ env.SMOKE_FAILED }}"
            echo "  â­ï¸  Skipped: ${{ env.SMOKE_SKIPPED }}"
            echo "  â±ï¸  Duration: ${{ env.SMOKE_DURATION }}s"
          else
            RESULTS_XML="qa-automation/target/surefire-reports/testng-results.xml"
            if [ -f "$RESULTS_XML" ]; then
              # Use sed instead of grep -oP (BSD grep on macOS doesn't support -P)
              PASSED=$(sed -n 's/.*passed="\([^"]*\)".*/\1/p' "$RESULTS_XML" | head -1)
              FAILED=$(sed -n 's/.*failed="\([^"]*\)".*/\1/p' "$RESULTS_XML" | head -1)
              SKIPPED=$(sed -n 's/.*skipped="\([^"]*\)".*/\1/p' "$RESULTS_XML" | head -1)
              echo ""
              echo "  âœ… Passed:  ${PASSED:-0}"
              echo "  âŒ Failed:  ${FAILED:-0}"
              echo "  â­ï¸  Skipped: ${SKIPPED:-0}"
            fi
          fi

          # Show Extent Report locations
          echo ""
          DETAILED=$(ls qa-automation/reports/detailed/*.html 2>/dev/null | tail -1)
          CLIENT=$(ls qa-automation/reports/client/*.html 2>/dev/null | tail -1)
          [ -n "$DETAILED" ] && echo "  ðŸ“‹ Detailed Report: $DETAILED"
          [ -n "$CLIENT" ] && echo "  ðŸ“‹ Client Report:   $CLIENT"

      # Artifact includes run number to avoid name conflicts
      - name: Upload Test Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: qa-reports-${{ env.SAFE_BRANCH }}-${{ github.event.inputs.test_suite }}-${{ github.run_number }}
          path: |
            qa-automation/reports/
            qa-automation/target/surefire-reports/
            qa-automation/screenshots/
          retention-days: 30

      # Only upload Appium log on failure (saves artifact space)
      - name: Upload Appium Log (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: appium-log-${{ github.run_number }}
          path: appium.log
          retention-days: 7

      # ============================================================
      # STEP 10: Cleanup
      # ============================================================
      - name: Shutdown Simulator
        if: always()
        run: |
          xcrun simctl shutdown "${{ env.SIMULATOR_UDID }}" 2>/dev/null || true