name: Automation Test - Parallel

# ============================================================
# DEVELOPER REPO - FULL PARALLEL TEST SUITE
# ============================================================
# Builds iOS app from selected branch, then runs all test
# modules in parallel across 13 separate macOS runners.
#
# Architecture:
#   Job 0:  build-app          â†’ Build iOS app from source (1 runner)
#   Job 1:  smoke-tests        â†’ Smoke CRUD: Login + Site + Asset + Location + Connection + Issue (17 tests)
#   Job 2:  auth-tests         â†’ Authentication (38 tests)
#   Job 3:  site-tests         â†’ Site Selection (52 tests)
#   Job 4:  assets-part1       â†’ P1: Creation + Edit + Busway + Capacitor + P5: Bug Tests (112 tests)
#   Job 5:  assets-part2       â†’ P1: CB + DS + Fuse + P2: Generator + Junction Box (108 tests)
#   Job 6:  assets-part3       â†’ P2: Load Center + MCC + MCC Bucket + Motor + Other (109 tests)
#   Job 7:  assets-part4       â†’ P2: OCP + P3: Panelboard + PDU + Relay + SWB + Transformer (97 tests)
#   Job 8:  assets-part5       â†’ P3: UPS + Utility + VFD + Subtypes + P4: DS/Fuse Subtypes (112 tests)
#   Job 9:  assets-part6       â†’ P4: Subtypes + Tasks + Issues + Connections + Asset Screen (114 tests)
#   Job 10: issues-phase1      â†’ Issues Phase 1: List + Filter + Search + Creation + Class Change (119 tests)
#   Job 11: issues-phase2      â†’ Issues Phase 2: OSHA + Thermal + Severity + Temperature + Ultrasonic (60 tests)
#   Job 12: issues-phase3      â†’ Issues Phase 3: Ultrasonic Save + Swipe Delete + Sort + Status + CRUD (58 tests)
#   Job 13: location-tests     â†’ Locations (82 tests)
#   Job 14: connections-tests  â†’ Connections (94 tests)
#   Job 15: summary            â†’ Aggregate results + email
#
# Total: ~1155 tests, ~2.5 hr wall clock (parallel)
# Asset tests (652) split into 6 balanced parts for even CI/CD load
# Issues tests (237) split into 3 phases for even CI/CD load
#
# Requirements:
#   Secrets: QA_REPO_TOKEN, AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY,
#            EMAIL_USERNAME, EMAIL_PASSWORD, EMAIL_TO
# ============================================================

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to build and test'
        required: true
        default: 'release/qa'
        type: choice
        options:
          - main
          - release/dev
          - release/qa
          - release/stage
          - release/prod
      job_selection:
        description: 'Which jobs to run'
        required: false
        default: 'all'
        type: choice
        options:
          - 'all'
          - 'smoke'
          - 'authentication-only'
          - 'site-selection-only'
          - 'assets-p1-creation-edit-busway-capacitor-bug'
          - 'assets-p2-cb-ds-fuse-generator-junctionbox'
          - 'assets-p3-loadcenter-mcc-mccbucket-motor-other'
          - 'assets-p4-ocp-panelboard-pdu-relay-swb-transformer'
          - 'assets-p5-ups-utility-vfd-subtypes'
          - 'assets-p6-subtypes-tasks-issues-connections-search'
          - 'issues-p1-list-filter-search-creation-classchange'
          - 'issues-p2-osha-thermal-severity-temperature-ultrasonic'
          - 'issues-p3-ultrasonic-save-swipe-delete-sort-status-crud'
          - 'location-only'
          - 'connections-only'

# ============================================================
# JOB 0: Build iOS App from Source
# ============================================================
jobs:
  build-app:
    name: "Build App"
    runs-on: macos-15
    timeout-minutes: 60

    steps:
      - name: Checkout iOS App Repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch }}
          path: ios-app

      - name: Checkout QA Automation Repository
        uses: actions/checkout@v4
        with:
          repository: eg-abhiyantsingh/iOS_automation_site
          token: ${{ secrets.QA_REPO_TOKEN }}
          path: qa-automation

      - name: Set Build Configuration
        run: |
          BRANCH="${{ github.event.inputs.branch }}"

          case "$BRANCH" in
            release/dev)     SCHEME="Egalvanic PZ-Dev" ;;
            release/qa)      SCHEME="Egalvanic PZ-QA" ;;
            release/stage*)  SCHEME="Egalvanic PZ-Staging" ;;
            release/prod|main) SCHEME="Egalvanic PZ" ;;
            *)               SCHEME="Egalvanic PZ-QA" ;;
          esac

          XCODEPROJ=$(find ios-app -name "*.xcodeproj" -type d | head -1)

          echo "BUILD_SCHEME=$SCHEME" >> $GITHUB_ENV
          echo "XCODEPROJ_PATH=$XCODEPROJ" >> $GITHUB_ENV

          echo "ðŸ“± Branch: $BRANCH | Scheme: $SCHEME"

      - name: Boot Simulator for Build
        run: |
          UDID=""
          for VERSION in 18.5 18.4 18.3 18.2 18.1 18.0; do
            for MODEL in "iPhone 16 Pro" "iPhone 15 Pro" "iPhone"; do
              UDID=$(xcrun simctl list devices available | grep -A 100 "iOS $VERSION" | grep "$MODEL" | head -1 | awk -F '[()]' '{print $2}')
              [ -n "$UDID" ] && break 2
            done
          done

          if [ -z "$UDID" ]; then
            echo "âŒ No iPhone simulator found!"
            xcrun simctl list devices available
            exit 1
          fi

          echo "BUILD_UDID=$UDID" >> $GITHUB_ENV
          echo "ðŸ“± Build simulator: $UDID"

          xcrun simctl shutdown "$UDID" 2>/dev/null || true
          sleep 3
          xcrun simctl boot "$UDID" 2>/dev/null || true

          TIMEOUT=120
          ELAPSED=0
          while [ $ELAPSED -lt $TIMEOUT ]; do
            if xcrun simctl list devices | grep "$UDID" | grep -q "(Booted)"; then
              echo "âœ… Booted after ${ELAPSED}s"
              break
            fi
            sleep 5
            ELAPSED=$((ELAPSED + 5))
          done

          if [ $ELAPSED -ge $TIMEOUT ]; then echo "âŒ Boot timeout"; exit 1; fi

      - name: Resolve Swift Package Dependencies
        run: |
          cd ios-app
          PROJECT_FILE=$(basename "$XCODEPROJ_PATH")
          xcodebuild -resolvePackageDependencies \
            -project "$PROJECT_FILE" \
            -scheme "${{ env.BUILD_SCHEME }}" \
            -clonedSourcePackagesDirPath ../spm-cache \
            -quiet 2>&1 | tail -3
          echo "âœ… Dependencies resolved"

      - name: Build iOS App for Simulator
        run: |
          cd ios-app
          PROJECT_FILE=$(basename "$XCODEPROJ_PATH")

          echo "ðŸ”¨ Building: ${{ env.BUILD_SCHEME }} from ${{ github.event.inputs.branch }}"

          xcodebuild build \
            -project "$PROJECT_FILE" \
            -scheme "${{ env.BUILD_SCHEME }}" \
            -destination "platform=iOS Simulator,id=${{ env.BUILD_UDID }}" \
            -derivedDataPath build \
            -clonedSourcePackagesDirPath ../spm-cache \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=NO \
            -quiet 2>&1 | tail -5

          APP_PATH=$(find build -name "*.app" -type d | head -1)

          if [ -z "$APP_PATH" ]; then
            echo "âŒ Build failed! No .app found"
            find build -type d | head -20
            exit 1
          fi

          echo "âœ… Built: $(basename "$APP_PATH")"

          # Copy built app to QA automation directory
          mkdir -p ../qa-automation/apps
          cp -R "$APP_PATH" "../qa-automation/apps/"

      - name: Verify App Configuration
        run: |
          APP_FILE=$(ls qa-automation/apps/ | grep ".app" | head -1)
          APP="qa-automation/apps/$APP_FILE"

          if [ -f "$APP/Info.plist" ]; then
            BUNDLE_ID=$(/usr/libexec/PlistBuddy -c 'Print :CFBundleIdentifier' "$APP/Info.plist" 2>/dev/null || echo 'N/A')
            echo "â”€â”€â”€ Built App Config â”€â”€â”€"
            echo "  Bundle ID:    $BUNDLE_ID"
            echo "  API URL:      $(/usr/libexec/PlistBuddy -c 'Print :API_BASE_URL' "$APP/Info.plist" 2>/dev/null || echo 'N/A')"
            echo "  Environment:  $(/usr/libexec/PlistBuddy -c 'Print :ENVIRONMENT_NAME' "$APP/Info.plist" 2>/dev/null || echo 'N/A')"
            echo "  Version:      $(/usr/libexec/PlistBuddy -c 'Print :CFBundleShortVersionString' "$APP/Info.plist" 2>/dev/null || echo 'N/A')"
            # Export bundle ID so tests can use the correct value for terminateApp/activateApp
            echo "APP_BUNDLE_ID=$BUNDLE_ID" >> $GITHUB_ENV
          fi

      - name: Upload Built App
        uses: actions/upload-artifact@v4
        with:
          name: built-app
          path: qa-automation/apps/
          retention-days: 1

      - name: Upload QA Automation Code
        uses: actions/upload-artifact@v4
        with:
          name: qa-code
          path: |
            qa-automation/src/
            qa-automation/pom.xml
            qa-automation/testng.xml
            qa-automation/testng-smoke.xml
            qa-automation/baselines/
          retention-days: 1

      - name: Shutdown Build Simulator
        if: always()
        run: xcrun simctl shutdown "${{ env.BUILD_UDID }}" 2>/dev/null || true

  # ============================================================
  # JOB 1: Smoke Tests (17 tests, ~15 min)
  # ============================================================
  smoke-tests:
    name: "Smoke - CRUD Tests (17 tests)"
    needs: [build-app]
    if: github.event.inputs.job_selection == 'smoke'
    runs-on: macos-15
    timeout-minutes: 120

    steps:
      - name: Download Built App
        uses: actions/download-artifact@v4
        with:
          name: built-app
          path: apps/

      - name: Download QA Automation Code
        uses: actions/download-artifact@v4
        with:
          name: qa-code
          path: qa-automation/

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install Appium
        run: |
          npm install -g appium@latest 2>&1 | tail -1
          appium driver install xcuitest 2>&1 | tail -1
          echo "âœ… Appium $(appium --version)"

      - name: Boot Simulator
        run: |
          UDID=""
          for VERSION in 18.5 18.4 18.3 18.2 18.1 18.0; do
            for MODEL in "iPhone 16 Pro" "iPhone 15 Pro" "iPhone"; do
              UDID=$(xcrun simctl list devices available | grep -A 100 "iOS $VERSION" | grep "$MODEL" | head -1 | awk -F '[()]' '{print $2}')
              [ -n "$UDID" ] && break 2
            done
          done

          if [ -z "$UDID" ]; then
            echo "âŒ No iPhone simulator found!"
            xcrun simctl list devices available
            exit 1
          fi

          DEVICE_NAME=$(xcrun simctl list devices available | grep "$UDID" | sed 's/(.*//' | xargs)
          PLATFORM_VERSION=$(xcrun simctl list devices available | grep -B 20 "$UDID" | grep "iOS" | tail -1 | sed 's/-- iOS //' | sed 's/ --.*//')
          [ -z "$PLATFORM_VERSION" ] && PLATFORM_VERSION="18.5"

          echo "DEVICE_NAME=$DEVICE_NAME" >> $GITHUB_ENV
          echo "SIMULATOR_UDID=$UDID" >> $GITHUB_ENV
          echo "PLATFORM_VERSION=$PLATFORM_VERSION" >> $GITHUB_ENV
          echo "ðŸ“± $DEVICE_NAME | iOS $PLATFORM_VERSION | $UDID"

          xcrun simctl shutdown "$UDID" 2>/dev/null || true
          sleep 3
          xcrun simctl boot "$UDID" 2>/dev/null || true

          TIMEOUT=120
          ELAPSED=0
          while [ $ELAPSED -lt $TIMEOUT ]; do
            if xcrun simctl list devices | grep "$UDID" | grep -q "(Booted)"; then
              echo "âœ… Booted after ${ELAPSED}s"
              break
            fi
            sleep 5
            ELAPSED=$((ELAPSED + 5))
          done

          if [ $ELAPSED -ge $TIMEOUT ]; then echo "âŒ Boot timeout"; exit 1; fi
          sleep 45
          echo "âœ… Simulator ready"

      - name: Install App on Simulator
        run: |
          APP_FILE=$(ls apps/ | grep ".app" | head -1)
          xcrun simctl install "${{ env.SIMULATOR_UDID }}" "apps/$APP_FILE"
          echo "âœ… App installed: $APP_FILE"

      - name: Pre-build WebDriverAgent
        run: |
          WDA_PATH=$(find ~/.appium -name "WebDriverAgent.xcodeproj" -type f 2>/dev/null | head -1 | xargs dirname)
          if [ -n "$WDA_PATH" ]; then
            cd "$WDA_PATH"
            xcodebuild build-for-testing \
              -project WebDriverAgent.xcodeproj \
              -scheme WebDriverAgentRunner \
              -destination "platform=iOS Simulator,id=${{ env.SIMULATOR_UDID }}" \
              -derivedDataPath /tmp/wda-build \
              -quiet 2>&1 | tail -3
            echo "âœ… WDA pre-built"
          fi

      - name: Start Appium Server
        run: |
          appium --relaxed-security --log-level error > appium.log 2>&1 &
          for i in {1..60}; do
            if curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:4723/status 2>/dev/null | grep -q "200"; then
              echo "âœ… Appium ready"
              break
            fi
            sleep 2
          done
          sleep 10

      - name: Warm-up WDA Session
        run: |
          APP_FILE=$(ls apps/ | grep ".app" | head -1)
          FULL_APP_PATH="${{ github.workspace }}/apps/$APP_FILE"

          for attempt in 1 2 3; do
            echo "WDA warm-up attempt $attempt/3..."
            SESSION_RESPONSE=$(curl -s -X POST http://127.0.0.1:4723/session \
              -H "Content-Type: application/json" \
              -d '{
                "capabilities": {
                  "alwaysMatch": {
                    "platformName": "iOS",
                    "appium:automationName": "XCUITest",
                    "appium:deviceName": "'"${{ env.DEVICE_NAME }}"'",
                    "appium:udid": "'"${{ env.SIMULATOR_UDID }}"'",
                    "appium:platformVersion": "'"${{ env.PLATFORM_VERSION }}"'",
                    "appium:app": "'"$FULL_APP_PATH"'",
                    "appium:wdaLaunchTimeout": 600000,
                    "appium:wdaConnectionTimeout": 300000,
                    "appium:useNewWDA": false,
                    "appium:noReset": false
                  }
                }
              }' --max-time 600 2>&1) || true

            SESSION_ID=$(echo "$SESSION_RESPONSE" | grep -o '"sessionId":"[^"]*"' | cut -d'"' -f4 || true)

            if [ -n "$SESSION_ID" ]; then
              echo "âœ… WDA session OK"
              sleep 10
              curl -s -X DELETE "http://127.0.0.1:4723/session/$SESSION_ID" || true
              sleep 5
              echo "âœ… WDA warm-up complete"
              break
            else
              [ $attempt -lt 3 ] && sleep 30
            fi
          done

      - name: Run Smoke Tests
        continue-on-error: true
        run: |
          cd qa-automation
          APP_FILE=$(ls ../apps/ | grep ".app" | head -1)
          APP_PATH="${{ github.workspace }}/apps/$APP_FILE"

          # Extract bundle ID from built app so soft restart uses correct ID
          BUNDLE_ID=$(/usr/libexec/PlistBuddy -c 'Print :CFBundleIdentifier' "$APP_PATH/Info.plist" 2>/dev/null || echo "com.egalvanic.zplatform-QA")
          echo "ðŸ“± Bundle ID: $BUNDLE_ID"

          echo "ðŸ§ª Running Smoke CRUD Tests (17 tests)"

          # Login (1 test)
          mvn test -B -q \
            -DsuiteXmlFile=src/test/resources/smoke/testng-smoke-login.xml \
            -DDEVICE_NAME="${{ env.DEVICE_NAME }}" \
            -DPLATFORM_VERSION="${{ env.PLATFORM_VERSION }}" \
            -DSIMULATOR_UDID="${{ env.SIMULATOR_UDID }}" \
            -DAPP_PATH="$APP_PATH" \
            -DAPP_BUNDLE_ID="$BUNDLE_ID" || true

          # Site Selection (1 test)
          mvn test -B -q \
            -DsuiteXmlFile=src/test/resources/smoke/testng-smoke-site-selection.xml \
            -DDEVICE_NAME="${{ env.DEVICE_NAME }}" \
            -DPLATFORM_VERSION="${{ env.PLATFORM_VERSION }}" \
            -DSIMULATOR_UDID="${{ env.SIMULATOR_UDID }}" \
            -DAPP_PATH="$APP_PATH" \
            -DAPP_BUNDLE_ID="$BUNDLE_ID" || true

          # Asset CRUD (4 tests)
          mvn test -B -q \
            -DsuiteXmlFile=src/test/resources/smoke/testng-smoke-asset-crud.xml \
            -DDEVICE_NAME="${{ env.DEVICE_NAME }}" \
            -DPLATFORM_VERSION="${{ env.PLATFORM_VERSION }}" \
            -DSIMULATOR_UDID="${{ env.SIMULATOR_UDID }}" \
            -DAPP_PATH="$APP_PATH" \
            -DAPP_BUNDLE_ID="$BUNDLE_ID" || true

          # Location CRUD (4 tests)
          mvn test -B -q \
            -DsuiteXmlFile=src/test/resources/smoke/testng-smoke-location-crud.xml \
            -DDEVICE_NAME="${{ env.DEVICE_NAME }}" \
            -DPLATFORM_VERSION="${{ env.PLATFORM_VERSION }}" \
            -DSIMULATOR_UDID="${{ env.SIMULATOR_UDID }}" \
            -DAPP_PATH="$APP_PATH" \
            -DAPP_BUNDLE_ID="$BUNDLE_ID" || true

          # Connection CRUD (3 tests)
          mvn test -B -q \
            -DsuiteXmlFile=src/test/resources/smoke/testng-smoke-connection-crud.xml \
            -DDEVICE_NAME="${{ env.DEVICE_NAME }}" \
            -DPLATFORM_VERSION="${{ env.PLATFORM_VERSION }}" \
            -DSIMULATOR_UDID="${{ env.SIMULATOR_UDID }}" \
            -DAPP_PATH="$APP_PATH" \
            -DAPP_BUNDLE_ID="$BUNDLE_ID" || true

          # Issue CRUD (4 tests)
          mvn test -B -q \
            -DsuiteXmlFile=src/test/resources/smoke/testng-smoke-issue-crud.xml \
            -DDEVICE_NAME="${{ env.DEVICE_NAME }}" \
            -DPLATFORM_VERSION="${{ env.PLATFORM_VERSION }}" \
            -DSIMULATOR_UDID="${{ env.SIMULATOR_UDID }}" \
            -DAPP_PATH="$APP_PATH" \
            -DAPP_BUNDLE_ID="$BUNDLE_ID" || true

          echo "âœ… Smoke CRUD Tests Complete"

      - name: Upload Smoke Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-report
          path: |
            qa-automation/target/surefire-reports/
            qa-automation/reports/
            qa-automation/screenshots/
          retention-days: 7

      - name: Upload Appium Log (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: appium-log-smoke-${{ github.run_number }}
          path: appium.log
          retention-days: 7

      - name: Shutdown Simulator
        if: always()
        run: xcrun simctl shutdown "${{ env.SIMULATOR_UDID }}" 2>/dev/null || true

  # ============================================================
  # JOB 2: Auth Tests (38 tests, ~30 min)
  # ============================================================
  auth-tests:
    name: "Authentication (38 tests)"
    needs: [build-app]
    if: github.event.inputs.job_selection == 'all' || github.event.inputs.job_selection == 'authentication-only'
    runs-on: macos-15
    timeout-minutes: 420

    steps:
      - name: Download Built App
        uses: actions/download-artifact@v4
        with:
          name: built-app
          path: apps/

      - name: Download QA Automation Code
        uses: actions/download-artifact@v4
        with:
          name: qa-code
          path: qa-automation/

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install Appium
        run: |
          npm install -g appium@latest 2>&1 | tail -1
          appium driver install xcuitest 2>&1 | tail -1
          echo "âœ… Appium $(appium --version)"

      - name: Boot Simulator
        run: |
          UDID=""
          for VERSION in 18.5 18.4 18.3 18.2 18.1 18.0; do
            for MODEL in "iPhone 16 Pro" "iPhone 15 Pro" "iPhone"; do
              UDID=$(xcrun simctl list devices available | grep -A 100 "iOS $VERSION" | grep "$MODEL" | head -1 | awk -F '[()]' '{print $2}')
              [ -n "$UDID" ] && break 2
            done
          done

          if [ -z "$UDID" ]; then
            echo "âŒ No iPhone simulator found!"
            xcrun simctl list devices available
            exit 1
          fi

          DEVICE_NAME=$(xcrun simctl list devices available | grep "$UDID" | sed 's/(.*//' | xargs)
          PLATFORM_VERSION=$(xcrun simctl list devices available | grep -B 20 "$UDID" | grep "iOS" | tail -1 | sed 's/-- iOS //' | sed 's/ --.*//')
          [ -z "$PLATFORM_VERSION" ] && PLATFORM_VERSION="18.5"

          echo "DEVICE_NAME=$DEVICE_NAME" >> $GITHUB_ENV
          echo "SIMULATOR_UDID=$UDID" >> $GITHUB_ENV
          echo "PLATFORM_VERSION=$PLATFORM_VERSION" >> $GITHUB_ENV
          echo "ðŸ“± $DEVICE_NAME | iOS $PLATFORM_VERSION | $UDID"

          xcrun simctl shutdown "$UDID" 2>/dev/null || true
          sleep 3
          xcrun simctl boot "$UDID" 2>/dev/null || true

          TIMEOUT=120
          ELAPSED=0
          while [ $ELAPSED -lt $TIMEOUT ]; do
            if xcrun simctl list devices | grep "$UDID" | grep -q "(Booted)"; then
              echo "âœ… Booted after ${ELAPSED}s"
              break
            fi
            sleep 5
            ELAPSED=$((ELAPSED + 5))
          done

          if [ $ELAPSED -ge $TIMEOUT ]; then echo "âŒ Boot timeout"; exit 1; fi
          sleep 45
          echo "âœ… Simulator ready"

      - name: Install App on Simulator
        run: |
          APP_FILE=$(ls apps/ | grep ".app" | head -1)
          xcrun simctl install "${{ env.SIMULATOR_UDID }}" "apps/$APP_FILE"
          echo "âœ… App installed: $APP_FILE"

      - name: Pre-build WebDriverAgent
        run: |
          WDA_PATH=$(find ~/.appium -name "WebDriverAgent.xcodeproj" -type f 2>/dev/null | head -1 | xargs dirname)
          if [ -n "$WDA_PATH" ]; then
            cd "$WDA_PATH"
            xcodebuild build-for-testing \
              -project WebDriverAgent.xcodeproj \
              -scheme WebDriverAgentRunner \
              -destination "platform=iOS Simulator,id=${{ env.SIMULATOR_UDID }}" \
              -derivedDataPath /tmp/wda-build \
              -quiet 2>&1 | tail -3
            echo "âœ… WDA pre-built"
          fi

      - name: Start Appium Server
        run: |
          appium --relaxed-security --log-level error > appium.log 2>&1 &
          for i in {1..60}; do
            if curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:4723/status 2>/dev/null | grep -q "200"; then
              echo "âœ… Appium ready"
              break
            fi
            sleep 2
          done
          sleep 10

      - name: Warm-up WDA Session
        run: |
          APP_FILE=$(ls apps/ | grep ".app" | head -1)
          FULL_APP_PATH="${{ github.workspace }}/apps/$APP_FILE"

          for attempt in 1 2 3; do
            echo "WDA warm-up attempt $attempt/3..."
            SESSION_RESPONSE=$(curl -s -X POST http://127.0.0.1:4723/session \
              -H "Content-Type: application/json" \
              -d '{
                "capabilities": {
                  "alwaysMatch": {
                    "platformName": "iOS",
                    "appium:automationName": "XCUITest",
                    "appium:deviceName": "'"${{ env.DEVICE_NAME }}"'",
                    "appium:udid": "'"${{ env.SIMULATOR_UDID }}"'",
                    "appium:platformVersion": "'"${{ env.PLATFORM_VERSION }}"'",
                    "appium:app": "'"$FULL_APP_PATH"'",
                    "appium:wdaLaunchTimeout": 600000,
                    "appium:wdaConnectionTimeout": 300000,
                    "appium:useNewWDA": false,
                    "appium:noReset": false
                  }
                }
              }' --max-time 600 2>&1) || true

            SESSION_ID=$(echo "$SESSION_RESPONSE" | grep -o '"sessionId":"[^"]*"' | cut -d'"' -f4 || true)

            if [ -n "$SESSION_ID" ]; then
              echo "âœ… WDA session OK"
              sleep 10
              curl -s -X DELETE "http://127.0.0.1:4723/session/$SESSION_ID" || true
              sleep 5
              echo "âœ… WDA warm-up complete"
              break
            else
              [ $attempt -lt 3 ] && sleep 30
            fi
          done

      - name: Run Auth Tests
        continue-on-error: true
        run: |
          cd qa-automation
          APP_FILE=$(ls ../apps/ | grep ".app" | head -1)
          APP_PATH="${{ github.workspace }}/apps/$APP_FILE"

          # Extract bundle ID from built app so soft restart uses correct ID
          BUNDLE_ID=$(/usr/libexec/PlistBuddy -c 'Print :CFBundleIdentifier' "$APP_PATH/Info.plist" 2>/dev/null || echo "com.egalvanic.zplatform-QA")

          mvn test -B -q \
            -DsuiteXmlFile=src/test/resources/parallel/testng-auth.xml \
            -DDEVICE_NAME="${{ env.DEVICE_NAME }}" \
            -DPLATFORM_VERSION="${{ env.PLATFORM_VERSION }}" \
            -DSIMULATOR_UDID="${{ env.SIMULATOR_UDID }}" \
            -DAPP_PATH="$APP_PATH" \
            -DAPP_BUNDLE_ID="$BUNDLE_ID"

      - name: Upload Auth Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: auth-report
          path: |
            qa-automation/target/surefire-reports/
            qa-automation/reports/
            qa-automation/screenshots/
          retention-days: 7

      - name: Upload Appium Log (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: appium-log-auth-${{ github.run_number }}
          path: appium.log
          retention-days: 7

      - name: Shutdown Simulator
        if: always()
        run: xcrun simctl shutdown "${{ env.SIMULATOR_UDID }}" 2>/dev/null || true

  # ============================================================
  # JOB 2: Site Tests (52 tests, ~1 hr)
  # ============================================================
  site-tests:
    name: "Site Selection (52 tests)"
    needs: [build-app]
    if: github.event.inputs.job_selection == 'all' || github.event.inputs.job_selection == 'site-selection-only'
    runs-on: macos-15
    timeout-minutes: 420

    steps:
      - name: Download Built App
        uses: actions/download-artifact@v4
        with:
          name: built-app
          path: apps/

      - name: Download QA Automation Code
        uses: actions/download-artifact@v4
        with:
          name: qa-code
          path: qa-automation/

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install Appium
        run: |
          npm install -g appium@latest 2>&1 | tail -1
          appium driver install xcuitest 2>&1 | tail -1
          echo "âœ… Appium $(appium --version)"

      - name: Boot Simulator
        run: |
          UDID=""
          for VERSION in 18.5 18.4 18.3 18.2 18.1 18.0; do
            for MODEL in "iPhone 16 Pro" "iPhone 15 Pro" "iPhone"; do
              UDID=$(xcrun simctl list devices available | grep -A 100 "iOS $VERSION" | grep "$MODEL" | head -1 | awk -F '[()]' '{print $2}')
              [ -n "$UDID" ] && break 2
            done
          done

          if [ -z "$UDID" ]; then
            echo "âŒ No iPhone simulator found!"
            xcrun simctl list devices available
            exit 1
          fi

          DEVICE_NAME=$(xcrun simctl list devices available | grep "$UDID" | sed 's/(.*//' | xargs)
          PLATFORM_VERSION=$(xcrun simctl list devices available | grep -B 20 "$UDID" | grep "iOS" | tail -1 | sed 's/-- iOS //' | sed 's/ --.*//')
          [ -z "$PLATFORM_VERSION" ] && PLATFORM_VERSION="18.5"

          echo "DEVICE_NAME=$DEVICE_NAME" >> $GITHUB_ENV
          echo "SIMULATOR_UDID=$UDID" >> $GITHUB_ENV
          echo "PLATFORM_VERSION=$PLATFORM_VERSION" >> $GITHUB_ENV
          echo "ðŸ“± $DEVICE_NAME | iOS $PLATFORM_VERSION | $UDID"

          xcrun simctl shutdown "$UDID" 2>/dev/null || true
          sleep 3
          xcrun simctl boot "$UDID" 2>/dev/null || true

          TIMEOUT=120
          ELAPSED=0
          while [ $ELAPSED -lt $TIMEOUT ]; do
            if xcrun simctl list devices | grep "$UDID" | grep -q "(Booted)"; then
              echo "âœ… Booted after ${ELAPSED}s"
              break
            fi
            sleep 5
            ELAPSED=$((ELAPSED + 5))
          done

          if [ $ELAPSED -ge $TIMEOUT ]; then echo "âŒ Boot timeout"; exit 1; fi
          sleep 45
          echo "âœ… Simulator ready"

      - name: Install App on Simulator
        run: |
          APP_FILE=$(ls apps/ | grep ".app" | head -1)
          xcrun simctl install "${{ env.SIMULATOR_UDID }}" "apps/$APP_FILE"
          echo "âœ… App installed: $APP_FILE"

      - name: Pre-build WebDriverAgent
        run: |
          WDA_PATH=$(find ~/.appium -name "WebDriverAgent.xcodeproj" -type f 2>/dev/null | head -1 | xargs dirname)
          if [ -n "$WDA_PATH" ]; then
            cd "$WDA_PATH"
            xcodebuild build-for-testing \
              -project WebDriverAgent.xcodeproj \
              -scheme WebDriverAgentRunner \
              -destination "platform=iOS Simulator,id=${{ env.SIMULATOR_UDID }}" \
              -derivedDataPath /tmp/wda-build \
              -quiet 2>&1 | tail -3
            echo "âœ… WDA pre-built"
          fi

      - name: Start Appium Server
        run: |
          appium --relaxed-security --log-level error > appium.log 2>&1 &
          for i in {1..60}; do
            if curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:4723/status 2>/dev/null | grep -q "200"; then
              echo "âœ… Appium ready"
              break
            fi
            sleep 2
          done
          sleep 10

      - name: Warm-up WDA Session
        run: |
          APP_FILE=$(ls apps/ | grep ".app" | head -1)
          FULL_APP_PATH="${{ github.workspace }}/apps/$APP_FILE"

          for attempt in 1 2 3; do
            echo "WDA warm-up attempt $attempt/3..."
            SESSION_RESPONSE=$(curl -s -X POST http://127.0.0.1:4723/session \
              -H "Content-Type: application/json" \
              -d '{
                "capabilities": {
                  "alwaysMatch": {
                    "platformName": "iOS",
                    "appium:automationName": "XCUITest",
                    "appium:deviceName": "'"${{ env.DEVICE_NAME }}"'",
                    "appium:udid": "'"${{ env.SIMULATOR_UDID }}"'",
                    "appium:platformVersion": "'"${{ env.PLATFORM_VERSION }}"'",
                    "appium:app": "'"$FULL_APP_PATH"'",
                    "appium:wdaLaunchTimeout": 600000,
                    "appium:wdaConnectionTimeout": 300000,
                    "appium:useNewWDA": false,
                    "appium:noReset": false
                  }
                }
              }' --max-time 600 2>&1) || true

            SESSION_ID=$(echo "$SESSION_RESPONSE" | grep -o '"sessionId":"[^"]*"' | cut -d'"' -f4 || true)

            if [ -n "$SESSION_ID" ]; then
              echo "âœ… WDA session OK"
              sleep 10
              curl -s -X DELETE "http://127.0.0.1:4723/session/$SESSION_ID" || true
              sleep 5
              echo "âœ… WDA warm-up complete"
              break
            else
              [ $attempt -lt 3 ] && sleep 30
            fi
          done

      - name: Run Site Tests
        continue-on-error: true
        run: |
          cd qa-automation
          APP_FILE=$(ls ../apps/ | grep ".app" | head -1)
          APP_PATH="${{ github.workspace }}/apps/$APP_FILE"

          # Extract bundle ID from built app so soft restart uses correct ID
          BUNDLE_ID=$(/usr/libexec/PlistBuddy -c 'Print :CFBundleIdentifier' "$APP_PATH/Info.plist" 2>/dev/null || echo "com.egalvanic.zplatform-QA")

          mvn test -B -q \
            -DsuiteXmlFile=src/test/resources/parallel/testng-site.xml \
            -DDEVICE_NAME="${{ env.DEVICE_NAME }}" \
            -DPLATFORM_VERSION="${{ env.PLATFORM_VERSION }}" \
            -DSIMULATOR_UDID="${{ env.SIMULATOR_UDID }}" \
            -DAPP_PATH="$APP_PATH" \
            -DAPP_BUNDLE_ID="$BUNDLE_ID"

      - name: Upload Site Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: site-report
          path: |
            qa-automation/target/surefire-reports/
            qa-automation/reports/
            qa-automation/screenshots/
          retention-days: 7

      - name: Upload Appium Log (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: appium-log-site-${{ github.run_number }}
          path: appium.log
          retention-days: 7

      - name: Shutdown Simulator
        if: always()
        run: xcrun simctl shutdown "${{ env.SIMULATOR_UDID }}" 2>/dev/null || true


  # ============================================================
  # JOB 3: Asset Part 1 (112 tests, ~1.5 hr)
  # P1: Asset Creation (19) + Edit Details (19) + Busway (4) + Capacitor (26)
  # P5: Bug Regression Tests (44)
  # ============================================================
  assets-part1:
    name: "Assets P1 - Creation + Edit + Busway + Capacitor + Bug (112 tests)"
    needs: [build-app]
    if: github.event.inputs.job_selection == 'all' || github.event.inputs.job_selection == 'assets-p1-creation-edit-busway-capacitor-bug'
    runs-on: macos-15
    timeout-minutes: 420

    steps:
      - name: Download Built App
        uses: actions/download-artifact@v4
        with:
          name: built-app
          path: apps/

      - name: Download QA Automation Code
        uses: actions/download-artifact@v4
        with:
          name: qa-code
          path: qa-automation/

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install Appium
        run: |
          npm install -g appium@latest 2>&1 | tail -1
          appium driver install xcuitest 2>&1 | tail -1
          echo "âœ… Appium $(appium --version)"

      - name: Boot Simulator
        run: |
          UDID=""
          for VERSION in 18.5 18.4 18.3 18.2 18.1 18.0; do
            for MODEL in "iPhone 16 Pro" "iPhone 15 Pro" "iPhone"; do
              UDID=$(xcrun simctl list devices available | grep -A 100 "iOS $VERSION" | grep "$MODEL" | head -1 | awk -F '[()]' '{print $2}')
              [ -n "$UDID" ] && break 2
            done
          done
          [ -z "$UDID" ] && echo "âŒ No simulator found!" && exit 1

          DEVICE_NAME=$(xcrun simctl list devices available | grep "$UDID" | sed 's/(.*//' | xargs)
          PLATFORM_VERSION=$(xcrun simctl list devices available | grep -B 20 "$UDID" | grep "iOS" | tail -1 | sed 's/-- iOS //' | sed 's/ --.*//')
          [ -z "$PLATFORM_VERSION" ] && PLATFORM_VERSION="18.5"

          echo "DEVICE_NAME=$DEVICE_NAME" >> $GITHUB_ENV
          echo "SIMULATOR_UDID=$UDID" >> $GITHUB_ENV
          echo "PLATFORM_VERSION=$PLATFORM_VERSION" >> $GITHUB_ENV
          echo "ðŸ“± $DEVICE_NAME | iOS $PLATFORM_VERSION | $UDID"

          xcrun simctl shutdown "$UDID" 2>/dev/null || true
          sleep 3
          xcrun simctl boot "$UDID" 2>/dev/null || true

          TIMEOUT=120; ELAPSED=0
          while [ $ELAPSED -lt $TIMEOUT ]; do
            if xcrun simctl list devices | grep "$UDID" | grep -q "(Booted)"; then
              echo "âœ… Booted after ${ELAPSED}s"; break
            fi
            sleep 5; ELAPSED=$((ELAPSED + 5))
          done
          if [ $ELAPSED -ge $TIMEOUT ]; then echo "âŒ Boot timeout"; exit 1; fi
          sleep 45
          echo "âœ… Simulator ready"

      - name: Install App on Simulator
        run: |
          APP_FILE=$(ls apps/ | grep ".app" | head -1)
          xcrun simctl install "${{ env.SIMULATOR_UDID }}" "apps/$APP_FILE"
          echo "âœ… App installed"

      - name: Pre-build WebDriverAgent
        run: |
          WDA_PATH=$(find ~/.appium -name "WebDriverAgent.xcodeproj" -type f 2>/dev/null | head -1 | xargs dirname)
          if [ -n "$WDA_PATH" ]; then
            cd "$WDA_PATH"
            xcodebuild build-for-testing -project WebDriverAgent.xcodeproj -scheme WebDriverAgentRunner \
              -destination "platform=iOS Simulator,id=${{ env.SIMULATOR_UDID }}" \
              -derivedDataPath /tmp/wda-build -quiet 2>&1 | tail -3
            echo "âœ… WDA pre-built"
          fi

      - name: Start Appium Server
        run: |
          appium --relaxed-security --log-level error > appium.log 2>&1 &
          for i in {1..60}; do
            if curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:4723/status 2>/dev/null | grep -q "200"; then
              echo "âœ… Appium ready"; break
            fi
            sleep 2
          done
          sleep 10

      - name: Warm-up WDA Session
        run: |
          APP_FILE=$(ls apps/ | grep ".app" | head -1)
          FULL_APP_PATH="${{ github.workspace }}/apps/$APP_FILE"

          for attempt in 1 2 3; do
            SESSION_RESPONSE=$(curl -s -X POST http://127.0.0.1:4723/session \
              -H "Content-Type: application/json" \
              -d '{"capabilities":{"alwaysMatch":{"platformName":"iOS","appium:automationName":"XCUITest","appium:deviceName":"'"${{ env.DEVICE_NAME }}"'","appium:udid":"'"${{ env.SIMULATOR_UDID }}"'","appium:platformVersion":"'"${{ env.PLATFORM_VERSION }}"'","appium:app":"'"$FULL_APP_PATH"'","appium:wdaLaunchTimeout":600000,"appium:wdaConnectionTimeout":300000,"appium:useNewWDA":false,"appium:noReset":false}}}' \
              --max-time 600 2>&1) || true
            SESSION_ID=$(echo "$SESSION_RESPONSE" | grep -o '"sessionId":"[^"]*"' | cut -d'"' -f4 || true)
            if [ -n "$SESSION_ID" ]; then
              echo "âœ… WDA warm-up OK"; sleep 10
              curl -s -X DELETE "http://127.0.0.1:4723/session/$SESSION_ID" || true
              sleep 5; break
            else
              [ $attempt -lt 3 ] && sleep 30
            fi
          done

      - name: Run Asset Part 1 Tests
        continue-on-error: true
        run: |
          cd qa-automation
          APP_FILE=$(ls ../apps/ | grep ".app" | head -1)
          APP_PATH="${{ github.workspace }}/apps/$APP_FILE"

          # Extract bundle ID from built app so soft restart uses correct ID
          BUNDLE_ID=$(/usr/libexec/PlistBuddy -c 'Print :CFBundleIdentifier' "$APP_PATH/Info.plist" 2>/dev/null || echo "com.egalvanic.zplatform-QA")

          mvn test -B -q \
            -DsuiteXmlFile=src/test/resources/parallel/testng-assets-part1.xml \
            -DDEVICE_NAME="${{ env.DEVICE_NAME }}" \
            -DPLATFORM_VERSION="${{ env.PLATFORM_VERSION }}" \
            -DSIMULATOR_UDID="${{ env.SIMULATOR_UDID }}" \
            -DAPP_PATH="$APP_PATH" \
            -DAPP_BUNDLE_ID="$BUNDLE_ID"

      - name: Upload Asset Part 1 Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: assets-part1-report
          path: |
            qa-automation/target/surefire-reports/
            qa-automation/reports/
            qa-automation/screenshots/
          retention-days: 7

      - name: Upload Appium Log (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: appium-log-assets-part1-${{ github.run_number }}
          path: appium.log
          retention-days: 7

      - name: Shutdown Simulator
        if: always()
        run: xcrun simctl shutdown "${{ env.SIMULATOR_UDID }}" 2>/dev/null || true

  # ============================================================
  # JOB 4: Asset Part 2 (108 tests, ~1.5 hr)
  # P1: Circuit Breaker (24) + Disconnect Switch (23) + Fuse (24)
  # P2: Generator (20) + Junction Box (17)
  # ============================================================
  assets-part2:
    name: "Assets P2 - CB + DS + Fuse + Generator + JunctionBox (108 tests)"
    needs: [build-app]
    if: github.event.inputs.job_selection == 'all' || github.event.inputs.job_selection == 'assets-p2-cb-ds-fuse-generator-junctionbox'
    runs-on: macos-15
    timeout-minutes: 420

    steps:
      - name: Download Built App
        uses: actions/download-artifact@v4
        with:
          name: built-app
          path: apps/

      - name: Download QA Automation Code
        uses: actions/download-artifact@v4
        with:
          name: qa-code
          path: qa-automation/

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install Appium
        run: |
          npm install -g appium@latest 2>&1 | tail -1
          appium driver install xcuitest 2>&1 | tail -1
          echo "âœ… Appium $(appium --version)"

      - name: Boot Simulator
        run: |
          UDID=""
          for VERSION in 18.5 18.4 18.3 18.2 18.1 18.0; do
            for MODEL in "iPhone 16 Pro" "iPhone 15 Pro" "iPhone"; do
              UDID=$(xcrun simctl list devices available | grep -A 100 "iOS $VERSION" | grep "$MODEL" | head -1 | awk -F '[()]' '{print $2}')
              [ -n "$UDID" ] && break 2
            done
          done
          [ -z "$UDID" ] && echo "âŒ No simulator found!" && exit 1

          DEVICE_NAME=$(xcrun simctl list devices available | grep "$UDID" | sed 's/(.*//' | xargs)
          PLATFORM_VERSION=$(xcrun simctl list devices available | grep -B 20 "$UDID" | grep "iOS" | tail -1 | sed 's/-- iOS //' | sed 's/ --.*//')
          [ -z "$PLATFORM_VERSION" ] && PLATFORM_VERSION="18.5"

          echo "DEVICE_NAME=$DEVICE_NAME" >> $GITHUB_ENV
          echo "SIMULATOR_UDID=$UDID" >> $GITHUB_ENV
          echo "PLATFORM_VERSION=$PLATFORM_VERSION" >> $GITHUB_ENV
          echo "ðŸ“± $DEVICE_NAME | iOS $PLATFORM_VERSION | $UDID"

          xcrun simctl shutdown "$UDID" 2>/dev/null || true
          sleep 3; xcrun simctl boot "$UDID" 2>/dev/null || true

          TIMEOUT=120; ELAPSED=0
          while [ $ELAPSED -lt $TIMEOUT ]; do
            if xcrun simctl list devices | grep "$UDID" | grep -q "(Booted)"; then
              echo "âœ… Booted after ${ELAPSED}s"; break
            fi
            sleep 5; ELAPSED=$((ELAPSED + 5))
          done
          if [ $ELAPSED -ge $TIMEOUT ]; then echo "âŒ Boot timeout"; exit 1; fi
          sleep 45; echo "âœ… Simulator ready"

      - name: Install App on Simulator
        run: |
          APP_FILE=$(ls apps/ | grep ".app" | head -1)
          xcrun simctl install "${{ env.SIMULATOR_UDID }}" "apps/$APP_FILE"

      - name: Pre-build WebDriverAgent
        run: |
          WDA_PATH=$(find ~/.appium -name "WebDriverAgent.xcodeproj" -type f 2>/dev/null | head -1 | xargs dirname)
          if [ -n "$WDA_PATH" ]; then
            cd "$WDA_PATH"
            xcodebuild build-for-testing -project WebDriverAgent.xcodeproj -scheme WebDriverAgentRunner \
              -destination "platform=iOS Simulator,id=${{ env.SIMULATOR_UDID }}" \
              -derivedDataPath /tmp/wda-build -quiet 2>&1 | tail -3
            echo "âœ… WDA pre-built"
          fi

      - name: Start Appium Server
        run: |
          appium --relaxed-security --log-level error > appium.log 2>&1 &
          for i in {1..60}; do
            if curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:4723/status 2>/dev/null | grep -q "200"; then
              echo "âœ… Appium ready"; break
            fi
            sleep 2
          done
          sleep 10

      - name: Warm-up WDA Session
        run: |
          APP_FILE=$(ls apps/ | grep ".app" | head -1)
          FULL_APP_PATH="${{ github.workspace }}/apps/$APP_FILE"

          for attempt in 1 2 3; do
            SESSION_RESPONSE=$(curl -s -X POST http://127.0.0.1:4723/session \
              -H "Content-Type: application/json" \
              -d '{"capabilities":{"alwaysMatch":{"platformName":"iOS","appium:automationName":"XCUITest","appium:deviceName":"'"${{ env.DEVICE_NAME }}"'","appium:udid":"'"${{ env.SIMULATOR_UDID }}"'","appium:platformVersion":"'"${{ env.PLATFORM_VERSION }}"'","appium:app":"'"$FULL_APP_PATH"'","appium:wdaLaunchTimeout":600000,"appium:wdaConnectionTimeout":300000,"appium:useNewWDA":false,"appium:noReset":false}}}' \
              --max-time 600 2>&1) || true
            SESSION_ID=$(echo "$SESSION_RESPONSE" | grep -o '"sessionId":"[^"]*"' | cut -d'"' -f4 || true)
            if [ -n "$SESSION_ID" ]; then
              echo "âœ… WDA warm-up OK"; sleep 10
              curl -s -X DELETE "http://127.0.0.1:4723/session/$SESSION_ID" || true
              sleep 5; break
            else
              [ $attempt -lt 3 ] && sleep 30
            fi
          done

      - name: Run Asset Part 2 Tests
        continue-on-error: true
        run: |
          cd qa-automation
          APP_FILE=$(ls ../apps/ | grep ".app" | head -1)
          APP_PATH="${{ github.workspace }}/apps/$APP_FILE"

          # Extract bundle ID from built app so soft restart uses correct ID
          BUNDLE_ID=$(/usr/libexec/PlistBuddy -c 'Print :CFBundleIdentifier' "$APP_PATH/Info.plist" 2>/dev/null || echo "com.egalvanic.zplatform-QA")

          mvn test -B -q \
            -DsuiteXmlFile=src/test/resources/parallel/testng-assets-part2.xml \
            -DDEVICE_NAME="${{ env.DEVICE_NAME }}" \
            -DPLATFORM_VERSION="${{ env.PLATFORM_VERSION }}" \
            -DSIMULATOR_UDID="${{ env.SIMULATOR_UDID }}" \
            -DAPP_PATH="$APP_PATH" \
            -DAPP_BUNDLE_ID="$BUNDLE_ID"

      - name: Upload Asset Part 2 Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: assets-part2-report
          path: |
            qa-automation/target/surefire-reports/
            qa-automation/reports/
            qa-automation/screenshots/
          retention-days: 7

      - name: Upload Appium Log (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: appium-log-assets-part2-${{ github.run_number }}
          path: appium.log
          retention-days: 7

      - name: Shutdown Simulator
        if: always()
        run: xcrun simctl shutdown "${{ env.SIMULATOR_UDID }}" 2>/dev/null || true

  # ============================================================
  # JOB 5: Asset Part 3 (109 tests, ~1.5 hr)
  # P2: Load Center (28) + MCC (26) + MCC Bucket (12) + Motor (30) + Other (13)
  # ============================================================
  assets-part3:
    name: "Assets P3 - LoadCenter + MCC + MCC Bucket + Motor + Other (109 tests)"
    needs: [build-app]
    if: github.event.inputs.job_selection == 'all' || github.event.inputs.job_selection == 'assets-p3-loadcenter-mcc-mccbucket-motor-other'
    runs-on: macos-15
    timeout-minutes: 420

    steps:
      - name: Download Built App
        uses: actions/download-artifact@v4
        with:
          name: built-app
          path: apps/

      - name: Download QA Automation Code
        uses: actions/download-artifact@v4
        with:
          name: qa-code
          path: qa-automation/

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install Appium
        run: |
          npm install -g appium@latest 2>&1 | tail -1
          appium driver install xcuitest 2>&1 | tail -1
          echo "âœ… Appium $(appium --version)"

      - name: Boot Simulator
        run: |
          UDID=""
          for VERSION in 18.5 18.4 18.3 18.2 18.1 18.0; do
            for MODEL in "iPhone 16 Pro" "iPhone 15 Pro" "iPhone"; do
              UDID=$(xcrun simctl list devices available | grep -A 100 "iOS $VERSION" | grep "$MODEL" | head -1 | awk -F '[()]' '{print $2}')
              [ -n "$UDID" ] && break 2
            done
          done
          [ -z "$UDID" ] && echo "âŒ No simulator found!" && exit 1

          DEVICE_NAME=$(xcrun simctl list devices available | grep "$UDID" | sed 's/(.*//' | xargs)
          PLATFORM_VERSION=$(xcrun simctl list devices available | grep -B 20 "$UDID" | grep "iOS" | tail -1 | sed 's/-- iOS //' | sed 's/ --.*//')
          [ -z "$PLATFORM_VERSION" ] && PLATFORM_VERSION="18.5"

          echo "DEVICE_NAME=$DEVICE_NAME" >> $GITHUB_ENV
          echo "SIMULATOR_UDID=$UDID" >> $GITHUB_ENV
          echo "PLATFORM_VERSION=$PLATFORM_VERSION" >> $GITHUB_ENV

          xcrun simctl shutdown "$UDID" 2>/dev/null || true
          sleep 3; xcrun simctl boot "$UDID" 2>/dev/null || true

          TIMEOUT=120; ELAPSED=0
          while [ $ELAPSED -lt $TIMEOUT ]; do
            if xcrun simctl list devices | grep "$UDID" | grep -q "(Booted)"; then
              echo "âœ… Booted after ${ELAPSED}s"; break
            fi
            sleep 5; ELAPSED=$((ELAPSED + 5))
          done
          if [ $ELAPSED -ge $TIMEOUT ]; then echo "âŒ Boot timeout"; exit 1; fi
          sleep 45; echo "âœ… Simulator ready"

      - name: Install App on Simulator
        run: |
          APP_FILE=$(ls apps/ | grep ".app" | head -1)
          xcrun simctl install "${{ env.SIMULATOR_UDID }}" "apps/$APP_FILE"

      - name: Pre-build WebDriverAgent
        run: |
          WDA_PATH=$(find ~/.appium -name "WebDriverAgent.xcodeproj" -type f 2>/dev/null | head -1 | xargs dirname)
          if [ -n "$WDA_PATH" ]; then
            cd "$WDA_PATH"
            xcodebuild build-for-testing -project WebDriverAgent.xcodeproj -scheme WebDriverAgentRunner \
              -destination "platform=iOS Simulator,id=${{ env.SIMULATOR_UDID }}" \
              -derivedDataPath /tmp/wda-build -quiet 2>&1 | tail -3
            echo "âœ… WDA pre-built"
          fi

      - name: Start Appium Server
        run: |
          appium --relaxed-security --log-level error > appium.log 2>&1 &
          for i in {1..60}; do
            if curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:4723/status 2>/dev/null | grep -q "200"; then
              echo "âœ… Appium ready"; break
            fi
            sleep 2
          done
          sleep 10

      - name: Warm-up WDA Session
        run: |
          APP_FILE=$(ls apps/ | grep ".app" | head -1)
          FULL_APP_PATH="${{ github.workspace }}/apps/$APP_FILE"
          for attempt in 1 2 3; do
            SESSION_RESPONSE=$(curl -s -X POST http://127.0.0.1:4723/session \
              -H "Content-Type: application/json" \
              -d '{"capabilities":{"alwaysMatch":{"platformName":"iOS","appium:automationName":"XCUITest","appium:deviceName":"'"${{ env.DEVICE_NAME }}"'","appium:udid":"'"${{ env.SIMULATOR_UDID }}"'","appium:platformVersion":"'"${{ env.PLATFORM_VERSION }}"'","appium:app":"'"$FULL_APP_PATH"'","appium:wdaLaunchTimeout":600000,"appium:wdaConnectionTimeout":300000,"appium:useNewWDA":false,"appium:noReset":false}}}' \
              --max-time 600 2>&1) || true
            SESSION_ID=$(echo "$SESSION_RESPONSE" | grep -o '"sessionId":"[^"]*"' | cut -d'"' -f4 || true)
            if [ -n "$SESSION_ID" ]; then
              echo "âœ… WDA warm-up OK"; sleep 10
              curl -s -X DELETE "http://127.0.0.1:4723/session/$SESSION_ID" || true; sleep 5; break
            else
              [ $attempt -lt 3 ] && sleep 30
            fi
          done

      - name: Run Asset Part 3 Tests
        continue-on-error: true
        run: |
          cd qa-automation
          APP_FILE=$(ls ../apps/ | grep ".app" | head -1)
          APP_PATH="${{ github.workspace }}/apps/$APP_FILE"

          # Extract bundle ID from built app so soft restart uses correct ID
          BUNDLE_ID=$(/usr/libexec/PlistBuddy -c 'Print :CFBundleIdentifier' "$APP_PATH/Info.plist" 2>/dev/null || echo "com.egalvanic.zplatform-QA")

          mvn test -B -q \
            -DsuiteXmlFile=src/test/resources/parallel/testng-assets-part3.xml \
            -DDEVICE_NAME="${{ env.DEVICE_NAME }}" \
            -DPLATFORM_VERSION="${{ env.PLATFORM_VERSION }}" \
            -DSIMULATOR_UDID="${{ env.SIMULATOR_UDID }}" \
            -DAPP_PATH="$APP_PATH" \
            -DAPP_BUNDLE_ID="$BUNDLE_ID"

      - name: Upload Asset Part 3 Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: assets-part3-report
          path: |
            qa-automation/target/surefire-reports/
            qa-automation/reports/
            qa-automation/screenshots/
          retention-days: 7

      - name: Upload Appium Log (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: appium-log-assets-part3-${{ github.run_number }}
          path: appium.log
          retention-days: 7

      - name: Shutdown Simulator
        if: always()
        run: xcrun simctl shutdown "${{ env.SIMULATOR_UDID }}" 2>/dev/null || true


  # ============================================================
  # JOB 6: Asset Part 4 (97 tests, ~1.5 hr)
  # P2: Over-Current Protective Device (13)
  # P3: Panelboard (14) + PDU (15) + Relay (14) + Switchboard (18) + Transformer (23)
  # ============================================================
  assets-part4:
    name: "Assets P4 - OCP + Panelboard + PDU + Relay + SWB + Transformer (97 tests)"
    needs: [build-app]
    if: github.event.inputs.job_selection == 'all' || github.event.inputs.job_selection == 'assets-p4-ocp-panelboard-pdu-relay-swb-transformer'
    runs-on: macos-15
    timeout-minutes: 420

    steps:
      - name: Download Built App
        uses: actions/download-artifact@v4
        with:
          name: built-app
          path: apps/

      - name: Download QA Automation Code
        uses: actions/download-artifact@v4
        with:
          name: qa-code
          path: qa-automation/

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install Appium
        run: |
          npm install -g appium@latest 2>&1 | tail -1
          appium driver install xcuitest 2>&1 | tail -1
          echo "âœ… Appium $(appium --version)"

      - name: Boot Simulator
        run: |
          UDID=""
          for VERSION in 18.5 18.4 18.3 18.2 18.1 18.0; do
            for MODEL in "iPhone 16 Pro" "iPhone 15 Pro" "iPhone"; do
              UDID=$(xcrun simctl list devices available | grep -A 100 "iOS $VERSION" | grep "$MODEL" | head -1 | awk -F '[()]' '{print $2}')
              [ -n "$UDID" ] && break 2
            done
          done
          [ -z "$UDID" ] && echo "âŒ No simulator found!" && exit 1

          DEVICE_NAME=$(xcrun simctl list devices available | grep "$UDID" | sed 's/(.*//' | xargs)
          PLATFORM_VERSION=$(xcrun simctl list devices available | grep -B 20 "$UDID" | grep "iOS" | tail -1 | sed 's/-- iOS //' | sed 's/ --.*//')
          [ -z "$PLATFORM_VERSION" ] && PLATFORM_VERSION="18.5"

          echo "DEVICE_NAME=$DEVICE_NAME" >> $GITHUB_ENV
          echo "SIMULATOR_UDID=$UDID" >> $GITHUB_ENV
          echo "PLATFORM_VERSION=$PLATFORM_VERSION" >> $GITHUB_ENV

          xcrun simctl shutdown "$UDID" 2>/dev/null || true
          sleep 3; xcrun simctl boot "$UDID" 2>/dev/null || true

          TIMEOUT=120; ELAPSED=0
          while [ $ELAPSED -lt $TIMEOUT ]; do
            if xcrun simctl list devices | grep "$UDID" | grep -q "(Booted)"; then
              echo "âœ… Booted after ${ELAPSED}s"; break
            fi
            sleep 5; ELAPSED=$((ELAPSED + 5))
          done
          if [ $ELAPSED -ge $TIMEOUT ]; then echo "âŒ Boot timeout"; exit 1; fi
          sleep 45; echo "âœ… Simulator ready"

      - name: Install App on Simulator
        run: |
          APP_FILE=$(ls apps/ | grep ".app" | head -1)
          xcrun simctl install "${{ env.SIMULATOR_UDID }}" "apps/$APP_FILE"

      - name: Pre-build WebDriverAgent
        run: |
          WDA_PATH=$(find ~/.appium -name "WebDriverAgent.xcodeproj" -type f 2>/dev/null | head -1 | xargs dirname)
          if [ -n "$WDA_PATH" ]; then
            cd "$WDA_PATH"
            xcodebuild build-for-testing -project WebDriverAgent.xcodeproj -scheme WebDriverAgentRunner \
              -destination "platform=iOS Simulator,id=${{ env.SIMULATOR_UDID }}" \
              -derivedDataPath /tmp/wda-build -quiet 2>&1 | tail -3
            echo "âœ… WDA pre-built"
          fi

      - name: Start Appium Server
        run: |
          appium --relaxed-security --log-level error > appium.log 2>&1 &
          for i in {1..60}; do
            if curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:4723/status 2>/dev/null | grep -q "200"; then
              echo "âœ… Appium ready"; break
            fi
            sleep 2
          done
          sleep 10

      - name: Warm-up WDA Session
        run: |
          APP_FILE=$(ls apps/ | grep ".app" | head -1)
          FULL_APP_PATH="${{ github.workspace }}/apps/$APP_FILE"
          for attempt in 1 2 3; do
            SESSION_RESPONSE=$(curl -s -X POST http://127.0.0.1:4723/session \
              -H "Content-Type: application/json" \
              -d '{"capabilities":{"alwaysMatch":{"platformName":"iOS","appium:automationName":"XCUITest","appium:deviceName":"'"${{ env.DEVICE_NAME }}"'","appium:udid":"'"${{ env.SIMULATOR_UDID }}"'","appium:platformVersion":"'"${{ env.PLATFORM_VERSION }}"'","appium:app":"'"$FULL_APP_PATH"'","appium:wdaLaunchTimeout":600000,"appium:wdaConnectionTimeout":300000,"appium:useNewWDA":false,"appium:noReset":false}}}' \
              --max-time 600 2>&1) || true
            SESSION_ID=$(echo "$SESSION_RESPONSE" | grep -o '"sessionId":"[^"]*"' | cut -d'"' -f4 || true)
            if [ -n "$SESSION_ID" ]; then
              echo "âœ… WDA warm-up OK"; sleep 10
              curl -s -X DELETE "http://127.0.0.1:4723/session/$SESSION_ID" || true; sleep 5; break
            else
              [ $attempt -lt 3 ] && sleep 30
            fi
          done

      - name: Run Asset Part 4 Tests
        continue-on-error: true
        run: |
          cd qa-automation
          APP_FILE=$(ls ../apps/ | grep ".app" | head -1)
          APP_PATH="${{ github.workspace }}/apps/$APP_FILE"

          # Extract bundle ID from built app so soft restart uses correct ID
          BUNDLE_ID=$(/usr/libexec/PlistBuddy -c 'Print :CFBundleIdentifier' "$APP_PATH/Info.plist" 2>/dev/null || echo "com.egalvanic.zplatform-QA")

          mvn test -B -q \
            -DsuiteXmlFile=src/test/resources/parallel/testng-assets-part4.xml \
            -DDEVICE_NAME="${{ env.DEVICE_NAME }}" \
            -DPLATFORM_VERSION="${{ env.PLATFORM_VERSION }}" \
            -DSIMULATOR_UDID="${{ env.SIMULATOR_UDID }}" \
            -DAPP_PATH="$APP_PATH" \
            -DAPP_BUNDLE_ID="$BUNDLE_ID"

      - name: Upload Asset Part 4 Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: assets-part4-report
          path: |
            qa-automation/target/surefire-reports/
            qa-automation/reports/
            qa-automation/screenshots/
          retention-days: 7

      - name: Upload Appium Log (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: appium-log-assets-part4-${{ github.run_number }}
          path: appium.log
          retention-days: 7

      - name: Shutdown Simulator
        if: always()
        run: xcrun simctl shutdown "${{ env.SIMULATOR_UDID }}" 2>/dev/null || true

  # ============================================================
  # JOB 7: Asset Part 5 (112 tests, ~1.5 hr)
  # P3: UPS (15) + Utility (9) + VFD (8) + ATS Subtypes (13) + Bus Subtypes (11)
  #     + Cap Subtypes (6) + CB Subtypes (14) + Default (9)
  # P4: Disconnect Switch Subtypes (16) + Fuse Subtypes (11)
  # ============================================================
  assets-part5:
    name: "Assets P5 - UPS + Utility + VFD + Subtypes (112 tests)"
    needs: [build-app]
    if: github.event.inputs.job_selection == 'all' || github.event.inputs.job_selection == 'assets-p5-ups-utility-vfd-subtypes'
    runs-on: macos-15
    timeout-minutes: 420

    steps:
      - name: Download Built App
        uses: actions/download-artifact@v4
        with:
          name: built-app
          path: apps/

      - name: Download QA Automation Code
        uses: actions/download-artifact@v4
        with:
          name: qa-code
          path: qa-automation/

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install Appium
        run: |
          npm install -g appium@latest 2>&1 | tail -1
          appium driver install xcuitest 2>&1 | tail -1
          echo "âœ… Appium $(appium --version)"

      - name: Boot Simulator
        run: |
          UDID=""
          for VERSION in 18.5 18.4 18.3 18.2 18.1 18.0; do
            for MODEL in "iPhone 16 Pro" "iPhone 15 Pro" "iPhone"; do
              UDID=$(xcrun simctl list devices available | grep -A 100 "iOS $VERSION" | grep "$MODEL" | head -1 | awk -F '[()]' '{print $2}')
              [ -n "$UDID" ] && break 2
            done
          done
          [ -z "$UDID" ] && echo "âŒ No simulator found!" && exit 1

          DEVICE_NAME=$(xcrun simctl list devices available | grep "$UDID" | sed 's/(.*//' | xargs)
          PLATFORM_VERSION=$(xcrun simctl list devices available | grep -B 20 "$UDID" | grep "iOS" | tail -1 | sed 's/-- iOS //' | sed 's/ --.*//')
          [ -z "$PLATFORM_VERSION" ] && PLATFORM_VERSION="18.5"

          echo "DEVICE_NAME=$DEVICE_NAME" >> $GITHUB_ENV
          echo "SIMULATOR_UDID=$UDID" >> $GITHUB_ENV
          echo "PLATFORM_VERSION=$PLATFORM_VERSION" >> $GITHUB_ENV

          xcrun simctl shutdown "$UDID" 2>/dev/null || true
          sleep 3; xcrun simctl boot "$UDID" 2>/dev/null || true

          TIMEOUT=120; ELAPSED=0
          while [ $ELAPSED -lt $TIMEOUT ]; do
            if xcrun simctl list devices | grep "$UDID" | grep -q "(Booted)"; then
              echo "âœ… Booted after ${ELAPSED}s"; break
            fi
            sleep 5; ELAPSED=$((ELAPSED + 5))
          done
          if [ $ELAPSED -ge $TIMEOUT ]; then echo "âŒ Boot timeout"; exit 1; fi
          sleep 45; echo "âœ… Simulator ready"

      - name: Install App on Simulator
        run: |
          APP_FILE=$(ls apps/ | grep ".app" | head -1)
          xcrun simctl install "${{ env.SIMULATOR_UDID }}" "apps/$APP_FILE"

      - name: Pre-build WebDriverAgent
        run: |
          WDA_PATH=$(find ~/.appium -name "WebDriverAgent.xcodeproj" -type f 2>/dev/null | head -1 | xargs dirname)
          if [ -n "$WDA_PATH" ]; then
            cd "$WDA_PATH"
            xcodebuild build-for-testing -project WebDriverAgent.xcodeproj -scheme WebDriverAgentRunner \
              -destination "platform=iOS Simulator,id=${{ env.SIMULATOR_UDID }}" \
              -derivedDataPath /tmp/wda-build -quiet 2>&1 | tail -3
            echo "âœ… WDA pre-built"
          fi

      - name: Start Appium Server
        run: |
          appium --relaxed-security --log-level error > appium.log 2>&1 &
          for i in {1..60}; do
            if curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:4723/status 2>/dev/null | grep -q "200"; then
              echo "âœ… Appium ready"; break
            fi
            sleep 2
          done
          sleep 10

      - name: Warm-up WDA Session
        run: |
          APP_FILE=$(ls apps/ | grep ".app" | head -1)
          FULL_APP_PATH="${{ github.workspace }}/apps/$APP_FILE"
          for attempt in 1 2 3; do
            SESSION_RESPONSE=$(curl -s -X POST http://127.0.0.1:4723/session \
              -H "Content-Type: application/json" \
              -d '{"capabilities":{"alwaysMatch":{"platformName":"iOS","appium:automationName":"XCUITest","appium:deviceName":"'"${{ env.DEVICE_NAME }}"'","appium:udid":"'"${{ env.SIMULATOR_UDID }}"'","appium:platformVersion":"'"${{ env.PLATFORM_VERSION }}"'","appium:app":"'"$FULL_APP_PATH"'","appium:wdaLaunchTimeout":600000,"appium:wdaConnectionTimeout":300000,"appium:useNewWDA":false,"appium:noReset":false}}}' \
              --max-time 600 2>&1) || true
            SESSION_ID=$(echo "$SESSION_RESPONSE" | grep -o '"sessionId":"[^"]*"' | cut -d'"' -f4 || true)
            if [ -n "$SESSION_ID" ]; then
              echo "âœ… WDA warm-up OK"; sleep 10
              curl -s -X DELETE "http://127.0.0.1:4723/session/$SESSION_ID" || true; sleep 5; break
            else
              [ $attempt -lt 3 ] && sleep 30
            fi
          done

      - name: Run Asset Part 5 Tests
        continue-on-error: true
        run: |
          cd qa-automation
          APP_FILE=$(ls ../apps/ | grep ".app" | head -1)
          APP_PATH="${{ github.workspace }}/apps/$APP_FILE"

          # Extract bundle ID from built app so soft restart uses correct ID
          BUNDLE_ID=$(/usr/libexec/PlistBuddy -c 'Print :CFBundleIdentifier' "$APP_PATH/Info.plist" 2>/dev/null || echo "com.egalvanic.zplatform-QA")

          mvn test -B -q \
            -DsuiteXmlFile=src/test/resources/parallel/testng-assets-part5.xml \
            -DDEVICE_NAME="${{ env.DEVICE_NAME }}" \
            -DPLATFORM_VERSION="${{ env.PLATFORM_VERSION }}" \
            -DSIMULATOR_UDID="${{ env.SIMULATOR_UDID }}" \
            -DAPP_PATH="$APP_PATH" \
            -DAPP_BUNDLE_ID="$BUNDLE_ID"

      - name: Upload Asset Part 5 Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: assets-part5-report
          path: |
            qa-automation/target/surefire-reports/
            qa-automation/reports/
            qa-automation/screenshots/
          retention-days: 7

      - name: Upload Appium Log (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: appium-log-assets-part5-${{ github.run_number }}
          path: appium.log
          retention-days: 7

      - name: Shutdown Simulator
        if: always()
        run: xcrun simctl shutdown "${{ env.SIMULATOR_UDID }}" 2>/dev/null || true

  # ============================================================
  # JOB 8: Asset Part 6 (114 tests, ~1.5 hr)
  # P4: Generator Subtypes (4) + JB Subtypes (1) + LC Subtypes (1) + MCC Subtypes (4)
  #     + MCCB Subtypes (1) + Motor Subtypes (4) + OCP Subtypes (1) + PB Subtypes (3)
  #     + PDU Subtypes (1) + Relay Subtypes (4) + SWB Subtypes (4) + TRF Subtypes (4)
  #     + UPS Subtypes (4) + UTL Subtypes (1) + VFD Subtypes (1) + Common (2)
  #     + Tasks (6) + ETD (10) + Issues (10) + Non-Conformance (9)
  #     + LC Connections (9) + MCC OCP (19) + Asset Screen (11)
  # ============================================================
  assets-part6:
    name: "Assets P6 - Subtypes + Tasks + Issues + Connections + Search (114 tests)"
    needs: [build-app]
    if: github.event.inputs.job_selection == 'all' || github.event.inputs.job_selection == 'assets-p6-subtypes-tasks-issues-connections-search'
    runs-on: macos-15
    timeout-minutes: 420

    steps:
      - name: Download Built App
        uses: actions/download-artifact@v4
        with:
          name: built-app
          path: apps/

      - name: Download QA Automation Code
        uses: actions/download-artifact@v4
        with:
          name: qa-code
          path: qa-automation/

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install Appium
        run: |
          npm install -g appium@latest 2>&1 | tail -1
          appium driver install xcuitest 2>&1 | tail -1
          echo "âœ… Appium $(appium --version)"

      - name: Boot Simulator
        run: |
          UDID=""
          for VERSION in 18.5 18.4 18.3 18.2 18.1 18.0; do
            for MODEL in "iPhone 16 Pro" "iPhone 15 Pro" "iPhone"; do
              UDID=$(xcrun simctl list devices available | grep -A 100 "iOS $VERSION" | grep "$MODEL" | head -1 | awk -F '[()]' '{print $2}')
              [ -n "$UDID" ] && break 2
            done
          done
          [ -z "$UDID" ] && echo "âŒ No simulator found!" && exit 1

          DEVICE_NAME=$(xcrun simctl list devices available | grep "$UDID" | sed 's/(.*//' | xargs)
          PLATFORM_VERSION=$(xcrun simctl list devices available | grep -B 20 "$UDID" | grep "iOS" | tail -1 | sed 's/-- iOS //' | sed 's/ --.*//')
          [ -z "$PLATFORM_VERSION" ] && PLATFORM_VERSION="18.5"

          echo "DEVICE_NAME=$DEVICE_NAME" >> $GITHUB_ENV
          echo "SIMULATOR_UDID=$UDID" >> $GITHUB_ENV
          echo "PLATFORM_VERSION=$PLATFORM_VERSION" >> $GITHUB_ENV
          echo "ðŸ“± $DEVICE_NAME | iOS $PLATFORM_VERSION | $UDID"

          xcrun simctl shutdown "$UDID" 2>/dev/null || true
          sleep 3; xcrun simctl boot "$UDID" 2>/dev/null || true

          TIMEOUT=120; ELAPSED=0
          while [ $ELAPSED -lt $TIMEOUT ]; do
            if xcrun simctl list devices | grep "$UDID" | grep -q "(Booted)"; then
              echo "âœ… Booted after ${ELAPSED}s"; break
            fi
            sleep 5; ELAPSED=$((ELAPSED + 5))
          done
          if [ $ELAPSED -ge $TIMEOUT ]; then echo "âŒ Boot timeout"; exit 1; fi
          sleep 45; echo "âœ… Simulator ready"

      - name: Install App on Simulator
        run: |
          APP_FILE=$(ls apps/ | grep ".app" | head -1)
          xcrun simctl install "${{ env.SIMULATOR_UDID }}" "apps/$APP_FILE"

      - name: Pre-build WebDriverAgent
        run: |
          WDA_PATH=$(find ~/.appium -name "WebDriverAgent.xcodeproj" -type f 2>/dev/null | head -1 | xargs dirname)
          if [ -n "$WDA_PATH" ]; then
            cd "$WDA_PATH"
            xcodebuild build-for-testing -project WebDriverAgent.xcodeproj -scheme WebDriverAgentRunner \
              -destination "platform=iOS Simulator,id=${{ env.SIMULATOR_UDID }}" \
              -derivedDataPath /tmp/wda-build -quiet 2>&1 | tail -3
            echo "âœ… WDA pre-built"
          fi

      - name: Start Appium Server
        run: |
          appium --relaxed-security --log-level error > appium.log 2>&1 &
          for i in {1..60}; do
            if curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:4723/status 2>/dev/null | grep -q "200"; then
              echo "âœ… Appium ready"; break
            fi
            sleep 2
          done
          sleep 10

      - name: Warm-up WDA Session
        run: |
          APP_FILE=$(ls apps/ | grep ".app" | head -1)
          FULL_APP_PATH="${{ github.workspace }}/apps/$APP_FILE"
          for attempt in 1 2 3; do
            SESSION_RESPONSE=$(curl -s -X POST http://127.0.0.1:4723/session \
              -H "Content-Type: application/json" \
              -d '{"capabilities":{"alwaysMatch":{"platformName":"iOS","appium:automationName":"XCUITest","appium:deviceName":"'"${{ env.DEVICE_NAME }}"'","appium:udid":"'"${{ env.SIMULATOR_UDID }}"'","appium:platformVersion":"'"${{ env.PLATFORM_VERSION }}"'","appium:app":"'"$FULL_APP_PATH"'","appium:wdaLaunchTimeout":600000,"appium:wdaConnectionTimeout":300000,"appium:useNewWDA":false,"appium:noReset":false}}}' \
              --max-time 600 2>&1) || true
            SESSION_ID=$(echo "$SESSION_RESPONSE" | grep -o '"sessionId":"[^"]*"' | cut -d'"' -f4 || true)
            if [ -n "$SESSION_ID" ]; then
              echo "âœ… WDA warm-up OK"; sleep 10
              curl -s -X DELETE "http://127.0.0.1:4723/session/$SESSION_ID" || true; sleep 5; break
            else
              [ $attempt -lt 3 ] && sleep 30
            fi
          done

      - name: Run Asset Part 6 Tests
        continue-on-error: true
        run: |
          cd qa-automation
          APP_FILE=$(ls ../apps/ | grep ".app" | head -1)
          APP_PATH="${{ github.workspace }}/apps/$APP_FILE"

          # Extract bundle ID from built app so soft restart uses correct ID
          BUNDLE_ID=$(/usr/libexec/PlistBuddy -c 'Print :CFBundleIdentifier' "$APP_PATH/Info.plist" 2>/dev/null || echo "com.egalvanic.zplatform-QA")

          mvn test -B -q \
            -DsuiteXmlFile=src/test/resources/parallel/testng-assets-part6.xml \
            -DDEVICE_NAME="${{ env.DEVICE_NAME }}" \
            -DPLATFORM_VERSION="${{ env.PLATFORM_VERSION }}" \
            -DSIMULATOR_UDID="${{ env.SIMULATOR_UDID }}" \
            -DAPP_PATH="$APP_PATH" \
            -DAPP_BUNDLE_ID="$BUNDLE_ID"

      - name: Upload Asset Part 6 Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: assets-part6-report
          path: |
            qa-automation/target/surefire-reports/
            qa-automation/reports/
            qa-automation/screenshots/
          retention-days: 7

      - name: Upload Appium Log (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: appium-log-assets-part6-${{ github.run_number }}
          path: appium.log
          retention-days: 7

      - name: Shutdown Simulator
        if: always()
        run: xcrun simctl shutdown "${{ env.SIMULATOR_UDID }}" 2>/dev/null || true

  # ============================================================
  # JOB 9: Issues Phase 1 (119 tests â€” List, Filter, Search, Creation, Class Change)
  # ============================================================
  issues-phase1:
    name: "Issues P1 - List + Filter + Search + Creation + ClassChange (119 tests)"
    needs: [build-app]
    if: github.event.inputs.job_selection == 'all' || github.event.inputs.job_selection == 'issues-p1-list-filter-search-creation-classchange'
    runs-on: macos-15
    timeout-minutes: 420

    steps:
      - name: Download Built App
        uses: actions/download-artifact@v4
        with:
          name: built-app
          path: apps/

      - name: Download QA Automation Code
        uses: actions/download-artifact@v4
        with:
          name: qa-code
          path: qa-automation/

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install Appium
        run: |
          npm install -g appium@latest 2>&1 | tail -1
          appium driver install xcuitest 2>&1 | tail -1
          echo "âœ… Appium $(appium --version)"

      - name: Boot Simulator
        run: |
          UDID=""
          for VERSION in 18.5 18.4 18.3 18.2 18.1 18.0; do
            for MODEL in "iPhone 16 Pro" "iPhone 15 Pro" "iPhone"; do
              UDID=$(xcrun simctl list devices available | grep -A 100 "iOS $VERSION" | grep "$MODEL" | head -1 | awk -F '[()]' '{print $2}')
              [ -n "$UDID" ] && break 2
            done
          done
          [ -z "$UDID" ] && echo "âŒ No simulator found!" && exit 1

          DEVICE_NAME=$(xcrun simctl list devices available | grep "$UDID" | sed 's/(.*//' | xargs)
          PLATFORM_VERSION=$(xcrun simctl list devices available | grep -B 20 "$UDID" | grep "iOS" | tail -1 | sed 's/-- iOS //' | sed 's/ --.*//')
          [ -z "$PLATFORM_VERSION" ] && PLATFORM_VERSION="18.5"

          echo "DEVICE_NAME=$DEVICE_NAME" >> $GITHUB_ENV
          echo "SIMULATOR_UDID=$UDID" >> $GITHUB_ENV
          echo "PLATFORM_VERSION=$PLATFORM_VERSION" >> $GITHUB_ENV
          echo "ðŸ“± $DEVICE_NAME | iOS $PLATFORM_VERSION | $UDID"

          xcrun simctl shutdown "$UDID" 2>/dev/null || true
          sleep 3; xcrun simctl boot "$UDID" 2>/dev/null || true

          TIMEOUT=120; ELAPSED=0
          while [ $ELAPSED -lt $TIMEOUT ]; do
            if xcrun simctl list devices | grep "$UDID" | grep -q "(Booted)"; then
              echo "âœ… Booted after ${ELAPSED}s"; break
            fi
            sleep 5; ELAPSED=$((ELAPSED + 5))
          done
          if [ $ELAPSED -ge $TIMEOUT ]; then echo "âŒ Boot timeout"; exit 1; fi
          sleep 45; echo "âœ… Simulator ready"

      - name: Install App on Simulator
        run: |
          APP_FILE=$(ls apps/ | grep ".app" | head -1)
          xcrun simctl install "${{ env.SIMULATOR_UDID }}" "apps/$APP_FILE"

      - name: Pre-build WebDriverAgent
        run: |
          WDA_PATH=$(find ~/.appium -name "WebDriverAgent.xcodeproj" -type f 2>/dev/null | head -1 | xargs dirname)
          if [ -n "$WDA_PATH" ]; then
            cd "$WDA_PATH"
            xcodebuild build-for-testing -project WebDriverAgent.xcodeproj -scheme WebDriverAgentRunner \
              -destination "platform=iOS Simulator,id=${{ env.SIMULATOR_UDID }}" \
              -derivedDataPath /tmp/wda-build -quiet 2>&1 | tail -3
            echo "âœ… WDA pre-built"
          fi

      - name: Start Appium Server
        run: |
          appium --relaxed-security --log-level error > appium.log 2>&1 &
          for i in {1..60}; do
            if curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:4723/status 2>/dev/null | grep -q "200"; then
              echo "âœ… Appium ready"; break
            fi
            sleep 2
          done
          sleep 10

      - name: Warm-up WDA Session
        run: |
          APP_FILE=$(ls apps/ | grep ".app" | head -1)
          FULL_APP_PATH="${{ github.workspace }}/apps/$APP_FILE"
          for attempt in 1 2 3; do
            SESSION_RESPONSE=$(curl -s -X POST http://127.0.0.1:4723/session \
              -H "Content-Type: application/json" \
              -d '{"capabilities":{"alwaysMatch":{"platformName":"iOS","appium:automationName":"XCUITest","appium:deviceName":"'"${{ env.DEVICE_NAME }}"'","appium:udid":"'"${{ env.SIMULATOR_UDID }}"'","appium:platformVersion":"'"${{ env.PLATFORM_VERSION }}"'","appium:app":"'"$FULL_APP_PATH"'","appium:wdaLaunchTimeout":600000,"appium:wdaConnectionTimeout":300000,"appium:useNewWDA":false,"appium:noReset":false}}}' \
              --max-time 600 2>&1) || true
            SESSION_ID=$(echo "$SESSION_RESPONSE" | grep -o '"sessionId":"[^"]*"' | cut -d'"' -f4 || true)
            if [ -n "$SESSION_ID" ]; then
              echo "âœ… WDA warm-up OK"; sleep 10
              curl -s -X DELETE "http://127.0.0.1:4723/session/$SESSION_ID" || true; sleep 5; break
            else
              [ $attempt -lt 3 ] && sleep 30
            fi
          done

      - name: Run Issues Phase 1 Tests
        continue-on-error: true
        run: |
          cd qa-automation
          APP_FILE=$(ls ../apps/ | grep ".app" | head -1)
          APP_PATH="${{ github.workspace }}/apps/$APP_FILE"

          # Extract bundle ID from built app so soft restart uses correct ID
          BUNDLE_ID=$(/usr/libexec/PlistBuddy -c 'Print :CFBundleIdentifier' "$APP_PATH/Info.plist" 2>/dev/null || echo "com.egalvanic.zplatform-QA")

          mvn test -B -q \
            -DsuiteXmlFile=src/test/resources/parallel/testng-issues-phase1.xml \
            -DDEVICE_NAME="${{ env.DEVICE_NAME }}" \
            -DPLATFORM_VERSION="${{ env.PLATFORM_VERSION }}" \
            -DSIMULATOR_UDID="${{ env.SIMULATOR_UDID }}" \
            -DAPP_PATH="$APP_PATH" \
            -DAPP_BUNDLE_ID="$BUNDLE_ID"

      - name: Upload Issues Phase 1 Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: issues-phase1-report
          path: |
            qa-automation/target/surefire-reports/
            qa-automation/reports/
            qa-automation/screenshots/
          retention-days: 7

      - name: Upload Appium Log (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: appium-log-issues-phase1-${{ github.run_number }}
          path: appium.log
          retention-days: 7

      - name: Shutdown Simulator
        if: always()
        run: xcrun simctl shutdown "${{ env.SIMULATOR_UDID }}" 2>/dev/null || true

  # ============================================================
  # JOB 10: Issues Phase 2 (60 tests â€” OSHA, Thermal, Severity, Temperature, Ultrasonic)
  # ============================================================
  issues-phase2:
    name: "Issues P2 - OSHA + Thermal + Severity + Temperature + Ultrasonic (60 tests)"
    needs: [build-app]
    if: github.event.inputs.job_selection == 'all' || github.event.inputs.job_selection == 'issues-p2-osha-thermal-severity-temperature-ultrasonic'
    runs-on: macos-15
    timeout-minutes: 420

    steps:
      - name: Download Built App
        uses: actions/download-artifact@v4
        with:
          name: built-app
          path: apps/

      - name: Download QA Automation Code
        uses: actions/download-artifact@v4
        with:
          name: qa-code
          path: qa-automation/

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install Appium
        run: |
          npm install -g appium@latest 2>&1 | tail -1
          appium driver install xcuitest 2>&1 | tail -1
          echo "âœ… Appium $(appium --version)"

      - name: Boot Simulator
        run: |
          UDID=""
          for VERSION in 18.5 18.4 18.3 18.2 18.1 18.0; do
            for MODEL in "iPhone 16 Pro" "iPhone 15 Pro" "iPhone"; do
              UDID=$(xcrun simctl list devices available | grep -A 100 "iOS $VERSION" | grep "$MODEL" | head -1 | awk -F '[()]' '{print $2}')
              [ -n "$UDID" ] && break 2
            done
          done
          [ -z "$UDID" ] && echo "âŒ No simulator found!" && exit 1

          DEVICE_NAME=$(xcrun simctl list devices available | grep "$UDID" | sed 's/(.*//' | xargs)
          PLATFORM_VERSION=$(xcrun simctl list devices available | grep -B 20 "$UDID" | grep "iOS" | tail -1 | sed 's/-- iOS //' | sed 's/ --.*//')
          [ -z "$PLATFORM_VERSION" ] && PLATFORM_VERSION="18.5"

          echo "DEVICE_NAME=$DEVICE_NAME" >> $GITHUB_ENV
          echo "SIMULATOR_UDID=$UDID" >> $GITHUB_ENV
          echo "PLATFORM_VERSION=$PLATFORM_VERSION" >> $GITHUB_ENV
          echo "ðŸ“± $DEVICE_NAME | iOS $PLATFORM_VERSION | $UDID"

          xcrun simctl shutdown "$UDID" 2>/dev/null || true
          sleep 3; xcrun simctl boot "$UDID" 2>/dev/null || true

          TIMEOUT=120; ELAPSED=0
          while [ $ELAPSED -lt $TIMEOUT ]; do
            if xcrun simctl list devices | grep "$UDID" | grep -q "(Booted)"; then
              echo "âœ… Booted after ${ELAPSED}s"; break
            fi
            sleep 5; ELAPSED=$((ELAPSED + 5))
          done
          if [ $ELAPSED -ge $TIMEOUT ]; then echo "âŒ Boot timeout"; exit 1; fi
          sleep 45; echo "âœ… Simulator ready"

      - name: Install App on Simulator
        run: |
          APP_FILE=$(ls apps/ | grep ".app" | head -1)
          xcrun simctl install "${{ env.SIMULATOR_UDID }}" "apps/$APP_FILE"

      - name: Pre-build WebDriverAgent
        run: |
          WDA_PATH=$(find ~/.appium -name "WebDriverAgent.xcodeproj" -type f 2>/dev/null | head -1 | xargs dirname)
          if [ -n "$WDA_PATH" ]; then
            cd "$WDA_PATH"
            xcodebuild build-for-testing -project WebDriverAgent.xcodeproj -scheme WebDriverAgentRunner \
              -destination "platform=iOS Simulator,id=${{ env.SIMULATOR_UDID }}" \
              -derivedDataPath /tmp/wda-build -quiet 2>&1 | tail -3
            echo "âœ… WDA pre-built"
          fi

      - name: Start Appium Server
        run: |
          appium --relaxed-security --log-level error > appium.log 2>&1 &
          for i in {1..60}; do
            if curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:4723/status 2>/dev/null | grep -q "200"; then
              echo "âœ… Appium ready"; break
            fi
            sleep 2
          done
          sleep 10

      - name: Warm-up WDA Session
        run: |
          APP_FILE=$(ls apps/ | grep ".app" | head -1)
          FULL_APP_PATH="${{ github.workspace }}/apps/$APP_FILE"
          for attempt in 1 2 3; do
            SESSION_RESPONSE=$(curl -s -X POST http://127.0.0.1:4723/session \
              -H "Content-Type: application/json" \
              -d '{"capabilities":{"alwaysMatch":{"platformName":"iOS","appium:automationName":"XCUITest","appium:deviceName":"'"${{ env.DEVICE_NAME }}"'","appium:udid":"'"${{ env.SIMULATOR_UDID }}"'","appium:platformVersion":"'"${{ env.PLATFORM_VERSION }}"'","appium:app":"'"$FULL_APP_PATH"'","appium:wdaLaunchTimeout":600000,"appium:wdaConnectionTimeout":300000,"appium:useNewWDA":false,"appium:noReset":false}}}' \
              --max-time 600 2>&1) || true
            SESSION_ID=$(echo "$SESSION_RESPONSE" | grep -o '"sessionId":"[^"]*"' | cut -d'"' -f4 || true)
            if [ -n "$SESSION_ID" ]; then
              echo "âœ… WDA warm-up OK"; sleep 10
              curl -s -X DELETE "http://127.0.0.1:4723/session/$SESSION_ID" || true; sleep 5; break
            else
              [ $attempt -lt 3 ] && sleep 30
            fi
          done

      - name: Run Issues Phase 2 Tests
        continue-on-error: true
        run: |
          cd qa-automation
          APP_FILE=$(ls ../apps/ | grep ".app" | head -1)
          APP_PATH="${{ github.workspace }}/apps/$APP_FILE"

          # Extract bundle ID from built app so soft restart uses correct ID
          BUNDLE_ID=$(/usr/libexec/PlistBuddy -c 'Print :CFBundleIdentifier' "$APP_PATH/Info.plist" 2>/dev/null || echo "com.egalvanic.zplatform-QA")

          mvn test -B -q \
            -DsuiteXmlFile=src/test/resources/parallel/testng-issues-phase2.xml \
            -DDEVICE_NAME="${{ env.DEVICE_NAME }}" \
            -DPLATFORM_VERSION="${{ env.PLATFORM_VERSION }}" \
            -DSIMULATOR_UDID="${{ env.SIMULATOR_UDID }}" \
            -DAPP_PATH="$APP_PATH" \
            -DAPP_BUNDLE_ID="$BUNDLE_ID"

      - name: Upload Issues Phase 2 Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: issues-phase2-report
          path: |
            qa-automation/target/surefire-reports/
            qa-automation/reports/
            qa-automation/screenshots/
          retention-days: 7

      - name: Upload Appium Log (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: appium-log-issues-phase2-${{ github.run_number }}
          path: appium.log
          retention-days: 7

      - name: Shutdown Simulator
        if: always()
        run: xcrun simctl shutdown "${{ env.SIMULATOR_UDID }}" 2>/dev/null || true

  # ============================================================
  # JOB 11: Issues Phase 3 (58 tests â€” Ultrasonic Save, Swipe Delete, Sort, Status, CRUD)
  # ============================================================
  issues-phase3:
    name: "Issues P3 - Ultrasonic Save + Swipe Delete + Sort + Status + CRUD (58 tests)"
    needs: [build-app]
    if: github.event.inputs.job_selection == 'all' || github.event.inputs.job_selection == 'issues-p3-ultrasonic-save-swipe-delete-sort-status-crud'
    runs-on: macos-15
    timeout-minutes: 420

    steps:
      - name: Download Built App
        uses: actions/download-artifact@v4
        with:
          name: built-app
          path: apps/

      - name: Download QA Automation Code
        uses: actions/download-artifact@v4
        with:
          name: qa-code
          path: qa-automation/

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install Appium
        run: |
          npm install -g appium@latest 2>&1 | tail -1
          appium driver install xcuitest 2>&1 | tail -1
          echo "âœ… Appium $(appium --version)"

      - name: Boot Simulator
        run: |
          UDID=""
          for VERSION in 18.5 18.4 18.3 18.2 18.1 18.0; do
            for MODEL in "iPhone 16 Pro" "iPhone 15 Pro" "iPhone"; do
              UDID=$(xcrun simctl list devices available | grep -A 100 "iOS $VERSION" | grep "$MODEL" | head -1 | awk -F '[()]' '{print $2}')
              [ -n "$UDID" ] && break 2
            done
          done
          [ -z "$UDID" ] && echo "âŒ No simulator found!" && exit 1

          DEVICE_NAME=$(xcrun simctl list devices available | grep "$UDID" | sed 's/(.*//' | xargs)
          PLATFORM_VERSION=$(xcrun simctl list devices available | grep -B 20 "$UDID" | grep "iOS" | tail -1 | sed 's/-- iOS //' | sed 's/ --.*//')
          [ -z "$PLATFORM_VERSION" ] && PLATFORM_VERSION="18.5"

          echo "DEVICE_NAME=$DEVICE_NAME" >> $GITHUB_ENV
          echo "SIMULATOR_UDID=$UDID" >> $GITHUB_ENV
          echo "PLATFORM_VERSION=$PLATFORM_VERSION" >> $GITHUB_ENV
          echo "ðŸ“± $DEVICE_NAME | iOS $PLATFORM_VERSION | $UDID"

          xcrun simctl shutdown "$UDID" 2>/dev/null || true
          sleep 3; xcrun simctl boot "$UDID" 2>/dev/null || true

          TIMEOUT=120; ELAPSED=0
          while [ $ELAPSED -lt $TIMEOUT ]; do
            if xcrun simctl list devices | grep "$UDID" | grep -q "(Booted)"; then
              echo "âœ… Booted after ${ELAPSED}s"; break
            fi
            sleep 5; ELAPSED=$((ELAPSED + 5))
          done
          if [ $ELAPSED -ge $TIMEOUT ]; then echo "âŒ Boot timeout"; exit 1; fi
          sleep 45; echo "âœ… Simulator ready"

      - name: Install App on Simulator
        run: |
          APP_FILE=$(ls apps/ | grep ".app" | head -1)
          xcrun simctl install "${{ env.SIMULATOR_UDID }}" "apps/$APP_FILE"

      - name: Pre-build WebDriverAgent
        run: |
          WDA_PATH=$(find ~/.appium -name "WebDriverAgent.xcodeproj" -type f 2>/dev/null | head -1 | xargs dirname)
          if [ -n "$WDA_PATH" ]; then
            cd "$WDA_PATH"
            xcodebuild build-for-testing -project WebDriverAgent.xcodeproj -scheme WebDriverAgentRunner \
              -destination "platform=iOS Simulator,id=${{ env.SIMULATOR_UDID }}" \
              -derivedDataPath /tmp/wda-build -quiet 2>&1 | tail -3
            echo "âœ… WDA pre-built"
          fi

      - name: Start Appium Server
        run: |
          appium --relaxed-security --log-level error > appium.log 2>&1 &
          for i in {1..60}; do
            if curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:4723/status 2>/dev/null | grep -q "200"; then
              echo "âœ… Appium ready"; break
            fi
            sleep 2
          done
          sleep 10

      - name: Warm-up WDA Session
        run: |
          APP_FILE=$(ls apps/ | grep ".app" | head -1)
          FULL_APP_PATH="${{ github.workspace }}/apps/$APP_FILE"
          for attempt in 1 2 3; do
            SESSION_RESPONSE=$(curl -s -X POST http://127.0.0.1:4723/session \
              -H "Content-Type: application/json" \
              -d '{"capabilities":{"alwaysMatch":{"platformName":"iOS","appium:automationName":"XCUITest","appium:deviceName":"'"${{ env.DEVICE_NAME }}"'","appium:udid":"'"${{ env.SIMULATOR_UDID }}"'","appium:platformVersion":"'"${{ env.PLATFORM_VERSION }}"'","appium:app":"'"$FULL_APP_PATH"'","appium:wdaLaunchTimeout":600000,"appium:wdaConnectionTimeout":300000,"appium:useNewWDA":false,"appium:noReset":false}}}' \
              --max-time 600 2>&1) || true
            SESSION_ID=$(echo "$SESSION_RESPONSE" | grep -o '"sessionId":"[^"]*"' | cut -d'"' -f4 || true)
            if [ -n "$SESSION_ID" ]; then
              echo "âœ… WDA warm-up OK"; sleep 10
              curl -s -X DELETE "http://127.0.0.1:4723/session/$SESSION_ID" || true; sleep 5; break
            else
              [ $attempt -lt 3 ] && sleep 30
            fi
          done

      - name: Run Issues Phase 3 Tests
        continue-on-error: true
        run: |
          cd qa-automation
          APP_FILE=$(ls ../apps/ | grep ".app" | head -1)
          APP_PATH="${{ github.workspace }}/apps/$APP_FILE"

          # Extract bundle ID from built app so soft restart uses correct ID
          BUNDLE_ID=$(/usr/libexec/PlistBuddy -c 'Print :CFBundleIdentifier' "$APP_PATH/Info.plist" 2>/dev/null || echo "com.egalvanic.zplatform-QA")

          mvn test -B -q \
            -DsuiteXmlFile=src/test/resources/parallel/testng-issues-phase3.xml \
            -DDEVICE_NAME="${{ env.DEVICE_NAME }}" \
            -DPLATFORM_VERSION="${{ env.PLATFORM_VERSION }}" \
            -DSIMULATOR_UDID="${{ env.SIMULATOR_UDID }}" \
            -DAPP_PATH="$APP_PATH" \
            -DAPP_BUNDLE_ID="$BUNDLE_ID"

      - name: Upload Issues Phase 3 Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: issues-phase3-report
          path: |
            qa-automation/target/surefire-reports/
            qa-automation/reports/
            qa-automation/screenshots/
          retention-days: 7

      - name: Upload Appium Log (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: appium-log-issues-phase3-${{ github.run_number }}
          path: appium.log
          retention-days: 7

      - name: Shutdown Simulator
        if: always()
        run: xcrun simctl shutdown "${{ env.SIMULATOR_UDID }}" 2>/dev/null || true

  # ============================================================
  # JOB 13: Location Tests (82 tests, ~1.5 hr)
  # ============================================================
  location-tests:
    name: "Location (82 tests)"
    needs: [build-app]
    if: github.event.inputs.job_selection == 'all' || github.event.inputs.job_selection == 'location-only'
    runs-on: macos-15
    timeout-minutes: 420

    steps:
      - name: Download Built App
        uses: actions/download-artifact@v4
        with:
          name: built-app
          path: apps/

      - name: Download QA Automation Code
        uses: actions/download-artifact@v4
        with:
          name: qa-code
          path: qa-automation/

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install Appium
        run: |
          npm install -g appium@latest 2>&1 | tail -1
          appium driver install xcuitest 2>&1 | tail -1
          echo "âœ… Appium $(appium --version)"

      - name: Boot Simulator
        run: |
          UDID=""
          for VERSION in 18.5 18.4 18.3 18.2 18.1 18.0; do
            for MODEL in "iPhone 16 Pro" "iPhone 15 Pro" "iPhone"; do
              UDID=$(xcrun simctl list devices available | grep -A 100 "iOS $VERSION" | grep "$MODEL" | head -1 | awk -F '[()]' '{print $2}')
              [ -n "$UDID" ] && break 2
            done
          done
          [ -z "$UDID" ] && echo "âŒ No simulator found!" && exit 1

          DEVICE_NAME=$(xcrun simctl list devices available | grep "$UDID" | sed 's/(.*//' | xargs)
          PLATFORM_VERSION=$(xcrun simctl list devices available | grep -B 20 "$UDID" | grep "iOS" | tail -1 | sed 's/-- iOS //' | sed 's/ --.*//')
          [ -z "$PLATFORM_VERSION" ] && PLATFORM_VERSION="18.5"

          echo "DEVICE_NAME=$DEVICE_NAME" >> $GITHUB_ENV
          echo "SIMULATOR_UDID=$UDID" >> $GITHUB_ENV
          echo "PLATFORM_VERSION=$PLATFORM_VERSION" >> $GITHUB_ENV

          xcrun simctl shutdown "$UDID" 2>/dev/null || true
          sleep 3; xcrun simctl boot "$UDID" 2>/dev/null || true

          TIMEOUT=120; ELAPSED=0
          while [ $ELAPSED -lt $TIMEOUT ]; do
            if xcrun simctl list devices | grep "$UDID" | grep -q "(Booted)"; then
              echo "âœ… Booted after ${ELAPSED}s"; break
            fi
            sleep 5; ELAPSED=$((ELAPSED + 5))
          done
          if [ $ELAPSED -ge $TIMEOUT ]; then echo "âŒ Boot timeout"; exit 1; fi
          sleep 45; echo "âœ… Simulator ready"

      - name: Install App on Simulator
        run: |
          APP_FILE=$(ls apps/ | grep ".app" | head -1)
          xcrun simctl install "${{ env.SIMULATOR_UDID }}" "apps/$APP_FILE"

      - name: Pre-build WebDriverAgent
        run: |
          WDA_PATH=$(find ~/.appium -name "WebDriverAgent.xcodeproj" -type f 2>/dev/null | head -1 | xargs dirname)
          if [ -n "$WDA_PATH" ]; then
            cd "$WDA_PATH"
            xcodebuild build-for-testing -project WebDriverAgent.xcodeproj -scheme WebDriverAgentRunner \
              -destination "platform=iOS Simulator,id=${{ env.SIMULATOR_UDID }}" \
              -derivedDataPath /tmp/wda-build -quiet 2>&1 | tail -3
            echo "âœ… WDA pre-built"
          fi

      - name: Start Appium Server
        run: |
          appium --relaxed-security --log-level error > appium.log 2>&1 &
          for i in {1..60}; do
            if curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:4723/status 2>/dev/null | grep -q "200"; then
              echo "âœ… Appium ready"; break
            fi
            sleep 2
          done
          sleep 10

      - name: Warm-up WDA Session
        run: |
          APP_FILE=$(ls apps/ | grep ".app" | head -1)
          FULL_APP_PATH="${{ github.workspace }}/apps/$APP_FILE"
          for attempt in 1 2 3; do
            SESSION_RESPONSE=$(curl -s -X POST http://127.0.0.1:4723/session \
              -H "Content-Type: application/json" \
              -d '{"capabilities":{"alwaysMatch":{"platformName":"iOS","appium:automationName":"XCUITest","appium:deviceName":"'"${{ env.DEVICE_NAME }}"'","appium:udid":"'"${{ env.SIMULATOR_UDID }}"'","appium:platformVersion":"'"${{ env.PLATFORM_VERSION }}"'","appium:app":"'"$FULL_APP_PATH"'","appium:wdaLaunchTimeout":600000,"appium:wdaConnectionTimeout":300000,"appium:useNewWDA":false,"appium:noReset":false}}}' \
              --max-time 600 2>&1) || true
            SESSION_ID=$(echo "$SESSION_RESPONSE" | grep -o '"sessionId":"[^"]*"' | cut -d'"' -f4 || true)
            if [ -n "$SESSION_ID" ]; then
              echo "âœ… WDA warm-up OK"; sleep 10
              curl -s -X DELETE "http://127.0.0.1:4723/session/$SESSION_ID" || true; sleep 5; break
            else
              [ $attempt -lt 3 ] && sleep 30
            fi
          done

      - name: Run Location Tests
        continue-on-error: true
        run: |
          cd qa-automation
          APP_FILE=$(ls ../apps/ | grep ".app" | head -1)
          APP_PATH="${{ github.workspace }}/apps/$APP_FILE"

          # Extract bundle ID from built app so soft restart uses correct ID
          BUNDLE_ID=$(/usr/libexec/PlistBuddy -c 'Print :CFBundleIdentifier' "$APP_PATH/Info.plist" 2>/dev/null || echo "com.egalvanic.zplatform-QA")

          mvn test -B -q \
            -DsuiteXmlFile=src/test/resources/parallel/testng-location.xml \
            -DDEVICE_NAME="${{ env.DEVICE_NAME }}" \
            -DPLATFORM_VERSION="${{ env.PLATFORM_VERSION }}" \
            -DSIMULATOR_UDID="${{ env.SIMULATOR_UDID }}" \
            -DAPP_PATH="$APP_PATH" \
            -DAPP_BUNDLE_ID="$BUNDLE_ID"

      - name: Upload Location Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: location-report
          path: |
            qa-automation/target/surefire-reports/
            qa-automation/reports/
            qa-automation/screenshots/
          retention-days: 7

      - name: Upload Appium Log (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: appium-log-location-${{ github.run_number }}
          path: appium.log
          retention-days: 7

      - name: Shutdown Simulator
        if: always()
        run: xcrun simctl shutdown "${{ env.SIMULATOR_UDID }}" 2>/dev/null || true

  # ============================================================
  # JOB 14: Connections Tests (94 tests, ~2 hr)
  # ============================================================
  connections-tests:
    name: "Connections (94 tests)"
    needs: [build-app]
    if: github.event.inputs.job_selection == 'all' || github.event.inputs.job_selection == 'connections-only'
    runs-on: macos-15
    timeout-minutes: 420

    steps:
      - name: Download Built App
        uses: actions/download-artifact@v4
        with:
          name: built-app
          path: apps/

      - name: Download QA Automation Code
        uses: actions/download-artifact@v4
        with:
          name: qa-code
          path: qa-automation/

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install Appium
        run: |
          npm install -g appium@latest 2>&1 | tail -1
          appium driver install xcuitest 2>&1 | tail -1
          echo "âœ… Appium $(appium --version)"

      - name: Boot Simulator
        run: |
          UDID=""
          for VERSION in 18.5 18.4 18.3 18.2 18.1 18.0; do
            for MODEL in "iPhone 16 Pro" "iPhone 15 Pro" "iPhone"; do
              UDID=$(xcrun simctl list devices available | grep -A 100 "iOS $VERSION" | grep "$MODEL" | head -1 | awk -F '[()]' '{print $2}')
              [ -n "$UDID" ] && break 2
            done
          done
          [ -z "$UDID" ] && echo "âŒ No simulator found!" && exit 1

          DEVICE_NAME=$(xcrun simctl list devices available | grep "$UDID" | sed 's/(.*//' | xargs)
          PLATFORM_VERSION=$(xcrun simctl list devices available | grep -B 20 "$UDID" | grep "iOS" | tail -1 | sed 's/-- iOS //' | sed 's/ --.*//')
          [ -z "$PLATFORM_VERSION" ] && PLATFORM_VERSION="18.5"

          echo "DEVICE_NAME=$DEVICE_NAME" >> $GITHUB_ENV
          echo "SIMULATOR_UDID=$UDID" >> $GITHUB_ENV
          echo "PLATFORM_VERSION=$PLATFORM_VERSION" >> $GITHUB_ENV

          xcrun simctl shutdown "$UDID" 2>/dev/null || true
          sleep 3; xcrun simctl boot "$UDID" 2>/dev/null || true

          TIMEOUT=120; ELAPSED=0
          while [ $ELAPSED -lt $TIMEOUT ]; do
            if xcrun simctl list devices | grep "$UDID" | grep -q "(Booted)"; then
              echo "âœ… Booted after ${ELAPSED}s"; break
            fi
            sleep 5; ELAPSED=$((ELAPSED + 5))
          done
          if [ $ELAPSED -ge $TIMEOUT ]; then echo "âŒ Boot timeout"; exit 1; fi
          sleep 45; echo "âœ… Simulator ready"

      - name: Install App on Simulator
        run: |
          APP_FILE=$(ls apps/ | grep ".app" | head -1)
          xcrun simctl install "${{ env.SIMULATOR_UDID }}" "apps/$APP_FILE"

      - name: Pre-build WebDriverAgent
        run: |
          WDA_PATH=$(find ~/.appium -name "WebDriverAgent.xcodeproj" -type f 2>/dev/null | head -1 | xargs dirname)
          if [ -n "$WDA_PATH" ]; then
            cd "$WDA_PATH"
            xcodebuild build-for-testing -project WebDriverAgent.xcodeproj -scheme WebDriverAgentRunner \
              -destination "platform=iOS Simulator,id=${{ env.SIMULATOR_UDID }}" \
              -derivedDataPath /tmp/wda-build -quiet 2>&1 | tail -3
            echo "âœ… WDA pre-built"
          fi

      - name: Start Appium Server
        run: |
          appium --relaxed-security --log-level error > appium.log 2>&1 &
          for i in {1..60}; do
            if curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:4723/status 2>/dev/null | grep -q "200"; then
              echo "âœ… Appium ready"; break
            fi
            sleep 2
          done
          sleep 10

      - name: Warm-up WDA Session
        run: |
          APP_FILE=$(ls apps/ | grep ".app" | head -1)
          FULL_APP_PATH="${{ github.workspace }}/apps/$APP_FILE"
          for attempt in 1 2 3; do
            SESSION_RESPONSE=$(curl -s -X POST http://127.0.0.1:4723/session \
              -H "Content-Type: application/json" \
              -d '{"capabilities":{"alwaysMatch":{"platformName":"iOS","appium:automationName":"XCUITest","appium:deviceName":"'"${{ env.DEVICE_NAME }}"'","appium:udid":"'"${{ env.SIMULATOR_UDID }}"'","appium:platformVersion":"'"${{ env.PLATFORM_VERSION }}"'","appium:app":"'"$FULL_APP_PATH"'","appium:wdaLaunchTimeout":600000,"appium:wdaConnectionTimeout":300000,"appium:useNewWDA":false,"appium:noReset":false}}}' \
              --max-time 600 2>&1) || true
            SESSION_ID=$(echo "$SESSION_RESPONSE" | grep -o '"sessionId":"[^"]*"' | cut -d'"' -f4 || true)
            if [ -n "$SESSION_ID" ]; then
              echo "âœ… WDA warm-up OK"; sleep 10
              curl -s -X DELETE "http://127.0.0.1:4723/session/$SESSION_ID" || true; sleep 5; break
            else
              [ $attempt -lt 3 ] && sleep 30
            fi
          done

      - name: Run Connections Tests
        continue-on-error: true
        run: |
          cd qa-automation
          APP_FILE=$(ls ../apps/ | grep ".app" | head -1)
          APP_PATH="${{ github.workspace }}/apps/$APP_FILE"

          # Extract bundle ID from built app so soft restart uses correct ID
          BUNDLE_ID=$(/usr/libexec/PlistBuddy -c 'Print :CFBundleIdentifier' "$APP_PATH/Info.plist" 2>/dev/null || echo "com.egalvanic.zplatform-QA")

          mvn test -B -q \
            -DsuiteXmlFile=src/test/resources/parallel/testng-connections.xml \
            -DDEVICE_NAME="${{ env.DEVICE_NAME }}" \
            -DPLATFORM_VERSION="${{ env.PLATFORM_VERSION }}" \
            -DSIMULATOR_UDID="${{ env.SIMULATOR_UDID }}" \
            -DAPP_PATH="$APP_PATH" \
            -DAPP_BUNDLE_ID="$BUNDLE_ID"

      - name: Upload Connections Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: connections-report
          path: |
            qa-automation/target/surefire-reports/
            qa-automation/reports/
            qa-automation/screenshots/
          retention-days: 7

      - name: Upload Appium Log (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: appium-log-connections-${{ github.run_number }}
          path: appium.log
          retention-days: 7

      - name: Shutdown Simulator
        if: always()
        run: xcrun simctl shutdown "${{ env.SIMULATOR_UDID }}" 2>/dev/null || true

  # ============================================================
  # JOB 15: Summary & Email
  # ============================================================
  summary:
    name: "Summary & Email"
    needs: [smoke-tests, auth-tests, site-tests, assets-part1, assets-part2, assets-part3, assets-part4, assets-part5, assets-part6, issues-phase1, issues-phase2, issues-phase3, location-tests, connections-tests]
    if: always()
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Download All Reports
        uses: actions/download-artifact@v4
        with:
          path: all-reports
        continue-on-error: true

      - name: Prepare Summary
        id: summary
        run: |
          SELECTION="${{ github.event.inputs.job_selection }}"
          SMOKE="${{ needs.smoke-tests.result }}"
          AUTH="${{ needs.auth-tests.result }}"
          SITE="${{ needs.site-tests.result }}"
          AP1="${{ needs.assets-part1.result }}"
          AP2="${{ needs.assets-part2.result }}"
          AP3="${{ needs.assets-part3.result }}"
          AP4="${{ needs.assets-part4.result }}"
          AP5="${{ needs.assets-part5.result }}"
          AP6="${{ needs.assets-part6.result }}"
          ISS1="${{ needs.issues-phase1.result }}"
          ISS2="${{ needs.issues-phase2.result }}"
          ISS3="${{ needs.issues-phase3.result }}"
          LOC="${{ needs.location-tests.result }}"
          CONN="${{ needs.connections-tests.result }}"

          if [ "$SELECTION" = "smoke" ]; then
            # â”€â”€ Smoke mode: only smoke-tests job ran â”€â”€
            if [ "$SMOKE" = "success" ]; then
              STATUS="âœ… SMOKE PASSED"
              SUCCESS=1; FAILED=0; TOTAL=1
            else
              STATUS="âŒ SMOKE FAILED"
              SUCCESS=0; FAILED=1; TOTAL=1
            fi
            echo "SUCCESS=$SUCCESS" >> $GITHUB_OUTPUT
            echo "FAILED=$FAILED" >> $GITHUB_OUTPUT
            echo "TOTAL=$TOTAL" >> $GITHUB_OUTPUT
            echo "STATUS=$STATUS" >> $GITHUB_OUTPUT

            cat > email_body.html << EOF
            <!DOCTYPE html>
            <html>
            <body style="font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto;">
              <h1 style="color: #333;">ðŸ§ª iOS Smoke Test Results (Developer Repo)</h1>
              <p><b>Branch:</b> ${{ github.event.inputs.branch }}</p>
              <p><b>Mode:</b> Smoke CRUD (17 tests)</p>
              <p><b>Triggered by:</b> ${{ github.actor }}</p>
              <p><b>Run:</b> <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">View Full Details</a></p>
              <hr>
              <h2>${STATUS}</h2>
              <table border="1" cellpadding="10" style="border-collapse: collapse; width: 100%;">
                <tr style="background-color: #4a90d9; color: white;">
                  <th>Module</th><th>Tests</th><th>Status</th>
                </tr>
                <tr><td>Login</td><td>1</td><td rowspan="6">${SMOKE}</td></tr>
                <tr><td>Site Selection</td><td>1</td></tr>
                <tr><td>Asset CRUD</td><td>4</td></tr>
                <tr><td>Location CRUD</td><td>4</td></tr>
                <tr><td>Connection CRUD</td><td>3</td></tr>
                <tr><td>Issue CRUD</td><td>4</td></tr>
              </table>
              <hr>
              <p><b>Total Smoke Tests:</b> 17</p>
            </body>
            </html>
          EOF
          else
            # â”€â”€ Full parallel mode: 13 test jobs â”€â”€
            SUCCESS=0
            [ "$AUTH" = "success" ] && SUCCESS=$((SUCCESS+1))
            [ "$SITE" = "success" ] && SUCCESS=$((SUCCESS+1))
            [ "$AP1" = "success" ] && SUCCESS=$((SUCCESS+1))
            [ "$AP2" = "success" ] && SUCCESS=$((SUCCESS+1))
            [ "$AP3" = "success" ] && SUCCESS=$((SUCCESS+1))
            [ "$AP4" = "success" ] && SUCCESS=$((SUCCESS+1))
            [ "$AP5" = "success" ] && SUCCESS=$((SUCCESS+1))
            [ "$AP6" = "success" ] && SUCCESS=$((SUCCESS+1))
            [ "$ISS1" = "success" ] && SUCCESS=$((SUCCESS+1))
            [ "$ISS2" = "success" ] && SUCCESS=$((SUCCESS+1))
            [ "$ISS3" = "success" ] && SUCCESS=$((SUCCESS+1))
            [ "$LOC" = "success" ] && SUCCESS=$((SUCCESS+1))
            [ "$CONN" = "success" ] && SUCCESS=$((SUCCESS+1))

            FAILED=$((13-SUCCESS))
            TOTAL=13
            echo "SUCCESS=$SUCCESS" >> $GITHUB_OUTPUT
            echo "FAILED=$FAILED" >> $GITHUB_OUTPUT
            echo "TOTAL=$TOTAL" >> $GITHUB_OUTPUT

            if [ $SUCCESS -eq 13 ]; then
              STATUS="âœ… ALL PASSED"
            elif [ $SUCCESS -ge 11 ]; then
              STATUS="âš ï¸ MOSTLY PASSED"
            else
              STATUS="âŒ FAILED"
            fi
            echo "STATUS=$STATUS" >> $GITHUB_OUTPUT

            cat > email_body.html << EOF
            <!DOCTYPE html>
            <html>
            <body style="font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto;">
              <h1 style="color: #333;">ðŸ§ª iOS Full Parallel Suite Results (Developer Repo)</h1>
              <p><b>Branch:</b> ${{ github.event.inputs.branch }}</p>
              <p><b>Jobs Selected:</b> ${{ github.event.inputs.job_selection }}</p>
              <p><b>Triggered by:</b> ${{ github.actor }}</p>
              <p><b>Run:</b> <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">View Full Details</a></p>
              <hr>

              <h2>Results: ${SUCCESS}/13 Jobs Passed â€” ${STATUS}</h2>

              <table border="1" cellpadding="10" style="border-collapse: collapse; width: 100%;">
                <tr style="background-color: #4a90d9; color: white;">
                  <th>Job</th><th>Tests</th><th>Coverage</th><th>Status</th>
                </tr>
                <tr><td>Auth Tests</td><td>38</td><td>Authentication & Login</td><td>${AUTH}</td></tr>
                <tr><td>Site Tests</td><td>52</td><td>Site Selection</td><td>${SITE}</td></tr>
                <tr><td>Asset Part 1</td><td>112</td><td>P1: Creation + Edit + Busway + Capacitor + P5: Bug Tests</td><td>${AP1}</td></tr>
                <tr><td>Asset Part 2</td><td>108</td><td>P1: CB + DS + Fuse + P2: Generator + Junction Box</td><td>${AP2}</td></tr>
                <tr><td>Asset Part 3</td><td>109</td><td>P2: Load Center + MCC + MCC Bucket + Motor + Other</td><td>${AP3}</td></tr>
                <tr><td>Asset Part 4</td><td>97</td><td>P2: OCP + P3: Panelboard + PDU + Relay + SWB + Transformer</td><td>${AP4}</td></tr>
                <tr><td>Asset Part 5</td><td>112</td><td>P3: UPS + Utility + VFD + Subtypes + P4: DS/Fuse Subtypes</td><td>${AP5}</td></tr>
                <tr><td>Asset Part 6</td><td>114</td><td>P4: Subtypes + Tasks + Issues + Connections + Asset Screen</td><td>${AP6}</td></tr>
                <tr><td>Issues Phase 1</td><td>119</td><td>List + Filter + Search + Creation + Class Change</td><td>${ISS1}</td></tr>
                <tr><td>Issues Phase 2</td><td>60</td><td>OSHA + Thermal + Severity + Temperature + Ultrasonic</td><td>${ISS2}</td></tr>
                <tr><td>Issues Phase 3</td><td>58</td><td>Ultrasonic Save + Swipe Delete + Sort + Status + CRUD</td><td>${ISS3}</td></tr>
                <tr><td>Location</td><td>82</td><td>Location Hierarchy</td><td>${LOC}</td></tr>
                <tr><td>Connections</td><td>94</td><td>Asset Connections</td><td>${CONN}</td></tr>
              </table>

              <hr>
              <p><b>Total Tests:</b> ~1155 (652 asset + 119 issues-p1 + 60 issues-p2 + 58 issues-p3 + 38 auth + 52 site + 82 location + 94 connections)</p>
              <p><b>Jobs Passed:</b> ${SUCCESS} | <b>Failed:</b> ${FAILED}</p>
              <p style="margin-top: 20px; color: #666; font-size: 12px;">
                Automated report from eGalvanic iOS Automation Suite (Developer Repo).
                Asset tests (652) split into 6 balanced parts. Issues tests (237) split into 3 phases.
              </p>
            </body>
            </html>
          EOF
          fi

      - name: Send Email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "[${{ steps.summary.outputs.STATUS }}] iOS Suite (${{ github.event.inputs.branch }}) - ${{ steps.summary.outputs.SUCCESS }}/${{ steps.summary.outputs.TOTAL }} Passed"
          html_body: file://email_body.html
          to: ${{ secrets.EMAIL_TO }}
          from: "iOS Automation <${{ secrets.EMAIL_USERNAME }}>"
        continue-on-error: true

      - name: Print Summary
        run: |
          SELECTION="${{ github.event.inputs.job_selection }}"
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘            DEVELOPER REPO - TEST SUITE COMPLETE                              â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "  ðŸŒ¿ Branch:      ${{ github.event.inputs.branch }}"
          echo "  ðŸŽ¯ Selection:   ${SELECTION}"
          echo "  ðŸ“Š Results:     ${{ steps.summary.outputs.SUCCESS }}/${{ steps.summary.outputs.TOTAL }} Passed"
          echo ""

          if [ "$SELECTION" = "smoke" ]; then
            echo "  â”€â”€â”€ Smoke CRUD (17 tests) â”€â”€â”€"
            echo "  Smoke Tests:            ${{ needs.smoke-tests.result }}"
          else
            echo "  â”€â”€â”€ Non-Asset Jobs â”€â”€â”€"
            echo "  Auth (38):              ${{ needs.auth-tests.result }}"
            echo "  Site (52):              ${{ needs.site-tests.result }}"
            echo ""
            echo "  â”€â”€â”€ Asset Parts (652 tests, 6 balanced parts) â”€â”€â”€"
            echo "  Part 1 (112): P1 Creation+Edit+Busway+Cap + P5 Bugs     ${{ needs.assets-part1.result }}"
            echo "  Part 2 (108): P1 CB+DS+Fuse + P2 Gen+JB                 ${{ needs.assets-part2.result }}"
            echo "  Part 3 (109): P2 LC+MCC+MCCB+Motor+Other                ${{ needs.assets-part3.result }}"
            echo "  Part 4 (97):  P2 OCP + P3 PB+PDU+Relay+SWB+TRF         ${{ needs.assets-part4.result }}"
            echo "  Part 5 (112): P3 UPS+UTL+VFD+Subtypes + P4 DS/Fuse ST  ${{ needs.assets-part5.result }}"
            echo "  Part 6 (114): P4 Subtypes+Tasks+Issues+Conn+Screen      ${{ needs.assets-part6.result }}"
            echo ""
            echo "  â”€â”€â”€ Issues (237 tests, 3 phases) â”€â”€â”€"
            echo "  Phase 1 (119): List+Filter+Search+Creation+ClassChange   ${{ needs.issues-phase1.result }}"
            echo "  Phase 2 (60):  OSHA+Thermal+Severity+Temp+Ultrasonic    ${{ needs.issues-phase2.result }}"
            echo "  Phase 3 (58):  UltraSave+SwipeDel+Sort+Status+CRUD      ${{ needs.issues-phase3.result }}"
            echo ""
            echo "  â”€â”€â”€ Other Jobs â”€â”€â”€"
            echo "  Location (82):          ${{ needs.location-tests.result }}"
            echo "  Connections (94):       ${{ needs.connections-tests.result }}"
          fi

          echo ""
          echo "  ðŸ“§ Email: sent to configured recipients"
          echo "  ðŸ”— Details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
